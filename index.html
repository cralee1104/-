<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¶­ä¿®è¨˜éŒ„ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase é…ç½® (ä½ éœ€è¦æ›¿æ›æˆè‡ªå·±çš„é…ç½®)
        const firebaseConfig = {
            // é€™è£¡éœ€è¦ä½ çš„ Firebase é…ç½®
            // è«‹åˆ° Firebase Console å»ºç«‹å°ˆæ¡ˆä¸¦å–å¾—é…ç½®
            apiKey: "AIzaSyCbaX3ou68Xu4wOQe01X_czS_QvtUtmVaE",
            authDomain: "shfix-ae293.firebaseapp.com",
            projectId: "shfix-ae293",
            storageBucket: "shfix-ae293.firebasestorage.app",
            messagingSenderId: "786004133871",
            appId: "1:786004133871:web:fc777aabac9d9e8fe0d81a"
        };

        // åˆå§‹åŒ– Firebase
        try {
            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.firestore = { collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, onSnapshot };
            console.log('Firebase åˆå§‹åŒ–æˆåŠŸ');
        } catch (error) {
            console.error('Firebase åˆå§‹åŒ–å¤±æ•—:', error);
            window.firebaseApp = null;
            window.db = null;
        }
    </script>
    <style>
        .icon { width: 16px; height: 16px; }
        .icon-lg { width: 20px; height: 20px; }
        .icon-xl { width: 32px; height: 32px; }
        
        /* ç§»é™¤æŒ‰éˆ•é»æ“Šå¾Œçš„è—è‰²é‚Šæ¡† */
        button:focus:not(:focus-visible) {
            outline: none;
        }
        
        /* ä¿ç•™éµç›¤å°èˆªæ™‚çš„ç„¦é»æ¨£å¼ */
        button:focus-visible {
            outline: 2px solid #3B82F6;
            outline-offset: 2px;
        }
        
        /* å‹•ç•«æ•ˆæœ */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification {
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- é›²ç«¯ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
    <div id="cloudStatus" class="fixed top-4 right-4 z-50 px-3 py-2 rounded-lg text-sm font-medium shadow-lg bg-gray-100 text-gray-800">
        <div class="flex items-center gap-2">
            <div id="cloudIcon"><i data-lucide="cloud-off" class="icon"></i></div>
            <span id="cloudText">é€£æ¥ä¸­...</span>
        </div>
    </div>

    <!-- æœ€å¾Œæ›´æ–°æ™‚é–“ -->
    <div id="lastUpdateTime" class="fixed top-4 left-4 z-40 px-3 py-2 rounded-lg text-xs bg-gray-50 text-gray-600 shadow-md hidden">
        <div class="flex items-center gap-2">
            <i data-lucide="clock" class="icon"></i>
            <span id="updateTimeText">æœ€å¾Œæ›´æ–°: --</span>
        </div>
    </div>

    <div class="min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            <!-- æ¨™é¡Œå€åŸŸ -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">ç¶­ä¿®è¨˜éŒ„ç®¡ç†ç³»çµ±</h1>
                <p class="text-gray-600">è¨­å‚™ç¶­ä¿®è¨˜éŒ„è¿½è¹¤èˆ‡ç®¡ç† - é›²ç«¯åŒæ­¥ç‰ˆæœ¬</p>
            </div>

            <!-- è¦–åœ–åˆ‡æ›æŒ‰éˆ• -->
            <div class="bg-white rounded-lg shadow-sm border p-4 mb-6">
                <div class="flex justify-center">
                    <div class="flex gap-3">
                        <button id="currentViewBtn" class="flex items-center gap-2 px-6 py-3 rounded-lg transition-colors border view-btn bg-blue-600 text-white border-blue-600" data-view="current">
                            <i data-lucide="home" class="icon-lg"></i>
                            æœ¬æœˆè¨˜éŒ„
                        </button>
                        <button id="historyViewBtn" class="flex items-center gap-2 px-6 py-3 rounded-lg transition-colors border view-btn bg-white text-gray-700 border-gray-300 hover:bg-gray-50" data-view="history">
                            <i data-lucide="archive" class="icon-lg"></i>
                            æ­·å²è¨˜éŒ„
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ­·å²è¨˜éŒ„å¹´æœˆé¸æ“‡å™¨ -->
            <div id="historySelector" class="bg-white rounded-lg shadow-sm border p-4 mb-6 hidden">
                <h3 class="text-lg font-medium text-gray-900 mb-4">é¸æ“‡æŸ¥çœ‹æœŸé–“</h3>
                <div id="historyYearList" class="space-y-2"></div>
            </div>

            <!-- æ“ä½œå·¥å…·åˆ— -->
            <div class="bg-white rounded-lg shadow-sm border p-4 mb-6">
                <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
                    <!-- æœå°‹å€åŸŸ -->
                    <div class="flex-1 max-w-md">
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 icon"></i>
                            <input id="searchInput" type="text" placeholder="æœå°‹ç™»è¨˜è³‡æ–™ã€æ©Ÿå‹ã€åºè™Ÿæˆ–ç¶­ä¿®é …ç›®..." 
                                   class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>

                    <!-- æ§åˆ¶æŒ‰éˆ• -->
                    <div class="flex gap-3">
                        <select id="statusFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="all">æ‰€æœ‰ç‹€æ…‹</option>
                            <option value="pending">æœªä¿®</option>
                            <option value="completed">å·²å®Œæˆ</option>
                        </select>

                        <select id="technicianFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="all">æ‰€æœ‰æŠ€è¡“å“¡</option>
                            <option value="æ›¾">æ›¾</option>
                            <option value="æ">æ</option>
                        </select>

                        <button id="addRecordBtn" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i data-lucide="plus" class="icon"></i>
                            æ–°å¢è¨˜éŒ„
                        </button>

                        <div class="relative">
                            <button id="exportBtn" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors hidden">
                                <i data-lucide="download" class="icon"></i>
                                åŒ¯å‡ºå ±è¡¨
                            </button>
                            <div id="exportMenu" class="absolute right-0 top-full mt-2 w-48 bg-white rounded-lg shadow-lg border z-50 hidden">
                                <div class="p-2">
                                    <button id="exportCSV" class="w-full flex items-center gap-2 px-3 py-2 text-left hover:bg-gray-50 rounded text-sm">
                                        <i data-lucide="file-text" class="icon text-blue-500"></i>
                                        åŒ¯å‡º CSV æª”æ¡ˆ
                                    </button>
                                    <button id="exportStats" class="w-full flex items-center gap-2 px-3 py-2 text-left hover:bg-gray-50 rounded text-sm">
                                        <i data-lucide="bar-chart-3" class="icon text-green-500"></i>
                                        åŒ¯å‡ºçµ±è¨ˆå ±è¡¨
                                    </button>
                                </div>
                            </div>
                        </div>

                        <button id="bulkActionsBtn" class="flex items-center gap-2 px-4 py-2 rounded-lg transition-colors border bg-white text-gray-700 border-gray-300 hover:bg-gray-50 hidden">
                            <i data-lucide="settings" class="icon"></i>
                            æ‰¹é‡æ“ä½œ
                        </button>

                        <button id="syncBtn" class="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors" title="æ‰‹å‹•åŒæ­¥è³‡æ–™">
                            <i data-lucide="refresh-cw" class="icon"></i>
                            <span class="hidden sm:inline">åŒæ­¥è³‡æ–™</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ‰¹é‡æ“ä½œå·¥å…·åˆ— -->
            <div id="bulkActionsPanel" class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6 hidden">
                <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input id="selectAllCheckbox" type="checkbox" class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                            <span id="selectAllText" class="text-sm font-medium text-gray-700">å…¨é¸ (0/0)</span>
                        </label>
                        <span id="selectedCount" class="text-sm text-orange-600 hidden">å·²é¸æ“‡ 0 ç­†è¨˜éŒ„</span>
                    </div>
                    
                    <div id="bulkButtons" class="flex gap-2 hidden">
                        <button id="bulkCompleteBtn" class="flex items-center gap-2 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                            <i data-lucide="check-circle" class="icon"></i>
                            æ¨™è¨˜å·²å®Œæˆ
                        </button>
                        <button id="bulkPendingBtn" class="flex items-center gap-2 px-3 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors text-sm">
                            <i data-lucide="x" class="icon"></i>
                            æ¨™è¨˜æœªä¿®
                        </button>
                        <button id="bulkDeleteBtn" class="flex items-center gap-2 px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">
                            <i data-lucide="trash-2" class="icon"></i>
                            æ‰¹é‡åˆªé™¤
                        </button>
                    </div>
                </div>
            </div>

            <!-- çµ±è¨ˆå¡ç‰‡ -->
            <div id="statsCards" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow-sm border p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">æœªä¿®</p>
                            <p id="pendingCount" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                        <i data-lucide="x" class="icon-xl text-gray-400"></i>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm border p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">å·²å®Œæˆ</p>
                            <p id="completedCount" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                        <i data-lucide="check-circle" class="icon-xl text-gray-400"></i>
                    </div>
                </div>
            </div>

            <!-- è¨˜éŒ„è¡¨æ ¼ -->
            <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b">
                            <tr id="tableHeader">
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ—¥æœŸ</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç™»è¨˜è³‡æ–™</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å“ç‰Œæ©Ÿå‹</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åºè™Ÿ</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æŠ€è¡“å“¡</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTable" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                    <div id="noRecords" class="text-center py-12 hidden">
                        <p class="text-gray-500">æ²’æœ‰ç¶­ä¿®è¨˜éŒ„</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢è¨˜éŒ„è¡¨å–® -->
    <div id="addRecordModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">æ–°å¢ç¶­ä¿®è¨˜éŒ„</h3>
                <form id="addRecordForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ—¥æœŸ</label>
                            <input id="recordDate" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç™»è¨˜è³‡æ–™</label>
                            <input id="recordRegistration" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å“ç‰Œæ©Ÿå‹</label>
                            <input id="recordModel" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">åºè™Ÿ</label>
                            <input id="recordSequence" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç¶­ä¿®é …ç›®</label>
                            <textarea id="recordRepairItem" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">è£œå……</label>
                            <input id="recordSupplement" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æŠ€è¡“å“¡</label>
                            <select id="recordTechnician" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                <option value="æ›¾">æ›¾</option>
                                <option value="æ">æ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç‹€æ…‹</label>
                            <select id="recordStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                <option value="pending">æœªä¿®</option>
                                <option value="completed">å·²å®Œæˆ</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            æ–°å¢è¨˜éŒ„
                        </button>
                        <button type="button" id="cancelAddBtn" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            å–æ¶ˆ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase è¨­å®šèªªæ˜æ¨¡æ…‹æ¡† -->
    <div id="firebaseModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg max-w-2xl w-full">
            <div class="p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">ğŸ”§ Firebase è¨­å®šèªªæ˜</h3>
                <div class="space-y-4 text-sm">
                    <p class="text-gray-600">è¦ä½¿ç”¨é›²ç«¯åŒæ­¥åŠŸèƒ½ï¼Œè«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿè¨­å®š Firebaseï¼š</p>
                    
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-medium text-blue-900 mb-2">æ­¥é©Ÿ 1: å»ºç«‹ Firebase å°ˆæ¡ˆ</h4>
                        <ol class="list-decimal list-inside space-y-1 text-blue-800">
                            <li>å‰å¾€ <a href="https://console.firebase.google.com" target="_blank" class="underline">Firebase Console</a></li>
                            <li>é»æ“Šã€Œå»ºç«‹å°ˆæ¡ˆã€</li>
                            <li>è¼¸å…¥å°ˆæ¡ˆåç¨±ï¼Œä¾‹å¦‚ã€Œrepair-systemã€</li>
                            <li>å®Œæˆå°ˆæ¡ˆå»ºç«‹</li>
                        </ol>
                    </div>
                    
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-medium text-green-900 mb-2">æ­¥é©Ÿ 2: è¨­å®š Firestore è³‡æ–™åº«</h4>
                        <ol class="list-decimal list-inside space-y-1 text-green-800">
                            <li>åœ¨ Firebase Console å·¦å´é¸å–®é»æ“Šã€ŒFirestore Databaseã€</li>
                            <li>é»æ“Šã€Œå»ºç«‹è³‡æ–™åº«ã€</li>
                            <li>é¸æ“‡ã€Œæ¸¬è©¦æ¨¡å¼ã€é–‹å§‹</li>
                            <li>é¸æ“‡ä¼ºæœå™¨ä½ç½®ï¼ˆå»ºè­°é¸äºæ´²ï¼‰</li>
                        </ol>
                    </div>
                    
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <h4 class="font-medium text-orange-900 mb-2">æ­¥é©Ÿ 3: å–å¾—è¨­å®šé‡‘é‘°</h4>
                        <ol class="list-decimal list-inside space-y-1 text-orange-800">
                            <li>é»æ“Šå°ˆæ¡ˆè¨­å®šï¼ˆé½’è¼ªåœ–ç¤ºï¼‰</li>
                            <li>é¸æ“‡ã€Œå°ˆæ¡ˆè¨­å®šã€</li>
                            <li>åœ¨ã€Œä¸€èˆ¬ã€é ç±¤ä¸­ï¼Œé»æ“Šã€Œæ–°å¢æ‡‰ç”¨ç¨‹å¼ã€é¸æ“‡ç¶²é </li>
                            <li>è¤‡è£½ Firebase è¨­å®šä»£ç¢¼</li>
                            <li>å°‡è¨­å®šä»£ç¢¼è²¼åˆ°æœ¬æª”æ¡ˆç¬¬ 13-20 è¡Œ</li>
                        </ol>
                    </div>
                    
                    <p class="text-red-600 font-medium">âš ï¸ è¨­å®šå®Œæˆå‰ï¼Œé›²ç«¯åŒæ­¥åŠŸèƒ½ç„¡æ³•ä½¿ç”¨ï¼Œè³‡æ–™å°‡æš«å­˜åœ¨æœ¬åœ°ç€è¦½å™¨ä¸­ã€‚</p>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button id="useOfflineBtn" type="button" class="flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                        æš«æ™‚é›¢ç·šä½¿ç”¨
                    </button>
                    <button id="closeFirebaseModal" type="button" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        æˆ‘å·²å®Œæˆè¨­å®š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== å…¨åŸŸè®Šæ•¸ ====================
        let records = [];
        let filteredRecords = [];
        let currentView = 'current';
        let selectedPeriod = null;
        let expandedYears = new Set();
        let selectedRecords = new Set();
        let showBulkActions = false;
        let isOnlineMode = false;
        let unsubscribe = null;
        let lastUpdate = null;

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
            
            // åˆå§‹åŒ– Lucide åœ–ç¤º
            lucide.createIcons();
            
            // è¨­å®šä»Šå¤©çš„æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('recordDate');
            if (dateInput) {
                dateInput.value = today;
            }
            
            // å»¶é²æª¢æŸ¥ Firebase é…ç½®
            setTimeout(() => {
                checkFirebaseConfig();
            }, 500);
            
            // ç¶å®šäº‹ä»¶ç›£è½å™¨
            bindEventListeners();
            
            // è¼‰å…¥è³‡æ–™
            loadRecords();
            
            // æ›´æ–°è¦–åœ–
            updateCurrentView();
        });

        // ==================== Firebase ç›¸é—œå‡½æ•¸ ====================
        function checkFirebaseConfig() {
            console.log('æª¢æŸ¥ Firebase é…ç½®...');
            try {
                if (window.firebaseApp && window.db && window.firebaseApp.options.apiKey !== "ä½ çš„APIå¯†é‘°") {
                    console.log('Firebase å·²æ­£ç¢ºé…ç½®');
                    document.getElementById('firebaseModal').classList.add('hidden');
                    updateCloudStatus('online', 'é›²ç«¯åŒæ­¥');
                    isOnlineMode = true;
                } else {
                    throw new Error('Firebase not configured');
                }
            } catch (error) {
                console.log('Firebase æœªé…ç½®ï¼Œé¡¯ç¤ºè¨­å®šèªªæ˜');
                document.getElementById('firebaseModal').classList.remove('hidden');
                updateCloudStatus('offline', 'é›¢ç·šæ¨¡å¼');
                isOnlineMode = false;
            }
        }

        // ==================== UI æ›´æ–°å‡½æ•¸ ====================
        function updateCloudStatus(status, text) {
            const statusEl = document.getElementById('cloudStatus');
            const iconEl = document.getElementById('cloudIcon');
            const textEl = document.getElementById('cloudText');
            const updateTimeEl = document.getElementById('lastUpdateTime');
            const updateTimeTextEl = document.getElementById('updateTimeText');
            
            statusEl.className = 'fixed top-4 right-4 z-50 px-3 py-2 rounded-lg text-sm font-medium shadow-lg';
            
            if (status === 'online') {
                statusEl.classList.add('bg-green-100', 'text-green-800');
                iconEl.innerHTML = '<i data-lucide="cloud-check" class="icon"></i>';
                
                if (lastUpdate) {
                    updateTimeEl.classList.remove('hidden');
                    updateTimeTextEl.textContent = `æœ€å¾Œæ›´æ–°: ${formatUpdateTime(lastUpdate)}`;
                }
            } else if (status === 'syncing') {
                statusEl.classList.add('bg-blue-100', 'text-blue-800');
                iconEl.innerHTML = '<i data-lucide="cloud-upload" class="icon animate-pulse"></i>';
            } else {
                statusEl.classList.add('bg-gray-100', 'text-gray-800');
                iconEl.innerHTML = '<i data-lucide="cloud-off" class="icon"></i>';
                updateTimeEl.classList.add('hidden');
            }
            
            textEl.textContent = text;
            lucide.createIcons();
        }

        function formatUpdateTime(date) {
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) {
                return 'å‰›å‰›';
            } else if (diff < 3600000) {
                const minutes = Math.floor(diff / 60000);
                return `${minutes} åˆ†é˜å‰`;
            } else if (diff < 86400000) {
                const hours = Math.floor(diff / 3600000);
                return `${hours} å°æ™‚å‰`;
            } else {
                return date.toLocaleString('zh-TW', { 
                    month: 'numeric', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }
        }

        // å®šæœŸæ›´æ–°æ™‚é–“é¡¯ç¤º
        setInterval(() => {
            if (lastUpdate && isOnlineMode) {
                const updateTimeTextEl = document.getElementById('updateTimeText');
                if (updateTimeTextEl) {
                    updateTimeTextEl.textContent = `æœ€å¾Œæ›´æ–°: ${formatUpdateTime(lastUpdate)}`;
                }
            }
        }, 30000);

        // ==================== äº‹ä»¶ç›£è½å™¨ç¶å®š ====================
        function bindEventListeners() {
            console.log('é–‹å§‹ç¶å®šäº‹ä»¶ç›£è½å™¨...');
            
            // è¦–åœ–åˆ‡æ›æŒ‰éˆ•
            document.getElementById('currentViewBtn').addEventListener('click', function() {
                switchView('current');
            });
            
            document.getElementById('historyViewBtn').addEventListener('click', function() {
                switchView('history');
            });

            // æœå°‹å’Œç¯©é¸
            document.getElementById('searchInput').addEventListener('input', debounce(filterRecords, 300));
            document.getElementById('statusFilter').addEventListener('change', filterRecords);
            document.getElementById('technicianFilter').addEventListener('change', filterRecords);

            // æ–°å¢è¨˜éŒ„
            document.getElementById('addRecordBtn').addEventListener('click', function() {
                console.log('é»æ“Šæ–°å¢è¨˜éŒ„æŒ‰éˆ•');
                showAddRecordModal();
            });
            
            document.getElementById('cancelAddBtn').addEventListener('click', function() {
                hideAddRecordModal();
            });
            
            document.getElementById('addRecordForm').addEventListener('submit', handleAddRecord);

            // åŒæ­¥å’Œæ‰¹é‡æ“ä½œ
            document.getElementById('syncBtn').addEventListener('click', function() {
                console.log('é»æ“ŠåŒæ­¥æŒ‰éˆ•');
                syncData();
            });
            
            document.getElementById('bulkActionsBtn').addEventListener('click', toggleBulkActions);

            // åŒ¯å‡ºåŠŸèƒ½
            document.getElementById('exportBtn').addEventListener('click', function(e) {
                e.stopPropagation();
                toggleExportMenu();
            });
            
            document.getElementById('exportCSV').addEventListener('click', exportToCSV);
            document.getElementById('exportStats').addEventListener('click', exportStatistics);

            // æ‰¹é‡æ“ä½œæŒ‰éˆ•
            document.getElementById('selectAllCheckbox').addEventListener('change', toggleSelectAll);
            document.getElementById('bulkCompleteBtn').addEventListener('click', () => bulkUpdateStatus('completed'));
            document.getElementById('bulkPendingBtn').addEventListener('click', () => bulkUpdateStatus('pending'));
            document.getElementById('bulkDeleteBtn').addEventListener('click', bulkDeleteRecords);

            // Firebase æ¨¡æ…‹æ¡†
            document.getElementById('useOfflineBtn').addEventListener('click', function() {
                console.log('ä½¿ç”¨é›¢ç·šæ¨¡å¼');
                document.getElementById('firebaseModal').classList.add('hidden');
                updateCloudStatus('offline', 'é›¢ç·šæ¨¡å¼');
                isOnlineMode = false;
                loadRecords();
            });
            
            document.getElementById('closeFirebaseModal').addEventListener('click', function() {
                console.log('é—œé–‰è¨­å®šæ¨¡æ…‹æ¡†');
                document.getElementById('firebaseModal').classList.add('hidden');
                setTimeout(() => {
                    checkFirebaseConfig();
                    if (isOnlineMode) {
                        loadRecords();
                    }
                }, 100);
            });

            // é»æ“Šå¤–éƒ¨é—œé–‰æ¨¡æ…‹æ¡†
            document.getElementById('addRecordModal').addEventListener('click', function(e) {
                if (e.target.id === 'addRecordModal') {
                    hideAddRecordModal();
                }
            });

            // é»æ“Šå¤–éƒ¨é—œé–‰åŒ¯å‡ºé¸å–®
            document.addEventListener('click', function(e) {
                const exportMenu = document.getElementById('exportMenu');
                const exportBtn = document.getElementById('exportBtn');
                
                if (!exportBtn.contains(e.target) && !exportMenu.contains(e.target)) {
                    exportMenu.classList.add('hidden');
                }
            });

            console.log('äº‹ä»¶ç›£è½å™¨ç¶å®šå®Œæˆ');
        }

        // ==================== è³‡æ–™è¼‰å…¥å‡½æ•¸ ====================
        async function loadRecords() {
            console.log('è¼‰å…¥è¨˜éŒ„...');
            if (isOnlineMode) {
                setupRealtimeListener();
            } else {
                loadFromLocalStorage();
                filterRecords();
            }
        }

        function setupRealtimeListener() {
            if (unsubscribe) {
                unsubscribe();
            }

            try {
                updateCloudStatus('syncing', 'é€£æ¥ä¸­...');
                
                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'records'),
                    window.firestore.orderBy('date', 'desc')
                );
                
                unsubscribe = window.firestore.onSnapshot(q, 
                    (querySnapshot) => {
                        records = [];
                        querySnapshot.forEach((doc) => {
                            records.push({ id: doc.id, ...doc.data() });
                        });
                        
                        console.log('å³æ™‚æ›´æ–°ï¼šè¼‰å…¥äº†', records.length, 'ç­†è¨˜éŒ„');
                        lastUpdate = new Date();
                        updateCloudStatus('online', 'é›²ç«¯åŒæ­¥ (å³æ™‚)');
                        
                        filterRecords();
                        showUpdateNotification();
                    },
                    (error) => {
                        console.error('å³æ™‚ç›£è½å¤±æ•—:', error);
                        updateCloudStatus('offline', 'é€£ç·šä¸­æ–·');
                        
                        setTimeout(() => {
                            if (isOnlineMode) {
                                setupRealtimeListener();
                            }
                        }, 5000);
                    }
                );
                
                console.log('å³æ™‚ç›£è½å™¨å·²è¨­å®š');
            } catch (error) {
                console.error('è¨­å®šç›£è½å™¨å¤±æ•—:', error);
                updateCloudStatus('offline', 'é€£ç·šå¤±æ•—');
                loadFromLocalStorage();
            }
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('repairRecords');
            if (saved) {
                records = JSON.parse(saved);
                console.log('å¾æœ¬åœ°è¼‰å…¥äº†', records.length, 'ç­†è¨˜éŒ„');
            } else {
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = (currentDate.getMonth() + 1).toString().padStart(2, '0');
                
                records = [
                    { 
                        id: '1', 
                        date: `${currentYear}-${currentMonth}-20`, 
                        registrationData: 'æ¸¬è©¦å®¢æˆ¶', 
                        model: 'MMA215', 
                        sequence: '11114', 
                        repairItem: 'æ¸¬è©¦ç¶­ä¿®', 
                        supplement: 'æ¸¬è©¦è£œå……', 
                        technician: 'æ›¾', 
                        status: 'completed' 
                    },
                    { 
                        id: '2', 
                        date: `${currentYear}-${currentMonth}-15`, 
                        registrationData: 'æ¸¬è©¦å®¢æˆ¶2', 
                        model: 'TIG200', 
                        sequence: '22222', 
                        repairItem: 'æ¸¬è©¦ç¶­ä¿®2', 
                        supplement: 'æ¸¬è©¦è£œå……2', 
                        technician: 'æ', 
                        status: 'pending' 
                    }
                ];
                saveToLocalStorage();
                console.log('ä½¿ç”¨æ¸¬è©¦è³‡æ–™');
            }
        }

        function saveToLocalStorage() {
            localStorage.setItem('repairRecords', JSON.stringify(records));
        }

        // ==================== Firebase æ“ä½œå‡½æ•¸ ====================
        async function addToFirebase(record) {
            try {
                await window.firestore.addDoc(window.firestore.collection(window.db, 'records'), record);
                return true;
            } catch (error) {
                console.error('æ–°å¢åˆ° Firebase å¤±æ•—:', error);
                return false;
            }
        }

        async function updateInFirebase(id, data) {
            try {
                const docRef = window.firestore.doc(window.db, 'records', id);
                await window.firestore.updateDoc(docRef, data);
                return true;
            } catch (error) {
                console.error('æ›´æ–°åˆ° Firebase å¤±æ•—:', error);
                return false;
            }
        }

        async function deleteFromFirebase(id) {
            try {
                await window.firestore.deleteDoc(window.firestore.doc(window.db, 'records', id));
                return true;
            } catch (error) {
                console.error('å¾ Firebase åˆªé™¤å¤±æ•—:', error);
                return false;
            }
        }

        // ==================== è¦–åœ–ç›¸é—œå‡½æ•¸ ====================
        function switchView(view) {
            console.log('åˆ‡æ›è¦–åœ–åˆ°:', view);
            currentView = view;
            updateCurrentView();
            filterRecords();
        }

        function updateCurrentView() {
            document.querySelectorAll('.view-btn').forEach(btn => {
                if (btn.dataset.view === currentView) {
                    btn.className = 'flex items-center gap-2 px-6 py-3 rounded-lg transition-colors border bg-blue-600 text-white border-blue-600';
                } else {
                    btn.className = 'flex items-center gap-2 px-6 py-3 rounded-lg transition-colors border bg-white text-gray-700 border-gray-300 hover:bg-gray-50';
                }
            });

            if (currentView === 'history') {
                document.getElementById('historySelector').classList.remove('hidden');
                document.getElementById('addRecordBtn').classList.add('hidden');
                document.getElementById('exportBtn').classList.remove('hidden');
                buildHistorySelector();
            } else {
                document.getElementById('historySelector').classList.add('hidden');
                document.getElementById('addRecordBtn').classList.remove('hidden');
                document.getElementById('exportBtn').classList.add('hidden');
                selectedPeriod = null;
            }
        }

        function buildHistorySelector() {
            const container = document.getElementById('historyYearList');
            container.innerHTML = '';

            const grouped = {};
            records.forEach(record => {
                const date = new Date(record.date);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                
                if (!grouped[year]) grouped[year] = {};
                if (!grouped[year][month]) grouped[year][month] = [];
                grouped[year][month].push(record);
            });

            Object.keys(grouped)
                .sort((a, b) => parseInt(b) - parseInt(a))
                .forEach(year => {
                    const yearDiv = document.createElement('div');
                    
                    const yearBtn = document.createElement('button');
                    yearBtn.className = 'flex items-center gap-2 w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg';
                    yearBtn.onclick = () => toggleYear(parseInt(year));
                    
                    const completedCount = Object.values(grouped[year]).flat().filter(r => r.status === 'completed').length;
                    const pendingCount = Object.values(grouped[year]).flat().filter(r => r.status === 'pending').length;
                    
                    yearBtn.innerHTML = `
                        <div class="flex items-center justify-between w-full">
                            <div class="flex items-center gap-2">
                                <i data-lucide="${expandedYears.has(parseInt(year)) ? 'chevron-down' : 'chevron-right'}" class="icon"></i>
                                <span class="font-medium">${year}å¹´</span>
                            </div>
                            <div class="flex gap-2 text-xs">
                                <span class="px-2 py-1 bg-green-100 text-green-700 rounded">å·²å®Œæˆ: ${completedCount}</span>
                                <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded">æœªä¿®: ${pendingCount}</span>
                            </div>
                        </div>
                    `;
                    
                    yearDiv.appendChild(yearBtn);
                    
                    if (expandedYears.has(parseInt(year))) {
                        const monthsDiv = document.createElement('div');
                        monthsDiv.className = 'ml-6 space-y-1';
                        
                        Object.keys(grouped[year])
                            .sort((a, b) => parseInt(b) - parseInt(a))
                            .forEach(month => {
                                const monthBtn = document.createElement('button');
                                const isSelected = selectedPeriod?.year === parseInt(year) && selectedPeriod?.month === parseInt(month);
                                monthBtn.className = `block w-full text-left px-3 py-2 rounded-lg transition-colors ${
                                    isSelected ? 'bg-blue-100 text-blue-800' : 'hover:bg-gray-50'
                                }`;
                                monthBtn.onclick = () => selectPeriod(parseInt(year), parseInt(month));
                                
                                const monthCompleted = grouped[year][month].filter(r => r.status === 'completed').length;
                                const monthPending = grouped[year][month].filter(r => r.status === 'pending').length;
                                
                                monthBtn.innerHTML = `
                                    <div class="flex items-center justify-between w-full">
                                        <span>${getMonthName(parseInt(month))} (${grouped[year][month].length}ç­†)</span>
                                        <div class="flex gap-2 text-xs">
                                            <span class="px-2 py-1 bg-green-100 text-green-700 rounded">å·²å®Œæˆ: ${monthCompleted}</span>
                                            <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded">æœªä¿®: ${monthPending}</span>
                                        </div>
                                    </div>
                                `;
                                
                                monthsDiv.appendChild(monthBtn);
                            });
                        
                        yearDiv.appendChild(monthsDiv);
                    }
                    
                    container.appendChild(yearDiv);
                });
            
            lucide.createIcons();
        }

        function toggleYear(year) {
            if (expandedYears.has(year)) {
                expandedYears.delete(year);
            } else {
                expandedYears.add(year);
            }
            buildHistorySelector();
        }

        function selectPeriod(year, month) {
            selectedPeriod = { year, month };
            buildHistorySelector();
            filterRecords();
        }

        function getMonthName(month) {
            const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
            return monthNames[month - 1];
        }

        // ==================== è¨˜éŒ„æ“ä½œå‡½æ•¸ ====================
        function filterRecords() {
            let recordsToFilter = records;

            if (currentView === 'current') {
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth() + 1;
                
                recordsToFilter = records.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.getFullYear() === currentYear && 
                           recordDate.getMonth() + 1 === currentMonth;
                });
            } else if (currentView === 'history' && selectedPeriod) {
                recordsToFilter = records.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.getFullYear() === selectedPeriod.year && 
                           recordDate.getMonth() + 1 === selectedPeriod.month;
                });
            } else if (currentView === 'history' && !selectedPeriod) {
                recordsToFilter = [];
            }

            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const technicianFilter = document.getElementById('technicianFilter').value;

            filteredRecords = recordsToFilter.filter(record => {
                const matchesSearch = 
                    record.registrationData.toLowerCase().includes(searchTerm) ||
                    record.model.toLowerCase().includes(searchTerm) ||
                    record.sequence.includes(searchTerm) ||
                    record.repairItem.toLowerCase().includes(searchTerm);
                
                const matchesStatus = statusFilter === 'all' || record.status === statusFilter;
                const matchesTechnician = technicianFilter === 'all' || record.technician === technicianFilter;
                
                return matchesSearch && matchesStatus && matchesTechnician;
            });

            renderRecords();
            updateStats();
            updateBulkActionsVisibility();
        }

        function renderRecords() {
            const tbody = document.getElementById('recordsTable');
            const noRecords = document.getElementById('noRecords');
            const tableHeader = document.getElementById('tableHeader');

            if (filteredRecords.length === 0) {
                tbody.innerHTML = '';
                noRecords.classList.remove('hidden');
                return;
            }

            noRecords.classList.add('hidden');

            if (showBulkActions) {
                if (!tableHeader.querySelector('.bulk-checkbox')) {
                    const checkboxTh = document.createElement('th');
                    checkboxTh.className = 'bulk-checkbox px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12';
                    checkboxTh.innerHTML = '<input type="checkbox" id="headerCheckbox" class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">';
                    tableHeader.insertBefore(checkboxTh, tableHeader.firstChild);
                    
                    document.getElementById('headerCheckbox').addEventListener('change', toggleSelectAll);
                }
            } else {
                const checkboxTh = tableHeader.querySelector('.bulk-checkbox');
                if (checkboxTh) checkboxTh.remove();
            }

            tbody.innerHTML = filteredRecords.map(record => `
                <tr class="hover:bg-gray-50 transition-colors cursor-pointer" onclick="toggleRowExpansion('${record.id}')">
                    ${showBulkActions ? `
                        <td class="px-4 py-4 whitespace-nowrap" onclick="event.stopPropagation()">
                            <input type="checkbox" class="record-checkbox w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" 
                                   data-id="${record.id}" ${selectedRecords.has(record.id) ? 'checked' : ''}>
                        </td>
                    ` : ''}
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                        <div class="flex items-center gap-2">
                            <i data-lucide="chevron-right" class="icon text-gray-400 expand-icon" data-id="${record.id}"></i>
                            ${record.date}
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${record.registrationData}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${record.model}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${record.sequence}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                        <div class="flex items-center gap-2">
                            <i data-lucide="user" class="icon text-gray-400"></i>
                            ${record.technician}
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm" onclick="event.stopPropagation()">
                        <div class="flex items-center gap-2">
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${
                                record.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'
                            }">
                                <i data-lucide="${record.status === 'completed' ? 'check-circle' : 'x'}" class="w-3 h-3"></i>
                                ${record.status === 'completed' ? 'å·²å®Œæˆ' : 'æœªä¿®'}
                            </span>
                            <button onclick="editRecord('${record.id}')" class="p-1 text-blue-600 hover:text-blue-800 transition-colors" title="ç·¨è¼¯">
                                <i data-lucide="edit-2" class="icon"></i>
                            </button>
                            <button onclick="deleteRecord('${record.id}')" class="p-1 text-red-600 hover:text-red-800 transition-colors" title="åˆªé™¤">
                                <i data-lucide="trash-2" class="icon"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                <tr id="details-${record.id}" class="bg-gray-50 hidden">
                    <td colspan="${showBulkActions ? '7' : '6'}" class="px-4 py-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ç¶­ä¿®é …ç›®</label>
                                <div class="p-3 bg-white border border-gray-200 rounded-lg text-sm text-gray-900">
                                    ${record.repairItem || 'ç„¡'}
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">è£œå……</label>
                                <div class="p-3 bg-white border border-gray-200 rounded-lg text-sm text-gray-600">
                                    ${record.supplement || 'ç„¡'}
                                </div>
                            </div>
                            ${record.previousRecordId ? `
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">æ­·å²è¨˜éŒ„</label>
                                    <button onclick="jumpToPreviousRecord('${record.previousRecordId}')" 
                                            class="w-full px-3 py-2 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-700 hover:bg-blue-100 transition-colors flex items-center justify-center gap-2">
                                        <i data-lucide="calendar" class="icon"></i>
                                        æŸ¥çœ‹ä¸Šæ¬¡è¨˜éŒ„
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');

            lucide.createIcons();

            document.querySelectorAll('.record-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const id = e.target.dataset.id;
                    if (e.target.checked) {
                        selectedRecords.add(id);
                    } else {
                        selectedRecords.delete(id);
                    }
                    updateBulkActionsStatus();
                });
            });
        }

        function updateStats() {
            const pendingCount = filteredRecords.filter(r => r.status === 'pending').length;
            const completedCount = filteredRecords.filter(r => r.status === 'completed').length;
            
            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('completedCount').textContent = completedCount;
        }

        // ==================== æ–°å¢/ç·¨è¼¯/åˆªé™¤è¨˜éŒ„ ====================
        function showAddRecordModal() {
            document.getElementById('addRecordModal').classList.remove('hidden');
            document.getElementById('addRecordForm').reset();
            document.getElementById('recordDate').value = new Date().toISOString().split('T')[0];
        }

        function hideAddRecordModal() {
            document.getElementById('addRecordModal').classList.add('hidden');
        }

        async function handleAddRecord(e) {
            e.preventDefault();
            
            const formData = {
                date: document.getElementById('recordDate').value,
                registrationData: document.getElementById('recordRegistration').value,
                model: document.getElementById('recordModel').value,
                sequence: document.getElementById('recordSequence').value,
                repairItem: document.getElementById('recordRepairItem').value,
                supplement: document.getElementById('recordSupplement').value,
                technician: document.getElementById('recordTechnician').value,
                status: document.getElementById('recordStatus').value,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            console.log('æ–°å¢è¨˜éŒ„:', formData);

            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            
            const existingRecord = records.find(r => 
                r.model === formData.model && 
                r.sequence === formData.sequence && 
                formData.model.trim() !== '' && 
                formData.sequence.trim() !== '' &&
                new Date(r.date) >= oneYearAgo
            );
            
            if (existingRecord) {
                const lastDate = existingRecord.date;
                formData.supplement = formData.supplement ? 
                    `${formData.supplement} (ä¸Šæ¬¡: ${lastDate})` : 
                    `ä¸Šæ¬¡: ${lastDate}`;
                formData.previousRecordId = existingRecord.id;
            }

            let success = true;
            if (isOnlineMode) {
                updateCloudStatus('syncing', 'ä¸Šå‚³ä¸­...');
                success = await addToFirebase(formData);
                if (success) {
                    updateCloudStatus('online', 'é›²ç«¯åŒæ­¥ (å³æ™‚)');
                } else {
                    updateCloudStatus('offline', 'ä¸Šå‚³å¤±æ•—');
                }
            } else {
                const newId = 'record_' + Date.now();
                const newRecord = { id: newId, ...formData };
                records.unshift(newRecord);
                saveToLocalStorage();
                filterRecords();
            }

            if (success) {
                hideAddRecordModal();
                showSuccessNotification('è¨˜éŒ„æ–°å¢æˆåŠŸï¼');
            } else {
                alert('æ–°å¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
            }
        }

        async function updateRecordStatus(id, newStatus) {
            const recordIndex = records.findIndex(r => r.id === id);
            if (recordIndex === -1) return;

            if (isOnlineMode) {
                updateCloudStatus('syncing', 'æ›´æ–°ä¸­...');
                const success = await updateInFirebase(id, { 
                    status: newStatus,
                    updatedAt: new Date().toISOString()
                });
                if (success) {
                    updateCloudStatus('online', 'é›²ç«¯åŒæ­¥ (å³æ™‚)');
                    showSuccessNotification('ç‹€æ…‹æ›´æ–°æˆåŠŸï¼');
                } else {
                    updateCloudStatus('offline', 'æ›´æ–°å¤±æ•—');
                    alert('æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
                }
            } else {
                const oldRecord = records[recordIndex];
                records[recordIndex] = { ...oldRecord, status: newStatus };
                saveToLocalStorage();
                filterRecords();
                showSuccessNotification('ç‹€æ…‹æ›´æ–°æˆåŠŸï¼');
            }
        }

        async function deleteRecord(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨˜éŒ„å—ï¼Ÿ')) return;

            if (isOnlineMode) {
                updateCloudStatus('syncing', 'åˆªé™¤ä¸­...');
                const success = await deleteFromFirebase(id);
                if (success) {
                    updateCloudStatus('online', 'é›²ç«¯åŒæ­¥ (å³æ™‚)');
                    showSuccessNotification('è¨˜éŒ„åˆªé™¤æˆåŠŸï¼');
                } else {
                    updateCloudStatus('offline', 'åˆªé™¤å¤±æ•—');
                    alert('åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
                }
            } else {
                const recordIndex = records.findIndex(r => r.id === id);
                if (recordIndex !== -1) {
                    records.splice(recordIndex, 1);
                    saveToLocalStorage();
                    selectedRecords.delete(id);
                    filterRecords();
                    showSuccessNotification('è¨˜éŒ„åˆªé™¤æˆåŠŸï¼');
                }
            }
        }

        // ==================== æ‰¹é‡æ“ä½œ ====================
        function toggleBulkActions() {
            showBulkActions = !showBulkActions;
            updateBulkActionsVisibility();
            renderRecords();
        }

        function updateBulkActionsVisibility() {
            const bulkBtn = document.getElementById('bulkActionsBtn');
            const bulkPanel = document.getElementById('bulkActionsPanel');
            
            if (filteredRecords.length > 0) {
                bulkBtn.classList.remove('hidden');
            } else {
                bulkBtn.classList.add('hidden');
                showBulkActions = false;
            }

            if (showBulkActions) {
                bulkBtn.className = 'flex items-center gap-2 px-4 py-2 rounded-lg transition-colors border bg-orange-600 text-white border-orange-600';
                bulkPanel.classList.remove('hidden');
            } else {
                bulkBtn.className = 'flex items-center gap-2 px-4 py-2 rounded-lg transition-colors border bg-white text-gray-700 border-gray-300 hover:bg-gray-50';
                bulkPanel.classList.add('hidden');
            }

            updateBulkActionsStatus();
        }

        function updateBulkActionsStatus() {
            const selectAllText = document.getElementById('selectAllText');
            const selectedCount = document.getElementById('selectedCount');
            const bulkButtons = document.getElementById('bulkButtons');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const headerCheckbox = document.getElementById('headerCheckbox');

            selectAllText.textContent = `å…¨é¸ (${selectedRecords.size}/${filteredRecords.length})`;

            if (selectedRecords.size > 0) {
                selectedCount.textContent = `å·²é¸æ“‡ ${selectedRecords.size} ç­†è¨˜éŒ„`;
                selectedCount.classList.remove('hidden');
                bulkButtons.classList.remove('hidden');
            } else {
                selectedCount.classList.add('hidden');
                bulkButtons.classList.add('hidden');
            }

            const allSelected = selectedRecords.size === filteredRecords.length && filteredRecords.length > 0;
            if (selectAllCheckbox) selectAllCheckbox.checked = allSelected;
            if (headerCheckbox) headerCheckbox.checked = allSelected;
        }

        function toggleSelectAll() {
            if (selectedRecords.size === filteredRecords.length) {
                selectedRecords.clear();
            } else {
                selectedRecords = new Set(filteredRecords.map(r => r.id));
            }
            renderRecords();
            updateBulkActionsStatus();
        }

        async function bulkUpdateStatus(newStatus) {
            if (selectedRecords.size === 0) return;

            if (!confirm(`ç¢ºå®šè¦å°‡é¸ä¸­çš„ ${selectedRecords.size} ç­†è¨˜éŒ„æ¨™è¨˜ç‚º ${newStatus === 'completed' ? 'å·²å®Œæˆ' : 'æœªä¿®'}ï¼Ÿ`)) return;

            if (isOnlineMode) {
                updateCloudStatus('syncing', 'æ‰¹é‡æ›´æ–°ä¸­...');
                let allSuccess = true;
                
                for (const id of selectedRecords) {
                    const success = await updateInFirebase(id, { 
                        status: newStatus,
                        updatedAt: new Date().toISOString()
                    });
                    if (!success) allSuccess = false;
                }

                if (allSuccess) {
                    updateCloudStatus('online', 'é›²ç«¯åŒæ­¥ (å³æ™‚)');
                    showSuccessNotification(`å·²æ›´æ–° ${selectedRecords.size} ç­†è¨˜éŒ„ï¼`);
                } else {
                    updateCloudStatus('offline', 'éƒ¨åˆ†æ›´æ–°å¤±æ•—');
                    alert('éƒ¨åˆ†æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
                }
            } else {
                selectedRecords.forEach(id => {
                    const recordIndex = records.findIndex(r => r.id === id);
                    if (recordIndex !== -1) {
                        records[recordIndex].status = newStatus;
                    }
                });
                saveToLocalStorage();
                filterRecords();
                showSuccessNotification(`å·²æ›´æ–° ${selectedRecords.size} ç­†è¨˜éŒ„ï¼`);
            }

            selectedRecords.clear();
            showBulkActions = false;
            updateBulkActionsVisibility();
        }

        async function bulkDeleteRecords() {
            if (selectedRecords.size === 0) return;

            if (!confirm(`ç¢ºå®šè¦åˆªé™¤é¸ä¸­çš„ ${selectedRecords.size} ç­†è¨˜éŒ„å—ï¼Ÿ`)) return;

            const idsToDelete = Array.from(selectedRecords);

            if (isOnlineMode) {
                updateCloudStatus('syncing', 'æ‰¹é‡åˆªé™¤ä¸­...');
                let allSuccess = true;
                
                for (const id of idsToDelete) {
                    const success = await deleteFromFirebase(id);
                    if (!success) allSuccess = false;
                }

                if (allSuccess) {
                    updateCloudStatus('online', 'é›²ç«¯åŒæ­¥ (å³æ™‚)');
                    showSuccessNotification(`å·²åˆªé™¤ ${idsToDelete.length} ç­†è¨˜éŒ„ï¼`);
                } else {
                    updateCloudStatus('offline', 'éƒ¨åˆ†åˆªé™¤å¤±æ•—');
                    alert('éƒ¨åˆ†åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
                }
            } else {
                idsToDelete.forEach(id => {
                    const recordIndex = records.findIndex(r => r.id === id);
                    if (recordIndex !== -1) {
                        records.splice(recordIndex, 1);
                    }
                });
                saveToLocalStorage();
                filterRecords();
                showSuccessNotification(`å·²åˆªé™¤ ${idsToDelete.length} ç­†è¨˜éŒ„ï¼`);
            }

            selectedRecords.clear();
            showBulkActions = false;
            updateBulkActionsVisibility();
        }

        // ==================== åŒ¯å‡ºåŠŸèƒ½ ====================
        function toggleExportMenu() {
            const menu = document.getElementById('exportMenu');
            menu.classList.toggle('hidden');
        }

        function exportToCSV() {
            const headers = ['æ—¥æœŸ', 'ç™»è¨˜è³‡æ–™', 'å“ç‰Œæ©Ÿå‹', 'åºè™Ÿ', 'ç¶­ä¿®é …ç›®', 'è£œå……', 'æŠ€è¡“å“¡', 'ç‹€æ…‹'];
            const csvData = [
                headers.join(','),
                ...filteredRecords.map(record => [
                    record.date,
                    `"${record.registrationData}"`,
                    `"${record.model}"`,
                    record.sequence,
                    `"${record.repairItem}"`,
                    `"${record.supplement}"`,
                    record.technician,
                    record.status === 'completed' ? 'å·²å®Œæˆ' : 'æœªä¿®'
                ].join(','))
            ].join('\n');

            downloadFile(csvData, `ç¶­ä¿®è¨˜éŒ„_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
            document.getElementById('exportMenu').classList.add('hidden');
        }

        function exportStatistics() {
            const totalRecords = filteredRecords.length;
            const completedRecords = filteredRecords.filter(r => r.status === 'completed').length;
            const pendingRecords = filteredRecords.filter(r => r.status === 'pending').length;
            const completionRate = totalRecords > 0 ? ((completedRecords / totalRecords) * 100).toFixed(1) : 0;
            
            const technicianStats = {};
            filteredRecords.forEach(record => {
                if (!technicianStats[record.technician]) {
                    technicianStats[record.technician] = { total: 0, completed: 0, pending: 0 };
                }
                technicianStats[record.technician].total++;
                if (record.status === 'completed') {
                    technicianStats[record.technician].completed++;
                } else {
                    technicianStats[record.technician].pending++;
                }
            });

            const modelStats = {};
            filteredRecords.forEach(record => {
                if (!modelStats[record.model]) {
                    modelStats[record.model] = 0;
                }
                modelStats[record.model]++;
            });

            const reportContent = `ç¶­ä¿®è¨˜éŒ„çµ±è¨ˆå ±è¡¨
ç”Ÿæˆæ™‚é–“: ${new Date().toLocaleString('zh-TW')}
æŸ¥çœ‹æœŸé–“: ${currentView === 'current' ? 'æœ¬æœˆè¨˜éŒ„' : selectedPeriod ? `${selectedPeriod.year}å¹´${selectedPeriod.month}æœˆ` : 'æ­·å²è¨˜éŒ„'}

=== ç¸½é«”çµ±è¨ˆ ===
ç¸½è¨˜éŒ„æ•¸: ${totalRecords}
å·²å®Œæˆ: ${completedRecords}
æœªä¿®: ${pendingRecords}
å®Œæˆç‡: ${completionRate}%

=== æŠ€è¡“å“¡çµ±è¨ˆ ===
${Object.entries(technicianStats).map(([tech, stats]) => 
  `${tech}: ç¸½æ•¸${stats.total} (å·²å®Œæˆ${stats.completed}, æœªä¿®${stats.pending})`
).join('\n')}

=== å“ç‰Œæ©Ÿå‹çµ±è¨ˆ ===
${Object.entries(modelStats)
  .sort((a, b) => b[1] - a[1])
  .map(([model, count]) => `${model}: ${count}æ¬¡`)
  .join('\n')}`;

            downloadFile(reportContent, `ç¶­ä¿®çµ±è¨ˆå ±è¡¨_${new Date().toISOString().split('T')[0]}.txt`, 'text/plain');
            document.getElementById('exportMenu').classList.add('hidden');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob(['\uFEFF' + content], { type: mimeType + ';charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // ==================== è¼”åŠ©å‡½æ•¸ ====================
        function syncData() {
            console.log('æ‰‹å‹•åŒæ­¥è³‡æ–™');
            if (isOnlineMode) {
                updateCloudStatus('syncing', 'åŒæ­¥ä¸­...');
                
                if (unsubscribe) {
                    showSuccessNotification('è³‡æ–™å·²æ˜¯æœ€æ–°ç‹€æ…‹ï¼');
                    updateCloudStatus('online', 'é›²ç«¯åŒæ­¥ (å³æ™‚)');
                } else {
                    setupRealtimeListener();
                }
            } else {
                alert('è«‹å…ˆè¨­å®š Firebase æ‰èƒ½ä½¿ç”¨é›²ç«¯åŒæ­¥åŠŸèƒ½');
            }
        }

        function showUpdateNotification() {
            const notification = document.createElement('div');
            notification.className = 'notification fixed bottom-4 right-4 bg-green-100 text-green-800 px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 z-50';
            notification.innerHTML = `
                <i data-lucide="refresh-cw" class="icon animate-spin"></i>
                <span>è³‡æ–™å·²æ›´æ–°</span>
            `;
            document.body.appendChild(notification);
            lucide.createIcons();
            
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        function showSuccessNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification fixed top-20 right-4 bg-blue-100 text-blue-800 px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 z-50';
            notification.innerHTML = `
                <i data-lucide="check-circle" class="icon"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            lucide.createIcons();
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function toggleRowExpansion(id) {
            const detailsRow = document.getElementById(`details-${id}`);
            const expandIcon = document.querySelector(`[data-id="${id}"].expand-icon`);
            
            if (detailsRow.classList.contains('hidden')) {
                document.querySelectorAll('[id^="details-"]').forEach(row => {
                    row.classList.add('hidden');
                });
                document.querySelectorAll('.expand-icon').forEach(icon => {
                    icon.setAttribute('data-lucide', 'chevron-right');
                });
                
                detailsRow.classList.remove('hidden');
                expandIcon.setAttribute('data-lucide', 'chevron-down');
            } else {
                detailsRow.classList.add('hidden');
                expandIcon.setAttribute('data-lucide', 'chevron-right');
            }
            
            lucide.createIcons();
        }

        function editRecord(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;

            const newStatus = record.status === 'pending' ? 'completed' : 'pending';
            
            if (confirm(`å°‡è¨˜éŒ„ç‹€æ…‹æ”¹ç‚º ${newStatus === 'completed' ? 'å·²å®Œæˆ' : 'æœªä¿®'}ï¼Ÿ`)) {
                updateRecordStatus(id, newStatus);
            }
        }

        function jumpToPreviousRecord(recordId) {
            const targetRecord = records.find(r => r.id === recordId);
            if (!targetRecord) return;

            const recordDate = new Date(targetRecord.date);
            const year = recordDate.getFullYear();
            const month = recordDate.getMonth() + 1;
            
            const currentDate = new Date();
            if (year === currentDate.getFullYear() && month === currentDate.getMonth() + 1) {
                switchView('current');
            } else {
                switchView('history');
                expandedYears.add(year);
                selectedPeriod = { year, month };
                buildHistorySelector();
                filterRecords();
            }
            
            setTimeout(() => {
                toggleRowExpansion(recordId);
                const element = document.getElementById(`details-${recordId}`);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 500);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ==================== å…¨åŸŸå‡½æ•¸ï¼ˆä¾› onclick ä½¿ç”¨ï¼‰====================
        window.toggleRowExpansion = toggleRowExpansion;
        window.editRecord = editRecord;
        window.deleteRecord = deleteRecord;
        window.jumpToPreviousRecord = jumpToPreviousRecord;

        // ==================== æ¸…ç†å’Œç¶²è·¯ç›£æ¸¬ ====================
        window.addEventListener('beforeunload', () => {
            if (unsubscribe) {
                unsubscribe();
            }
        });

        window.addEventListener('online', () => {
            console.log('ç¶²è·¯å·²é€£æ¥');
            if (isOnlineMode && !unsubscribe) {
                setupRealtimeListener();
            }
        });

        window.addEventListener('offline', () => {
            console.log('ç¶²è·¯å·²æ–·é–‹');
            updateCloudStatus('offline', 'é›¢ç·šæ¨¡å¼');
        });
    </script>
</body>
</html>
