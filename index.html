<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¶­ä¿®è¨˜éŒ„ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, getDocs, query, orderBy, onSnapshot, enableNetwork, disableNetwork } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase é…ç½® - è«‹æ›¿æ›ç‚ºä½ çš„ Firebase é …ç›®é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCbaX3ou68Xu4wOQe01X_czS_QvtUtmVaE",
            authDomain: "shfix-ae293.firebaseapp.com",
            projectId: "shfix-ae293",
            storageBucket: "shfix-ae293.firebasestorage.app",
            messagingSenderId: "786004133871",
            appId: "1:786004133871:web:fc777aabac9d9e8fe0d81a"
        };

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // å°‡ Firebase å¯¦ä¾‹æ›è¼‰åˆ° window å°è±¡
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseModules = {
            signInAnonymously,
            onAuthStateChanged,
            signOut,
            collection,
            addDoc,
            updateDoc,
            deleteDoc,
            doc,
            getDocs,
            query,
            orderBy,
            onSnapshot,
            enableNetwork,
            disableNetwork
        };
    </script>
    
    <style>
        .icon { width: 16px; height: 16px; display: inline-block; }
        .icon-lg { width: 20px; height: 20px; display: inline-block; }
        .icon-xl { width: 32px; height: 32px; display: inline-block; }
        button:focus:not(:focus-visible) { outline: none; }
        button:focus-visible { outline: 2px solid #3B82F6; outline-offset: 2px; }
        .notification { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .sync-indicator {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- é›²ç«¯ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
    <div id="cloudStatus" class="fixed top-4 right-4 z-50 px-3 py-2 rounded-lg text-sm font-medium shadow-lg bg-gray-100 text-gray-800">
        <div class="flex items-center gap-2">
            <span id="cloudIcon">â˜ï¸</span>
            <span id="cloudText">é€£ç·šä¸­...</span>
        </div>
    </div>

    <!-- ç™»å…¥ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
    <div id="authStatus" class="fixed top-4 left-4 z-50 px-3 py-2 rounded-lg text-sm font-medium shadow-lg bg-blue-100 text-blue-800 hidden">
        <div class="flex items-center gap-2">
            <span>ğŸ‘¤</span>
            <span id="authText">æœªç™»å…¥</span>
            <button id="signOutBtn" class="ml-2 text-xs underline hover:no-underline hidden">ç™»å‡º</button>
        </div>
    </div>

    <div class="min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            <!-- æ¨™é¡Œå€åŸŸ -->
            <div class="mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 mb-2 flex items-center gap-3">
                            ç¶­ä¿®è¨˜éŒ„ç®¡ç†ç³»çµ±
                            <span id="syncIndicator" class="hidden sync-indicator">ğŸ”„</span>
                        </h1>
                        <p class="text-gray-600">è¨­å‚™ç¶­ä¿®è¨˜éŒ„è¿½è¹¤èˆ‡ç®¡ç† - é›²ç«¯åŒæ­¥ç‰ˆæœ¬</p>
                    </div>
                    <div class="flex gap-3">
                        <button id="syncBtn" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            ğŸ”„ æ‰‹å‹•åŒæ­¥
                        </button>
                        <button id="settingsBtn" class="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                            âš™ï¸ ç³»çµ±è¨­å®š
                        </button>
                    </div>
                </div>
            </div>

            <!-- è¦–åœ–åˆ‡æ›æŒ‰éˆ• -->
            <div class="bg-white rounded-lg shadow-sm border p-4 mb-6">
                <div class="flex justify-center">
                    <div class="flex gap-3">
                        <button id="currentViewBtn" class="flex items-center gap-2 px-6 py-3 rounded-lg transition-colors border view-btn bg-blue-600 text-white border-blue-600" data-view="current">
                            ğŸ  æœ¬æœˆè¨˜éŒ„
                        </button>
                        <button id="historyViewBtn" class="flex items-center gap-2 px-6 py-3 rounded-lg transition-colors border view-btn bg-white text-gray-700 border-gray-300 hover:bg-gray-50" data-view="history">
                            ğŸ“ æ­·å²è¨˜éŒ„
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ­·å²è¨˜éŒ„å¹´æœˆé¸æ“‡å™¨ -->
            <div id="historySelector" class="bg-white rounded-lg shadow-sm border p-4 mb-6 hidden">
                <h3 class="text-lg font-medium text-gray-900 mb-4">é¸æ“‡æŸ¥çœ‹æœŸé–“</h3>
                <div id="historyYearList" class="space-y-2"></div>
            </div>

            <!-- æ“ä½œå·¥å…·åˆ— -->
            <div class="bg-white rounded-lg shadow-sm border p-4 mb-6">
                <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
                    <!-- æœå°‹å€åŸŸ -->
                    <div class="flex-1 max-w-md">
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">ğŸ”</span>
                            <input id="searchInput" type="text" placeholder="æœå°‹ç™»è¨˜è³‡æ–™ã€æ©Ÿå‹ã€åºè™Ÿæˆ–ç¶­ä¿®é …ç›®..." 
                                   class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>

                    <!-- æ§åˆ¶æŒ‰éˆ• -->
                    <div class="flex gap-3 flex-wrap">
                        <select id="statusFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="all">æ‰€æœ‰ç‹€æ…‹</option>
                            <option value="pending">æœªä¿®</option>
                            <option value="completed">å·²å®Œæˆ</option>
                        </select>

                        <select id="technicianFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="all">æ‰€æœ‰æŠ€è¡“å“¡</option>
                        </select>

                        <button id="addRecordBtn" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            â• æ–°å¢è¨˜éŒ„
                        </button>

                        <button id="exportBtn" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors hidden">
                            ğŸ“¥ åŒ¯å‡ºå ±è¡¨
                        </button>

                        <button id="bulkActionsBtn" class="flex items-center gap-2 px-4 py-2 rounded-lg transition-colors border bg-white text-gray-700 border-gray-300 hover:bg-gray-50 hidden">
                            âš™ï¸ æ‰¹é‡æ“ä½œ
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ‰¹é‡æ“ä½œå·¥å…·åˆ— -->
            <div id="bulkActionsPanel" class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6 hidden">
                <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input id="selectAllCheckbox" type="checkbox" class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                            <span id="selectAllText" class="text-sm font-medium text-gray-700">å…¨é¸ (0/0)</span>
                        </label>
                        <span id="selectedCount" class="text-sm text-orange-600 hidden">å·²é¸æ“‡ 0 ç­†è¨˜éŒ„</span>
                    </div>
                    
                    <div id="bulkButtons" class="flex gap-2 hidden">
                        <button id="bulkCompleteBtn" class="flex items-center gap-2 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                            âœ“ æ¨™è¨˜å·²å®Œæˆ
                        </button>
                        <button id="bulkPendingBtn" class="flex items-center gap-2 px-3 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors text-sm">
                            âœ— æ¨™è¨˜æœªä¿®
                        </button>
                        <button id="bulkDeleteBtn" class="flex items-center gap-2 px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">
                            ğŸ—‘ï¸ æ‰¹é‡åˆªé™¤
                        </button>
                    </div>
                </div>
            </div>

            <!-- çµ±è¨ˆå¡ç‰‡ -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow-sm border p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">æœªä¿®</p>
                            <p id="pendingCount" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                        <span class="text-3xl">âœ—</span>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm border p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">å·²å®Œæˆ</p>
                            <p id="completedCount" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                        <span class="text-3xl">âœ“</span>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm border p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">é›²ç«¯è¨˜éŒ„</p>
                            <p id="cloudRecordCount" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                        <span class="text-3xl">â˜ï¸</span>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm border p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">åŒæ­¥ç‹€æ…‹</p>
                            <p id="syncStatus" class="text-sm font-bold text-green-600">å·²åŒæ­¥</p>
                        </div>
                        <span id="syncStatusIcon" class="text-3xl">âœ…</span>
                    </div>
                </div>
            </div>

            <!-- è¨˜éŒ„è¡¨æ ¼ -->
            <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b">
                            <tr id="tableHeader">
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ—¥æœŸ</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç™»è¨˜è³‡æ–™</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å“ç‰Œæ©Ÿå‹</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åºè™Ÿ</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æŠ€è¡“å“¡</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTable" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                    <div id="noRecords" class="text-center py-12 hidden">
                        <p class="text-gray-500">æ²’æœ‰ç¶­ä¿®è¨˜éŒ„</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¨­å®šé é¢æ¨¡æ…‹æ¡† -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-900">ç³»çµ±è¨­å®š</h3>
                    <button id="closeSettingsBtn" class="text-gray-400 hover:text-gray-600 text-2xl">
                        Ã—
                    </button>
                </div>

                <!-- Firebase é€£ç·šç‹€æ…‹ -->
                <div class="mb-8">
                    <h4 class="text-lg font-medium text-gray-900 mb-4 flex items-center gap-2">
                        â˜ï¸ Firebase é›²ç«¯åŒæ­¥
                    </h4>
                    
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div>
                                <span class="font-medium">é€£ç·šç‹€æ…‹</span>
                                <p class="text-sm text-gray-600" id="firebaseStatus">æª¢æŸ¥ä¸­...</p>
                            </div>
                            <div class="flex gap-2">
                                <button id="reconnectBtn" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition-colors">
                                    é‡æ–°é€£ç·š
                                </button>
                                <button id="goOfflineBtn" class="px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700 transition-colors">
                                    é›¢ç·šæ¨¡å¼
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div>
                                <span class="font-medium">è‡ªå‹•åŒæ­¥</span>
                                <p class="text-sm text-gray-600">è³‡æ–™è®Šæ›´æ™‚è‡ªå‹•ä¸Šå‚³åˆ°é›²ç«¯</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input id="autoSyncToggle" type="checkbox" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- æŠ€è¡“å“¡ç®¡ç† -->
                <div class="mb-8">
                    <h4 class="text-lg font-medium text-gray-900 mb-4 flex items-center gap-2">
                        ğŸ‘¥ æŠ€è¡“å“¡ç®¡ç†
                    </h4>
                    
                    <!-- æ–°å¢æŠ€è¡“å“¡ -->
                    <div class="mb-4">
                        <div class="flex gap-2">
                            <input id="newTechnicianInput" type="text" 
                                   placeholder="è¼¸å…¥æ–°æŠ€è¡“å“¡åç¨±" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <button id="addTechnicianBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                â•
                            </button>
                        </div>
                    </div>

                    <!-- æŠ€è¡“å“¡åˆ—è¡¨ -->
                    <div id="techniciansList" class="space-y-2 max-h-60 overflow-y-auto">
                    </div>
                </div>

                <!-- è³‡æ–™ç®¡ç† -->
                <div class="mb-8">
                    <h4 class="text-lg font-medium text-gray-900 mb-4 flex items-center gap-2">
                        ğŸ’¾ è³‡æ–™ç®¡ç†
                    </h4>
                    
                    <div class="space-y-3">
                        <button id="forceSync" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            ğŸ”„ å¼·åˆ¶åŒæ­¥æ‰€æœ‰è³‡æ–™
                        </button>
                        
                        <button id="clearLocalDataBtn" class="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                            ğŸ—‘ï¸ æ¸…é™¤æœ¬åœ°è³‡æ–™
                        </button>
                        
                        <p class="text-sm text-gray-600">
                            æ³¨æ„ï¼šæ¸…é™¤æœ¬åœ°è³‡æ–™å¾Œï¼Œå°‡å¾é›²ç«¯é‡æ–°è¼‰å…¥ã€‚å¦‚éœ€å®Œå…¨åˆªé™¤è³‡æ–™ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡ã€‚
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢è¨˜éŒ„è¡¨å–® -->
    <div id="addRecordModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">æ–°å¢ç¶­ä¿®è¨˜éŒ„</h3>
                <form id="addRecordForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ—¥æœŸ</label>
                            <input id="recordDate" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç™»è¨˜è³‡æ–™</label>
                            <input id="recordRegistration" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å“ç‰Œæ©Ÿå‹</label>
                            <input id="recordModel" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">åºè™Ÿ</label>
                            <input id="recordSequence" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç¶­ä¿®é …ç›®</label>
                            <textarea id="recordRepairItem" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">è£œå……</label>
                            <input id="recordSupplement" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æŠ€è¡“å“¡</label>
                            <select id="recordTechnician" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç‹€æ…‹</label>
                            <select id="recordStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                <option value="pending">æœªä¿®</option>
                                <option value="completed">å·²å®Œæˆ</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            æ–°å¢è¨˜éŒ„
                        </button>
                        <button type="button" id="cancelAddBtn" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            å–æ¶ˆ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        // ==================== Firebase ç›¸é—œè®Šæ•¸ ====================
        let isOnline = navigator.onLine;
        let isFirebaseConnected = false;
        let autoSyncEnabled = true;
        let currentUser = null;
        let recordsListener = null;
        let techniciansListener = null;
        let pendingOperations = [];

        // ==================== å…¨åŸŸè®Šæ•¸ ====================
        let records = [];
        let filteredRecords = [];
        let currentView = 'current';
        let selectedPeriod = null;
        let expandedYears = new Set();
        let selectedRecords = new Set();
        let showBulkActions = false;
        let technicians = ['æ›¾', 'æ'];

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ç³»çµ±åˆå§‹åŒ–ä¸­...');
            
            // è¨­å®šä»Šå¤©çš„æ—¥æœŸ
            document.getElementById('recordDate').value = new Date().toISOString().split('T')[0];
            
            // ç¶å®šäº‹ä»¶ç›£è½å™¨
            bindEventListeners();
            
            // ç›£è½ç¶²è·¯ç‹€æ…‹
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
            
            // åˆå§‹åŒ– Firebase
            setTimeout(initializeFirebase, 1000);
            
            // è¼‰å…¥æœ¬åœ°è³‡æ–™ï¼ˆFirebase æœªé€£ç·šå‰çš„å‚™ç”¨ï¼‰
            loadLocalData();
            
            // æ›´æ–°è¦–åœ–
            updateCurrentView();
        });

        // ==================== Firebase åˆå§‹åŒ– ====================
        async function initializeFirebase() {
            try {
                console.log('åˆå§‹åŒ– Firebase...');
                updateCloudStatus('connecting', 'é€£ç·šä¸­...');
                
                // èº«ä»½é©—è­‰
                const { onAuthStateChanged, signInAnonymously } = window.firebaseModules;
                const auth = window.firebaseAuth;
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log('ç”¨æˆ¶å·²ç™»å…¥:', user.uid);
                        currentUser = user;
                        updateAuthStatus(true, user.uid);
                        await initializeFirestoreListeners();
                        updateCloudStatus('connected', 'å·²é€£ç·š');
                        isFirebaseConnected = true;
                        
                        // åŸ·è¡Œå¾…è™•ç†çš„æ“ä½œ
                        await processPendingOperations();
                    } else {
                        console.log('ç”¨æˆ¶æœªç™»å…¥ï¼Œå˜—è©¦åŒ¿åç™»å…¥...');
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error('åŒ¿åç™»å…¥å¤±æ•—:', error);
                            handleFirebaseError(error);
                        }
                    }
                });
                
            } catch (error) {
                console.error('Firebase åˆå§‹åŒ–å¤±æ•—:', error);
                handleFirebaseError(error);
            }
        }

        // ==================== Firestore ç›£è½å™¨è¨­ç½® ====================
        async function initializeFirestoreListeners() {
            try {
                const { collection, onSnapshot, query, orderBy } = window.firebaseModules;
                const db = window.firebaseDb;
                
                // ç›£è½ç¶­ä¿®è¨˜éŒ„è®ŠåŒ–
                const recordsQuery = query(collection(db, 'repairRecords'), orderBy('createdAt', 'desc'));
                recordsListener = onSnapshot(recordsQuery, (snapshot) => {
                    console.log('æ”¶åˆ° Firestore è¨˜éŒ„æ›´æ–°');
                    const cloudRecords = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        cloudRecords.push({
                            id: doc.id,
                            ...data,
                            firebaseId: doc.id
                        });
                    });
                    
                    // åˆä½µé›²ç«¯è³‡æ–™èˆ‡æœ¬åœ°è³‡æ–™
                    mergeCloudRecords(cloudRecords);
                    filterRecords();
                    updateCloudRecordCount(cloudRecords.length);
                }, (error) => {
                    console.error('è¨˜éŒ„ç›£è½éŒ¯èª¤:', error);
                    handleFirebaseError(error);
                });

                // ç›£è½æŠ€è¡“å“¡åˆ—è¡¨è®ŠåŒ–
                const techniciansQuery = query(collection(db, 'technicians'));
                techniciansListener = onSnapshot(techniciansQuery, (snapshot) => {
                    console.log('æ”¶åˆ° Firestore æŠ€è¡“å“¡æ›´æ–°');
                    const cloudTechnicians = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        cloudTechnicians.push(data.name);
                    });
                    
                    if (cloudTechnicians.length > 0) {
                        technicians = [...new Set([...technicians, ...cloudTechnicians])].sort();
                        saveTechniciansToLocal();
                        updateTechnicianOptions();
                    }
                }, (error) => {
                    console.error('æŠ€è¡“å“¡ç›£è½éŒ¯èª¤:', error);
                    handleFirebaseError(error);
                });

            } catch (error) {
                console.error('è¨­ç½® Firestore ç›£è½å™¨å¤±æ•—:', error);
                handleFirebaseError(error);
            }
        }

        // ==================== é›²ç«¯è³‡æ–™åˆä½µ ====================
        function mergeCloudRecords(cloudRecords) {
            const localIds = new Set(records.map(r => r.id));
            const cloudIds = new Set(cloudRecords.map(r => r.id));
            
            // æ·»åŠ é›²ç«¯ç¨æœ‰çš„è¨˜éŒ„
            cloudRecords.forEach(cloudRecord => {
                if (!localIds.has(cloudRecord.id)) {
                    records.push(cloudRecord);
                }
            });
            
            // æ›´æ–°å·²å­˜åœ¨çš„è¨˜éŒ„
            records = records.map(localRecord => {
                const cloudRecord = cloudRecords.find(cr => cr.id === localRecord.id);
                if (cloudRecord && cloudRecord.updatedAt && localRecord.updatedAt) {
                    // æ¯”è¼ƒæ›´æ–°æ™‚é–“ï¼Œä½¿ç”¨æœ€æ–°çš„ç‰ˆæœ¬
                    return new Date(cloudRecord.updatedAt) > new Date(localRecord.updatedAt) 
                        ? cloudRecord : localRecord;
                }
                return cloudRecord || localRecord;
            });
            
            saveToLocalStorage();
        }

        // ==================== Firebase è³‡æ–™æ“ä½œ ====================
        async function addRecordToFirebase(record) {
            if (!isFirebaseConnected || !currentUser) {
                addToPendingOperations('add', record);
                return null;
            }

            try {
                showSyncIndicator();
                const { collection, addDoc } = window.firebaseModules;
                const db = window.firebaseDb;
                
                const recordData = {
                    ...record,
                    userId: currentUser.uid,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                const docRef = await addDoc(collection(db, 'repairRecords'), recordData);
                console.log('è¨˜éŒ„å·²ä¸Šå‚³åˆ° Firebase:', docRef.id);
                
                hideSyncIndicator();
                updateSyncStatus('å·²åŒæ­¥', true);
                return docRef.id;
            } catch (error) {
                console.error('ä¸Šå‚³è¨˜éŒ„å¤±æ•—:', error);
                addToPendingOperations('add', record);
                handleFirebaseError(error);
                hideSyncIndicator();
                return null;
            }
        }

        async function updateRecordInFirebase(record) {
            if (!isFirebaseConnected || !currentUser || !record.firebaseId) {
                addToPendingOperations('update', record);
                return;
            }

            try {
                showSyncIndicator();
                const { doc, updateDoc } = window.firebaseModules;
                const db = window.firebaseDb;
                
                const recordData = {
                    ...record,
                    updatedAt: new Date().toISOString()
                };
                delete recordData.firebaseId;
                
                await updateDoc(doc(db, 'repairRecords', record.firebaseId), recordData);
                console.log('è¨˜éŒ„å·²åœ¨ Firebase ä¸­æ›´æ–°:', record.firebaseId);
                
                hideSyncIndicator();
                updateSyncStatus('å·²åŒæ­¥', true);
            } catch (error) {
                console.error('æ›´æ–°è¨˜éŒ„å¤±æ•—:', error);
                addToPendingOperations('update', record);
                handleFirebaseError(error);
                hideSyncIndicator();
            }
        }

        async function deleteRecordFromFirebase(firebaseId) {
            if (!isFirebaseConnected || !currentUser || !firebaseId) {
                addToPendingOperations('delete', { firebaseId });
                return;
            }

            try {
                showSyncIndicator();
                const { doc, deleteDoc } = window.firebaseModules;
                const db = window.firebaseDb;
                
                await deleteDoc(doc(db, 'repairRecords', firebaseId));
                console.log('è¨˜éŒ„å·²å¾ Firebase ä¸­åˆªé™¤:', firebaseId);
                
                hideSyncIndicator();
                updateSyncStatus('å·²åŒæ­¥', true);
            } catch (error) {
                console.error('åˆªé™¤è¨˜éŒ„å¤±æ•—:', error);
                addToPendingOperations('delete', { firebaseId });
                handleFirebaseError(error);
                hideSyncIndicator();
            }
        }

        async function syncTechniciansToFirebase() {
            if (!isFirebaseConnected || !currentUser) {
                return;
            }

            try {
                const { collection, getDocs, addDoc } = window.firebaseModules;
                const db = window.firebaseDb;
                
                // ç²å–ç¾æœ‰æŠ€è¡“å“¡
                const snapshot = await getDocs(collection(db, 'technicians'));
                const existingTechnicians = new Set();
                snapshot.forEach(doc => {
                    existingTechnicians.add(doc.data().name);
                });

                // æ·»åŠ æ–°æŠ€è¡“å“¡
                for (const techName of technicians) {
                    if (!existingTechnicians.has(techName)) {
                        await addDoc(collection(db, 'technicians'), {
                            name: techName,
                            userId: currentUser.uid,
                            createdAt: new Date().toISOString()
                        });
                        console.log('æŠ€è¡“å“¡å·²ä¸Šå‚³:', techName);
                    }
                }
            } catch (error) {
                console.error('åŒæ­¥æŠ€è¡“å“¡å¤±æ•—:', error);
                handleFirebaseError(error);
            }
        }

        // ==================== å¾…è™•ç†æ“ä½œç®¡ç† ====================
        function addToPendingOperations(operation, data) {
            pendingOperations.push({
                operation,
                data,
                timestamp: new Date().toISOString()
            });
            updateSyncStatus('å¾…åŒæ­¥', false);
            savePendingOperations();
        }

        async function processPendingOperations() {
            if (!isFirebaseConnected || pendingOperations.length === 0) {
                return;
            }

            console.log(`è™•ç† ${pendingOperations.length} å€‹å¾…è™•ç†æ“ä½œ`);
            showSyncIndicator();

            for (const op of pendingOperations) {
                try {
                    switch (op.operation) {
                        case 'add':
                            await addRecordToFirebase(op.data);
                            break;
                        case 'update':
                            await updateRecordInFirebase(op.data);
                            break;
                        case 'delete':
                            await deleteRecordFromFirebase(op.data.firebaseId);
                            break;
                    }
                } catch (error) {
                    console.error('è™•ç†å¾…è™•ç†æ“ä½œå¤±æ•—:', error);
                }
            }

            pendingOperations = [];
            savePendingOperations();
            hideSyncIndicator();
            updateSyncStatus('å·²åŒæ­¥', true);
            showSuccessNotification('é›¢ç·šæ“ä½œå·²åŒæ­¥åˆ°é›²ç«¯ï¼');
        }

        function savePendingOperations() {
            localStorage.setItem('pendingOperations', JSON.stringify(pendingOperations));
        }

        function loadPendingOperations() {
            const saved = localStorage.getItem('pendingOperations');
            if (saved) {
                pendingOperations = JSON.parse(saved);
            }
        }

        // ==================== ç‹€æ…‹æ›´æ–°å‡½æ•¸ ====================
        function updateCloudStatus(status, text) {
            const cloudIcon = document.getElementById('cloudIcon');
            const cloudText = document.getElementById('cloudText');
            
            switch (status) {
                case 'connecting':
                    cloudIcon.textContent = 'ğŸ”„';
                    cloudIcon.classList.add('sync-indicator');
                    document.getElementById('cloudStatus').className = 'fixed top-4 right-4 z-50 px-3 py-2 rounded-lg text-sm font-medium shadow-lg bg-yellow-100 text-yellow-800';
                    break;
                case 'connected':
                    cloudIcon.textContent = 'â˜ï¸';
                    cloudIcon.classList.remove('sync-indicator');
                    document.getElementById('cloudStatus').className = 'fixed top-4 right-4 z-50 px-3 py-2 rounded-lg text-sm font-medium shadow-lg bg-green-100 text-green-800';
                    break;
                case 'offline':
                    cloudIcon.textContent = 'ğŸ“±';
                    cloudIcon.classList.remove('sync-indicator');
                    document.getElementById('cloudStatus').className = 'fixed top-4 right-4 z-50 px-3 py-2 rounded-lg text-sm font-medium shadow-lg bg-gray-100 text-gray-800';
                    break;
                case 'error':
                    cloudIcon.textContent = 'âš ï¸';
                    cloudIcon.classList.remove('sync-indicator');
                    document.getElementById('cloudStatus').className = 'fixed top-4 right-4 z-50 px-3 py-2 rounded-lg text-sm font-medium shadow-lg bg-red-100 text-red-800';
                    break;
            }
            
            cloudText.textContent = text;
        }

        function updateAuthStatus(isLoggedIn, userId) {
            const authStatus = document.getElementById('authStatus');
            const authText = document.getElementById('authText');
            const signOutBtn = document.getElementById('signOutBtn');
            
            if (isLoggedIn) {
                authStatus.classList.remove('hidden');
                authText.textContent = `å·²ç™»å…¥ (${userId.substring(0, 8)}...)`;
                signOutBtn.classList.remove('hidden');
            } else {
                authStatus.classList.add('hidden');
                signOutBtn.classList.add('hidden');
            }
        }

        function updateSyncStatus(status, isGood) {
            document.getElementById('syncStatus').textContent = status;
            document.getElementById('syncStatusIcon').textContent = isGood ? 'âœ…' : 'â³';
            document.getElementById('syncStatus').className = `text-sm font-bold ${isGood ? 'text-green-600' : 'text-orange-600'}`;
        }

        function updateCloudRecordCount(count) {
            document.getElementById('cloudRecordCount').textContent = count;
        }

        function showSyncIndicator() {
            document.getElementById('syncIndicator').classList.remove('hidden');
        }

        function hideSyncIndicator() {
            document.getElementById('syncIndicator').classList.add('hidden');
        }

        // ==================== ç¶²è·¯ç‹€æ…‹è™•ç† ====================
        function handleOnline() {
            console.log('ç¶²è·¯å·²é€£ç·š');
            isOnline = true;
            if (isFirebaseConnected) {
                updateCloudStatus('connected', 'å·²é€£ç·š');
                processPendingOperations();
            } else {
                initializeFirebase();
            }
        }

        function handleOffline() {
            console.log('ç¶²è·¯å·²æ–·ç·š');
            isOnline = false;
            updateCloudStatus('offline', 'é›¢ç·šæ¨¡å¼');
        }

        function handleFirebaseError(error) {
            console.error('Firebase éŒ¯èª¤:', error);
            isFirebaseConnected = false;
            updateCloudStatus('error', 'é€£ç·šéŒ¯èª¤');
            
            // æ ¹æ“šéŒ¯èª¤é¡å‹é¡¯ç¤ºä¸åŒè¨Šæ¯
            if (error.code === 'permission-denied') {
                showErrorNotification('æ¬Šé™ä¸è¶³ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡');
            } else if (error.code === 'unavailable') {
                showErrorNotification('Firebase æœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨');
            } else {
                showErrorNotification('é›²ç«¯åŒæ­¥ç™¼ç”ŸéŒ¯èª¤ï¼Œå°‡ä½¿ç”¨é›¢ç·šæ¨¡å¼');
            }
        }

        // ==================== äº‹ä»¶ç›£è½å™¨ç¶å®š ====================
        function bindEventListeners() {
            // è¨­å®šæŒ‰éˆ•
            document.getElementById('settingsBtn').addEventListener('click', showSettingsModal);
            document.getElementById('closeSettingsBtn').addEventListener('click', hideSettingsModal);
            
            // Firebase ç›¸é—œæŒ‰éˆ•
            document.getElementById('syncBtn').addEventListener('click', manualSync);
            document.getElementById('reconnectBtn').addEventListener('click', reconnectFirebase);
            document.getElementById('goOfflineBtn').addEventListener('click', goOffline);
            document.getElementById('forceSync').addEventListener('click', forceSync);
            document.getElementById('signOutBtn').addEventListener('click', signOutUser);
            
            // è‡ªå‹•åŒæ­¥é–‹é—œ
            document.getElementById('autoSyncToggle').addEventListener('change', function(e) {
                autoSyncEnabled = e.target.checked;
                localStorage.setItem('autoSyncEnabled', autoSyncEnabled);
                showSuccessNotification(autoSyncEnabled ? 'è‡ªå‹•åŒæ­¥å·²é–‹å•Ÿ' : 'è‡ªå‹•åŒæ­¥å·²é—œé–‰');
            });
            
            // æŠ€è¡“å“¡ç®¡ç†
            document.getElementById('addTechnicianBtn').addEventListener('click', function() {
                const input = document.getElementById('newTechnicianInput');
                addTechnician(input.value);
                input.value = '';
            });
            
            document.getElementById('newTechnicianInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addTechnician(this.value);
                    this.value = '';
                }
            });
            
            // æ¸…é™¤æœ¬åœ°è³‡æ–™
            document.getElementById('clearLocalDataBtn').addEventListener('click', function() {
                if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æœ¬åœ°è³‡æ–™å—ï¼Ÿç³»çµ±å°‡é‡æ–°å¾é›²ç«¯è¼‰å…¥è³‡æ–™ã€‚')) {
                    clearLocalData();
                }
            });
            
            // è¦–åœ–åˆ‡æ›æŒ‰éˆ•
            document.getElementById('currentViewBtn').addEventListener('click', function() {
                switchView('current');
            });
            
            document.getElementById('historyViewBtn').addEventListener('click', function() {
                switchView('history');
            });

            // æœå°‹å’Œç¯©é¸
            document.getElementById('searchInput').addEventListener('input', debounce(filterRecords, 300));
            document.getElementById('statusFilter').addEventListener('change', filterRecords);
            document.getElementById('technicianFilter').addEventListener('change', filterRecords);

            // æ–°å¢è¨˜éŒ„
            document.getElementById('addRecordBtn').addEventListener('click', showAddRecordModal);
            document.getElementById('cancelAddBtn').addEventListener('click', hideAddRecordModal);
            document.getElementById('addRecordForm').addEventListener('submit', handleAddRecord);

            // æ‰¹é‡æ“ä½œ
            document.getElementById('bulkActionsBtn').addEventListener('click', toggleBulkActions);
            document.getElementById('selectAllCheckbox').addEventListener('change', toggleSelectAll);
            document.getElementById('bulkCompleteBtn').addEventListener('click', () => bulkUpdateStatus('completed'));
            document.getElementById('bulkPendingBtn').addEventListener('click', () => bulkUpdateStatus('pending'));
            document.getElementById('bulkDeleteBtn').addEventListener('click', bulkDeleteRecords);

            // åŒ¯å‡ºåŠŸèƒ½
            document.getElementById('exportBtn').addEventListener('click', exportToCSV);

            // é»æ“Šå¤–éƒ¨é—œé–‰æ¨¡æ…‹æ¡†
            document.getElementById('addRecordModal').addEventListener('click', function(e) {
                if (e.target.id === 'addRecordModal') {
                    hideAddRecordModal();
                }
            });
            
            document.getElementById('settingsModal').addEventListener('click', function(e) {
                if (e.target.id === 'settingsModal') {
                    hideSettingsModal();
                }
            });
        }

        // ==================== Firebase æ“ä½œå‡½æ•¸ ====================
        async function manualSync() {
            if (!isFirebaseConnected) {
                await reconnectFirebase();
                return;
            }
            
            showSyncIndicator();
            await processPendingOperations();
            await syncTechniciansToFirebase();
            hideSyncIndicator();
            showSuccessNotification('æ‰‹å‹•åŒæ­¥å®Œæˆï¼');
        }

        async function reconnectFirebase() {
            try {
                updateCloudStatus('connecting', 'é‡æ–°é€£ç·šä¸­...');
                const { enableNetwork } = window.firebaseModules;
                const db = window.firebaseDb;
                
                await enableNetwork(db);
                await initializeFirebase();
            } catch (error) {
                console.error('é‡æ–°é€£ç·šå¤±æ•—:', error);
                handleFirebaseError(error);
            }
        }

        async function goOffline() {
            try {
                const { disableNetwork } = window.firebaseModules;
                const db = window.firebaseDb;
                
                await disableNetwork(db);
                isFirebaseConnected = false;
                updateCloudStatus('offline', 'å·²åˆ‡æ›åˆ°é›¢ç·šæ¨¡å¼');
                showSuccessNotification('å·²åˆ‡æ›åˆ°é›¢ç·šæ¨¡å¼');
            } catch (error) {
                console.error('åˆ‡æ›é›¢ç·šæ¨¡å¼å¤±æ•—:', error);
            }
        }

        async function forceSync() {
            if (!confirm('å¼·åˆ¶åŒæ­¥å°‡è¦†è“‹æ‰€æœ‰æœ¬åœ°è³‡æ–™ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                return;
            }
            
            try {
                showSyncIndicator();
                
                // æ¸…é™¤æœ¬åœ°è³‡æ–™
                records = [];
                technicians = ['æ›¾', 'æ'];
                
                // é‡æ–°å¾ Firebase è¼‰å…¥
                await loadDataFromFirebase();
                
                hideSyncIndicator();
                showSuccessNotification('å¼·åˆ¶åŒæ­¥å®Œæˆï¼');
            } catch (error) {
                console.error('å¼·åˆ¶åŒæ­¥å¤±æ•—:', error);
                hideSyncIndicator();
                showErrorNotification('å¼·åˆ¶åŒæ­¥å¤±æ•—');
            }
        }

        async function loadDataFromFirebase() {
            if (!isFirebaseConnected) return;
            
            try {
                const { collection, getDocs, query, orderBy } = window.firebaseModules;
                const db = window.firebaseDb;
                
                // è¼‰å…¥è¨˜éŒ„
                const recordsSnapshot = await getDocs(query(collection(db, 'repairRecords'), orderBy('createdAt', 'desc')));
                const cloudRecords = [];
                recordsSnapshot.forEach(doc => {
                    cloudRecords.push({
                        id: doc.id,
                        ...doc.data(),
                        firebaseId: doc.id
                    });
                });
                
                // è¼‰å…¥æŠ€è¡“å“¡
                const techniciansSnapshot = await getDocs(collection(db, 'technicians'));
                const cloudTechnicians = [];
                techniciansSnapshot.forEach(doc => {
                    cloudTechnicians.push(doc.data().name);
                });
                
                records = cloudRecords;
                if (cloudTechnicians.length > 0) {
                    technicians = [...new Set([...technicians, ...cloudTechnicians])].sort();
                }
                
                saveToLocalStorage();
                saveTechniciansToLocal();
                updateTechnicianOptions();
                filterRecords();
                
            } catch (error) {
                console.error('å¾ Firebase è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
                throw error;
            }
        }

        async function signOutUser() {
            if (!confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) return;
            
            try {
                const { signOut } = window.firebaseModules;
                const auth = window.firebaseAuth;
                
                await signOut(auth);
                currentUser = null;
                isFirebaseConnected = false;
                updateAuthStatus(false);
                updateCloudStatus('offline', 'å·²ç™»å‡º');
                showSuccessNotification('å·²ç™»å‡º');
            } catch (error) {
                console.error('ç™»å‡ºå¤±æ•—:', error);
                showErrorNotification('ç™»å‡ºå¤±æ•—');
            }
        }

        function clearLocalData() {
            localStorage.clear();
            records = [];
            technicians = ['æ›¾', 'æ'];
            pendingOperations = [];
            selectedRecords.clear();
            
            if (isFirebaseConnected) {
                loadDataFromFirebase();
            } else {
                filterRecords();
                updateTechnicianOptions();
            }
            
            showSuccessNotification('æœ¬åœ°è³‡æ–™å·²æ¸…é™¤');
        }

        // ==================== è³‡æ–™è¼‰å…¥å‡½æ•¸ ====================
        function loadLocalData() {
            loadRecords();
            loadTechnicians();
            loadPendingOperations();
            
            // è¼‰å…¥è‡ªå‹•åŒæ­¥è¨­å®š
            const saved = localStorage.getItem('autoSyncEnabled');
            if (saved !== null) {
                autoSyncEnabled = JSON.parse(saved);
                document.getElementById('autoSyncToggle').checked = autoSyncEnabled;
            }
        }

        function loadRecords() {
            const saved = localStorage.getItem('repairRecords');
            if (saved) {
                records = JSON.parse(saved);
            } else {
                // åˆå§‹æ¸¬è©¦è³‡æ–™
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = (currentDate.getMonth() + 1).toString().padStart(2, '0');
                
                records = [
                    { 
                        id: '1', 
                        date: `${currentYear}-${currentMonth}-20`, 
                        registrationData: 'æ¸¬è©¦å®¢æˆ¶', 
                        model: 'MMA215', 
                        sequence: '11114', 
                        repairItem: 'æ¸¬è©¦ç¶­ä¿®', 
                        supplement: 'æ¸¬è©¦è£œå……', 
                        technician: 'æ›¾', 
                        status: 'completed',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        id: '2', 
                        date: `${currentYear}-${currentMonth}-15`, 
                        registrationData: 'æ¸¬è©¦å®¢æˆ¶2', 
                        model: 'TIG200', 
                        sequence: '22222', 
                        repairItem: 'æ¸¬è©¦ç¶­ä¿®2', 
                        supplement: 'æ¸¬è©¦è£œå……2', 
                        technician: 'æ', 
                        status: 'pending',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
                saveToLocalStorage();
            }
            filterRecords();
        }

        function saveToLocalStorage() {
            localStorage.setItem('repairRecords', JSON.stringify(records));
        }

        // ==================== æŠ€è¡“å“¡ç®¡ç†å‡½æ•¸ ====================
        function loadTechnicians() {
            const saved = localStorage.getItem('techniciansList');
            if (saved) {
                technicians = JSON.parse(saved);
            }
            updateTechnicianOptions();
        }

        function saveTechniciansToLocal() {
            localStorage.setItem('techniciansList', JSON.stringify(technicians));
        }

        function updateTechnicianOptions() {
            // æ›´æ–°æ–°å¢è¨˜éŒ„è¡¨å–®çš„æŠ€è¡“å“¡é¸é …
            const recordSelect = document.getElementById('recordTechnician');
            if (recordSelect) {
                const currentValue = recordSelect.value;
                recordSelect.innerHTML = technicians.map(tech => 
                    `<option value="${tech}">${tech}</option>`
                ).join('');
                
                if (technicians.includes(currentValue)) {
                    recordSelect.value = currentValue;
                }
            }

            // æ›´æ–°ç¯©é¸å™¨çš„æŠ€è¡“å“¡é¸é …
            const filterSelect = document.getElementById('technicianFilter');
            if (filterSelect) {
                const currentValue = filterSelect.value;
                filterSelect.innerHTML = '<option value="all">æ‰€æœ‰æŠ€è¡“å“¡</option>' + 
                    technicians.map(tech => 
                        `<option value="${tech}">${tech}</option>`
                    ).join('');
                
                if (technicians.includes(currentValue)) {
                    filterSelect.value = currentValue;
                } else {
                    filterSelect.value = 'all';
                }
            }

            // æ›´æ–°è¨­å®šé é¢çš„æŠ€è¡“å“¡åˆ—è¡¨
            updateTechniciansListInSettings();
        }

        function updateTechniciansListInSettings() {
            const listContainer = document.getElementById('techniciansList');
            if (!listContainer) return;

            listContainer.innerHTML = technicians.map((tech, index) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                    <div class="flex items-center gap-3">
                        <span>ğŸ‘¤</span>
                        <span class="font-medium">${tech}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="deleteTechnician(${index})" 
                                class="p-1 text-red-600 hover:text-red-800 transition-colors" 
                                title="åˆªé™¤"
                                ${technicians.length <= 1 ? 'disabled' : ''}>
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function addTechnician(name) {
            if (!name || name.trim() === '') {
                alert('è«‹è¼¸å…¥æŠ€è¡“å“¡åç¨±');
                return;
            }

            name = name.trim();
            if (technicians.includes(name)) {
                alert('æ­¤æŠ€è¡“å“¡å·²å­˜åœ¨');
                return;
            }

            technicians.push(name);
            technicians.sort();
            saveTechniciansToLocal();
            updateTechnicianOptions();
            
            // åŒæ­¥åˆ° Firebase
            if (autoSyncEnabled && isFirebaseConnected) {
                await syncTechniciansToFirebase();
            }
            
            showSuccessNotification('æŠ€è¡“å“¡æ–°å¢æˆåŠŸï¼');
        }

        window.deleteTechnician = function(index) {
            if (technicians.length <= 1) {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä½æŠ€è¡“å“¡');
                return;
            }

            const techName = technicians[index];
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤æŠ€è¡“å“¡ã€Œ${techName}ã€å—ï¼Ÿ`)) return;

            technicians.splice(index, 1);
            saveTechniciansToLocal();
            updateTechnicianOptions();
            showSuccessNotification('æŠ€è¡“å“¡åˆªé™¤æˆåŠŸï¼');
        }

        // ==================== è¦–åœ–ç›¸é—œå‡½æ•¸ ====================
        function switchView(view) {
            currentView = view;
            updateCurrentView();
            filterRecords();
        }

        function updateCurrentView() {
            document.querySelectorAll('.view-btn').forEach(btn => {
                if (btn.dataset.view === currentView) {
                    btn.className = 'flex items-center gap-2 px-6 py-3 rounded-lg transition-colors border bg-blue-600 text-white border-blue-600';
                } else {
                    btn.className = 'flex items-center gap-2 px-6 py-3 rounded-lg transition-colors border bg-white text-gray-700 border-gray-300 hover:bg-gray-50';
                }
            });

            if (currentView === 'history') {
                document.getElementById('historySelector').classList.remove('hidden');
                document.getElementById('addRecordBtn').classList.add('hidden');
                document.getElementById('exportBtn').classList.remove('hidden');
                buildHistorySelector();
            } else {
                document.getElementById('historySelector').classList.add('hidden');
                document.getElementById('addRecordBtn').classList.remove('hidden');
                document.getElementById('exportBtn').classList.add('hidden');
                selectedPeriod = null;
            }
        }

        function buildHistorySelector() {
            const container = document.getElementById('historyYearList');
            container.innerHTML = '';

            // æŒ‰å¹´ä»½åˆ†çµ„
            const grouped = {};
            records.forEach(record => {
                const date = new Date(record.date);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                
                if (!grouped[year]) grouped[year] = {};
                if (!grouped[year][month]) grouped[year][month] = [];
                grouped[year][month].push(record);
            });

            // å»ºç«‹å¹´ä»½åˆ—è¡¨
            Object.keys(grouped)
                .sort((a, b) => parseInt(b) - parseInt(a))
                .forEach(year => {
                    const yearDiv = document.createElement('div');
                    
                    // å¹´ä»½æŒ‰éˆ•
                    const yearBtn = document.createElement('button');
                    yearBtn.className = 'flex items-center gap-2 w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg';
                    yearBtn.onclick = () => toggleYear(parseInt(year));
                    
                    const completedCount = Object.values(grouped[year]).flat().filter(r => r.status === 'completed').length;
                    const pendingCount = Object.values(grouped[year]).flat().filter(r => r.status === 'pending').length;
                    
                    yearBtn.innerHTML = `
                        <div class="flex items-center justify-between w-full">
                            <div class="flex items-center gap-2">
                                <span>${expandedYears.has(parseInt(year)) ? 'â–¼' : 'â–¶'}</span>
                                <span class="font-medium">${year}å¹´</span>
                            </div>
                            <div class="flex gap-2 text-xs">
                                <span class="px-2 py-1 bg-green-100 text-green-700 rounded">å·²å®Œæˆ: ${completedCount}</span>
                                <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded">æœªä¿®: ${pendingCount}</span>
                            </div>
                        </div>
                    `;
                    
                    yearDiv.appendChild(yearBtn);
                    
                    // æœˆä»½åˆ—è¡¨
                    if (expandedYears.has(parseInt(year))) {
                        const monthsDiv = document.createElement('div');
                        monthsDiv.className = 'ml-6 space-y-1';
                        
                        Object.keys(grouped[year])
                            .sort((a, b) => parseInt(b) - parseInt(a))
                            .forEach(month => {
                                const monthBtn = document.createElement('button');
                                const isSelected = selectedPeriod?.year === parseInt(year) && selectedPeriod?.month === parseInt(month);
                                monthBtn.className = `block w-full text-left px-3 py-2 rounded-lg transition-colors ${
                                    isSelected ? 'bg-blue-100 text-blue-800' : 'hover:bg-gray-50'
                                }`;
                                monthBtn.onclick = () => selectPeriod(parseInt(year), parseInt(month));
                                
                                const monthCompleted = grouped[year][month].filter(r => r.status === 'completed').length;
                                const monthPending = grouped[year][month].filter(r => r.status === 'pending').length;
                                
                                monthBtn.innerHTML = `
                                    <div class="flex items-center justify-between w-full">
                                        <span>${parseInt(month)}æœˆ (${grouped[year][month].length}ç­†)</span>
                                        <div class="flex gap-2 text-xs">
                                            <span class="px-2 py-1 bg-green-100 text-green-700 rounded">å·²å®Œæˆ: ${monthCompleted}</span>
                                            <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded">æœªä¿®: ${monthPending}</span>
                                        </div>
                                    </div>
                                `;
                                
                                monthsDiv.appendChild(monthBtn);
                            });
                        
                        yearDiv.appendChild(monthsDiv);
                    }
                    
                    container.appendChild(yearDiv);
                });
        }

        function toggleYear(year) {
            if (expandedYears.has(year)) {
                expandedYears.delete(year);
            } else {
                expandedYears.add(year);
            }
            buildHistorySelector();
        }

        function selectPeriod(year, month) {
            selectedPeriod = { year, month };
            buildHistorySelector();
            filterRecords();
        }

        // ==================== è¨˜éŒ„æ“ä½œå‡½æ•¸ ====================
        function filterRecords() {
            let recordsToFilter = records;

            if (currentView === 'current') {
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth() + 1;
                
                recordsToFilter = records.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.getFullYear() === currentYear && 
                           recordDate.getMonth() + 1 === currentMonth;
                });
            } else if (currentView === 'history' && selectedPeriod) {
                recordsToFilter = records.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.getFullYear() === selectedPeriod.year && 
                           recordDate.getMonth() + 1 === selectedPeriod.month;
                });
            } else if (currentView === 'history' && !selectedPeriod) {
                recordsToFilter = [];
            }

            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const technicianFilter = document.getElementById('technicianFilter').value;

            filteredRecords = recordsToFilter.filter(record => {
                const matchesSearch = 
                    record.registrationData.toLowerCase().includes(searchTerm) ||
                    record.model.toLowerCase().includes(searchTerm) ||
                    record.sequence.includes(searchTerm) ||
                    record.repairItem.toLowerCase().includes(searchTerm);
                
                const matchesStatus = statusFilter === 'all' || record.status === statusFilter;
                const matchesTechnician = technicianFilter === 'all' || record.technician === technicianFilter;
                
                return matchesSearch && matchesStatus && matchesTechnician;
            });

            renderRecords();
            updateStats();
            updateBulkActionsVisibility();
        }

        function renderRecords() {
            const tbody = document.getElementById('recordsTable');
            const noRecords = document.getElementById('noRecords');
            const tableHeader = document.getElementById('tableHeader');

            if (filteredRecords.length === 0) {
                tbody.innerHTML = '';
                noRecords.classList.remove('hidden');
                return;
            }

            noRecords.classList.add('hidden');

            // æ›´æ–°è¡¨æ ¼æ¨™é¡Œ
            if (showBulkActions) {
                if (!tableHeader.querySelector('.bulk-checkbox')) {
                    const checkboxTh = document.createElement('th');
                    checkboxTh.className = 'bulk-checkbox px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12';
                    checkboxTh.innerHTML = '<input type="checkbox" id="headerCheckbox" class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">';
                    tableHeader.insertBefore(checkboxTh, tableHeader.firstChild);
                    
                    document.getElementById('headerCheckbox').addEventListener('change', toggleSelectAll);
                }
            } else {
                const checkboxTh = tableHeader.querySelector('.bulk-checkbox');
                if (checkboxTh) checkboxTh.remove();
            }

            // æ¸²æŸ“è¡Œ
            tbody.innerHTML = filteredRecords.map(record => `
                <tr class="hover:bg-gray-50 transition-colors cursor-pointer" onclick="toggleRowExpansion('${record.id}')">
                    ${showBulkActions ? `
                        <td class="px-4 py-4 whitespace-nowrap" onclick="event.stopPropagation()">
                            <input type="checkbox" class="record-checkbox w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" 
                                   data-id="${record.id}" ${selectedRecords.has(record.id) ? 'checked' : ''}>
                        </td>
                    ` : ''}
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                        <div class="flex items-center gap-2">
                            <span class="expand-icon" data-id="${record.id}">â–¶</span>
                            ${record.date}
                            ${record.firebaseId ? '<span class="text-green-600" title="å·²åŒæ­¥åˆ°é›²ç«¯">â˜ï¸</span>' : '<span class="text-orange-600" title="åƒ…å­˜åœ¨æœ¬åœ°">ğŸ“±</span>'}
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${record.registrationData}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${record.model}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${record.sequence}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                        <div class="flex items-center gap-2">
                            <span>ğŸ‘¤</span>
                            ${record.technician}
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm" onclick="event.stopPropagation()">
                        <div class="flex items-center gap-2">
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${
                                record.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'
                            }">
                                ${record.status === 'completed' ? 'âœ“ å·²å®Œæˆ' : 'âœ— æœªä¿®'}
                            </span>
                            <button onclick="editRecord('${record.id}')" class="p-1 text-blue-600 hover:text-blue-800 transition-colors" title="ç·¨è¼¯">
                                âœï¸
                            </button>
                            <button onclick="deleteRecord('${record.id}')" class="p-1 text-red-600 hover:text-red-800 transition-colors" title="åˆªé™¤">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </td>
                </tr>
                <tr id="details-${record.id}" class="bg-gray-50 hidden">
                    <td colspan="${showBulkActions ? '7' : '6'}" class="px-4 py-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ç¶­ä¿®é …ç›®</label>
                                <div class="p-3 bg-white border border-gray-200 rounded-lg text-sm text-gray-900">
                                    ${record.repairItem || 'ç„¡'}
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">è£œå……</label>
                                <div class="p-3 bg-white border border-gray-200 rounded-lg text-sm text-gray-600">
                                    ${record.supplement || 'ç„¡'}
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">åŒæ­¥ç‹€æ…‹</label>
                                <div class="p-3 bg-white border border-gray-200 rounded-lg text-sm">
                                    ${record.firebaseId ? 
                                        '<span class="text-green-600 flex items-center gap-1">â˜ï¸ å·²åŒæ­¥åˆ°é›²ç«¯</span>' : 
                                        '<span class="text-orange-600 flex items-center gap-1">ğŸ“± åƒ…å­˜åœ¨æœ¬åœ°</span>'
                                    }
                                    ${record.createdAt ? `<div class="text-xs text-gray-500 mt-1">å»ºç«‹: ${new Date(record.createdAt).toLocaleString()}</div>` : ''}
                                    ${record.updatedAt ? `<div class="text-xs text-gray-500">æ›´æ–°: ${new Date(record.updatedAt).toLocaleString()}</div>` : ''}
                                </div>
                            </div>
                            ${record.previousRecordId ? `
                                <div class="md:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">æ­·å²è¨˜éŒ„</label>
                                    <button onclick="jumpToPreviousRecord('${record.previousRecordId}')" 
                                            class="w-full px-3 py-2 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-700 hover:bg-blue-100 transition-colors flex items-center justify-center gap-2">
                                        ğŸ“… æŸ¥çœ‹ä¸Šæ¬¡è¨˜éŒ„
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');

            // ç¶å®šè¤‡é¸æ¡†äº‹ä»¶
            document.querySelectorAll('.record-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const id = e.target.dataset.id;
                    if (e.target.checked) {
                        selectedRecords.add(id);
                    } else {
                        selectedRecords.delete(id);
                    }
                    updateBulkActionsStatus();
                });
            });
        }

        function updateStats() {
            const pendingCount = filteredRecords.filter(r => r.status === 'pending').length;
            const completedCount = filteredRecords.filter(r => r.status === 'completed').length;
            
            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('completedCount').textContent = completedCount;
        }

        // ==================== æ–°å¢/ç·¨è¼¯/åˆªé™¤è¨˜éŒ„ ====================
        function showAddRecordModal() {
            document.getElementById('addRecordModal').classList.remove('hidden');
            document.getElementById('addRecordForm').reset();
            document.getElementById('recordDate').value = new Date().toISOString().split('T')[0];
            updateTechnicianOptions();
        }

        function hideAddRecordModal() {
            document.getElementById('addRecordModal').classList.add('hidden');
        }

        function showSettingsModal() {
            document.getElementById('settingsModal').classList.remove('hidden');
            updateTechniciansListInSettings();
            updateFirebaseStatusInSettings();
        }

        function hideSettingsModal() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function updateFirebaseStatusInSettings() {
            const statusElement = document.getElementById('firebaseStatus');
            if (isFirebaseConnected && currentUser) {
                statusElement.textContent = `å·²é€£ç·š (ç”¨æˆ¶: ${currentUser.uid.substring(0, 8)}...)`;
                statusElement.className = 'text-sm text-green-600';
            } else if (isOnline) {
                statusElement.textContent = 'é€£ç·šä¸­...';
                statusElement.className = 'text-sm text-yellow-600';
            } else {
                statusElement.textContent = 'é›¢ç·šæ¨¡å¼';
                statusElement.className = 'text-sm text-gray-600';
            }
        }

        async function handleAddRecord(e) {
            e.preventDefault();
            
            const formData = {
                id: Date.now().toString(),
                date: document.getElementById('recordDate').value,
                registrationData: document.getElementById('recordRegistration').value,
                model: document.getElementById('recordModel').value,
                sequence: document.getElementById('recordSequence').value,
                repairItem: document.getElementById('recordRepairItem').value,
                supplement: document.getElementById('recordSupplement').value,
                technician: document.getElementById('recordTechnician').value,
                status: document.getElementById('recordStatus').value,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            // æª¢æŸ¥ä¸€å¹´å…§æ˜¯å¦æœ‰ç›¸åŒå“ç‰Œæ©Ÿå‹å’Œåºè™Ÿçš„è¨˜éŒ„
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            
            const existingRecord = records.find(r => 
                r.model === formData.model && 
                r.sequence === formData.sequence && 
                formData.model.trim() !== '' && 
                formData.sequence.trim() !== '' &&
                new Date(r.date) >= oneYearAgo
            );
            
            if (existingRecord) {
                const lastDate = existingRecord.date;
                formData.supplement = formData.supplement ? 
                    `${formData.supplement} (ä¸Šæ¬¡: ${lastDate})` : 
                    `ä¸Šæ¬¡: ${lastDate}`;
                formData.previousRecordId = existingRecord.id;
            }

            // æ·»åŠ åˆ°æœ¬åœ°
            records.unshift(formData);
            saveToLocalStorage();
            
            // åŒæ­¥åˆ° Firebase
            if (autoSyncEnabled && isFirebaseConnected) {
                const firebaseId = await addRecordToFirebase(formData);
                if (firebaseId) {
                    // æ›´æ–°æœ¬åœ°è¨˜éŒ„çš„ Firebase ID
                    const localRecord = records.find(r => r.id === formData.id);
                    if (localRecord) {
                        localRecord.firebaseId = firebaseId;
                        saveToLocalStorage();
                    }
                }
            }
            
            filterRecords();
            hideAddRecordModal();
            showSuccessNotification('è¨˜éŒ„æ–°å¢æˆåŠŸï¼');
        }

        window.editRecord = async function(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;

            const newStatus = record.status === 'pending' ? 'completed' : 'pending';
            
            if (confirm(`å°‡è¨˜éŒ„ç‹€æ…‹æ”¹ç‚º ${newStatus === 'completed' ? 'å·²å®Œæˆ' : 'æœªä¿®'}ï¼Ÿ`)) {
                record.status = newStatus;
                record.updatedAt = new Date().toISOString();
                saveToLocalStorage();
                
                // åŒæ­¥åˆ° Firebase
                if (autoSyncEnabled && isFirebaseConnected) {
                    await updateRecordInFirebase(record);
                }
                
                filterRecords();
                showSuccessNotification('ç‹€æ…‹æ›´æ–°æˆåŠŸï¼');
            }
        }

        window.deleteRecord = async function(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨˜éŒ„å—ï¼Ÿ')) return;

            const record = records.find(r => r.id === id);
            records = records.filter(r => r.id !== id);
            saveToLocalStorage();
            selectedRecords.delete(id);
            
            // å¾ Firebase åˆªé™¤
            if (autoSyncEnabled && isFirebaseConnected && record?.firebaseId) {
                await deleteRecordFromFirebase(record.firebaseId);
            }
            
            filterRecords();
            showSuccessNotification('è¨˜éŒ„åˆªé™¤æˆåŠŸï¼');
        }

        // ==================== æ‰¹é‡æ“ä½œ ====================
        function toggleBulkActions() {
            showBulkActions = !showBulkActions;
            updateBulkActionsVisibility();
            renderRecords();
        }

        function updateBulkActionsVisibility() {
            const bulkBtn = document.getElementById('bulkActionsBtn');
            const bulkPanel = document.getElementById('bulkActionsPanel');
            
            if (filteredRecords.length > 0) {
                bulkBtn.classList.remove('hidden');
            } else {
                bulkBtn.classList.add('hidden');
                showBulkActions = false;
            }

            if (showBulkActions) {
                bulkBtn.className = 'flex items-center gap-2 px-4 py-2 rounded-lg transition-colors border bg-orange-600 text-white border-orange-600';
                bulkPanel.classList.remove('hidden');
            } else {
                bulkBtn.className = 'flex items-center gap-2 px-4 py-2 rounded-lg transition-colors border bg-white text-gray-700 border-gray-300 hover:bg-gray-50';
                bulkPanel.classList.add('hidden');
            }

            updateBulkActionsStatus();
        }

        function updateBulkActionsStatus() {
            const selectAllText = document.getElementById('selectAllText');
            const selectedCount = document.getElementById('selectedCount');
            const bulkButtons = document.getElementById('bulkButtons');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const headerCheckbox = document.getElementById('headerCheckbox');

            selectAllText.textContent = `å…¨é¸ (${selectedRecords.size}/${filteredRecords.length})`;

            if (selectedRecords.size > 0) {
                selectedCount.textContent = `å·²é¸æ“‡ ${selectedRecords.size} ç­†è¨˜éŒ„`;
                selectedCount.classList.remove('hidden');
                bulkButtons.classList.remove('hidden');
            } else {
                selectedCount.classList.add('hidden');
                bulkButtons.classList.add('hidden');
            }

            const allSelected = selectedRecords.size === filteredRecords.length && filteredRecords.length > 0;
            if (selectAllCheckbox) selectAllCheckbox.checked = allSelected;
            if (headerCheckbox) headerCheckbox.checked = allSelected;
        }

        function toggleSelectAll() {
            if (selectedRecords.size === filteredRecords.length) {
                selectedRecords.clear();
            } else {
                selectedRecords = new Set(filteredRecords.map(r => r.id));
            }
            renderRecords();
            updateBulkActionsStatus();
        }

        async function bulkUpdateStatus(newStatus) {
            if (selectedRecords.size === 0) return;

            if (!confirm(`ç¢ºå®šè¦å°‡é¸ä¸­çš„ ${selectedRecords.size} ç­†è¨˜éŒ„æ¨™è¨˜ç‚º ${newStatus === 'completed' ? 'å·²å®Œæˆ' : 'æœªä¿®'}ï¼Ÿ`)) return;

            const updatedRecords = [];
            selectedRecords.forEach(id => {
                const record = records.find(r => r.id === id);
                if (record) {
                    record.status = newStatus;
                    record.updatedAt = new Date().toISOString();
                    updatedRecords.push(record);
                }
            });

            saveToLocalStorage();
            
            // æ‰¹é‡åŒæ­¥åˆ° Firebase
            if (autoSyncEnabled && isFirebaseConnected) {
                showSyncIndicator();
                for (const record of updatedRecords) {
                    await updateRecordInFirebase(record);
                }
                hideSyncIndicator();
            }
            
            filterRecords();
            showSuccessNotification(`å·²æ›´æ–° ${selectedRecords.size} ç­†è¨˜éŒ„ï¼`);

            selectedRecords.clear();
            showBulkActions = false;
            updateBulkActionsVisibility();
        }

        async function bulkDeleteRecords() {
            if (selectedRecords.size === 0) return;

            if (!confirm(`ç¢ºå®šè¦åˆªé™¤é¸ä¸­çš„ ${selectedRecords.size} ç­†è¨˜éŒ„å—ï¼Ÿ`)) return;

            const recordsToDelete = records.filter(r => selectedRecords.has(r.id));
            records = records.filter(r => !selectedRecords.has(r.id));
            saveToLocalStorage();
            
            // æ‰¹é‡å¾ Firebase åˆªé™¤
            if (autoSyncEnabled && isFirebaseConnected) {
                showSyncIndicator();
                for (const record of recordsToDelete) {
                    if (record.firebaseId) {
                        await deleteRecordFromFirebase(record.firebaseId);
                    }
                }
                hideSyncIndicator();
            }
            
            filterRecords();
            showSuccessNotification(`å·²åˆªé™¤ ${selectedRecords.size} ç­†è¨˜éŒ„ï¼`);

            selectedRecords.clear();
            showBulkActions = false;
            updateBulkActionsVisibility();
        }

        // ==================== åŒ¯å‡ºåŠŸèƒ½ ====================
        function exportToCSV() {
            const headers = ['æ—¥æœŸ', 'ç™»è¨˜è³‡æ–™', 'å“ç‰Œæ©Ÿå‹', 'åºè™Ÿ', 'ç¶­ä¿®é …ç›®', 'è£œå……', 'æŠ€è¡“å“¡', 'ç‹€æ…‹', 'åŒæ­¥ç‹€æ…‹'];
            const csvData = [
                headers.join(','),
                ...filteredRecords.map(record => [
                    record.date,
                    `"${record.registrationData}"`,
                    `"${record.model}"`,
                    record.sequence,
                    `"${record.repairItem}"`,
                    `"${record.supplement}"`,
                    record.technician,
                    record.status === 'completed' ? 'å·²å®Œæˆ' : 'æœªä¿®',
                    record.firebaseId ? 'å·²åŒæ­¥' : 'æœ¬åœ°'
                ].join(','))
            ].join('\n');

            downloadFile(csvData, `ç¶­ä¿®è¨˜éŒ„_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob(['\uFEFF' + content], { type: mimeType + ';charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // ==================== è¼”åŠ©å‡½æ•¸ ====================
        function showSuccessNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification fixed top-20 right-4 bg-green-100 text-green-800 px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 z-50';
            notification.innerHTML = `
                <span>âœ“</span>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showErrorNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification fixed top-20 right-4 bg-red-100 text-red-800 px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 z-50';
            notification.innerHTML = `
                <span>âš ï¸</span>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        window.toggleRowExpansion = function(id) {
            const detailsRow = document.getElementById(`details-${id}`);
            const expandIcon = document.querySelector(`[data-id="${id}"].expand-icon`);
            
            if (detailsRow.classList.contains('hidden')) {
                document.querySelectorAll('[id^="details-"]').forEach(row => {
                    row.classList.add('hidden');
                });
                document.querySelectorAll('.expand-icon').forEach(icon => {
                    icon.textContent = 'â–¶';
                });
                
                detailsRow.classList.remove('hidden');
                expandIcon.textContent = 'â–¼';
            } else {
                detailsRow.classList.add('hidden');
                expandIcon.textContent = 'â–¶';
            }
        }

        window.jumpToPreviousRecord = function(recordId) {
            const targetRecord = records.find(r => r.id === recordId);
            if (!targetRecord) return;

            const recordDate = new Date(targetRecord.date);
            const year = recordDate.getFullYear();
            const month = recordDate.getMonth() + 1;
            
            const currentDate = new Date();
            if (year === currentDate.getFullYear() && month === currentDate.getMonth() + 1) {
                switchView('current');
            } else {
                switchView('history');
                expandedYears.add(year);
                selectedPeriod = { year, month };
                buildHistorySelector();
                filterRecords();
            }
            
            setTimeout(() => {
                toggleRowExpansion(recordId);
                const element = document.getElementById(`details-${recordId}`);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 500);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ==================== å…¨åŸŸå‡½æ•¸æš´éœ² ====================
        window.addTechnician = addTechnician;
        window.editRecord = editRecord;
        window.deleteRecord = deleteRecord;
        window.toggleRowExpansion = toggleRowExpansion;
        window.jumpToPreviousRecord = jumpToPreviousRecord;
    </script>
</body>
</html>
