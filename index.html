<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>維修記錄管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase 配置 (你需要替換成自己的配置)
        const firebaseConfig = {
            // 這裡需要你的 Firebase 配置
            // 請到 Firebase Console 建立專案並取得配置
            apiKey: "AIzaSyCbaX3ou68Xu4wOQe01X_czS_QvtUtmVaE",
            authDomain: "shfix-ae293.firebaseapp.com",
            projectId: "shfix-ae293",
            storageBucket: "shfix-ae293.firebasestorage.app",
            messagingSenderId: "786004133871",
            appId: "1:786004133871:web:fc777aabac9d9e8fe0d81a"
        };

        // 初始化 Firebase
        try {
            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.firestore = { collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, onSnapshot };
            console.log('Firebase 初始化成功');
        } catch (error) {
            console.error('Firebase 初始化失敗:', error);
            window.firebaseApp = null;
            window.db = null;
        }
    </script>
    <style>
        .icon { width: 16px; height: 16px; }
        .icon-lg { width: 20px; height: 20px; }
        .icon-xl { width: 32px; height: 32px; }
        
        /* 移除按鈕點擊後的藍色邊框 */
        button:focus:not(:focus-visible) {
            outline: none;
        }
        
        /* 保留鍵盤導航時的焦點樣式 */
        button:focus-visible {
            outline: 2px solid #3B82F6;
            outline-offset: 2px;
        }
        
        /* 動畫效果 */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification {
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 雲端狀態指示器 -->
    <div id="cloudStatus" class="fixed top-4 right-4 z-50 px-3 py-2 rounded-lg text-sm font-medium shadow-lg bg-gray-100 text-gray-800">
        <div class="flex items-center gap-2">
            <div id="cloudIcon"><i data-lucide="cloud-off" class="icon"></i></div>
            <span id="cloudText">連接中...</span>
        </div>
    </div>

    <!-- 最後更新時間 -->
    <div id="lastUpdateTime" class="fixed top-4 left-4 z-40 px-3 py-2 rounded-lg text-xs bg-gray-50 text-gray-600 shadow-md hidden">
        <div class="flex items-center gap-2">
            <i data-lucide="clock" class="icon"></i>
            <span id="updateTimeText">最後更新: --</span>
        </div>
    </div>

    <div class="min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            <!-- 標題區域 -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">維修記錄管理系統</h1>
                <p class="text-gray-600">設備維修記錄追蹤與管理 - 雲端同步版本</p>
            </div>

            <!-- 視圖切換按鈕 -->
            <div class="bg-white rounded-lg shadow-sm border p-4 mb-6">
                <div class="flex justify-center">
                    <div class="flex gap-3">
                        <button id="currentViewBtn" class="flex items-center gap-2 px-6 py-3 rounded-lg transition-colors border view-btn bg-blue-600 text-white border-blue-600" data-view="current">
                            <i data-lucide="home" class="icon-lg"></i>
                            本月記錄
                        </button>
                        <button id="historyViewBtn" class="flex items-center gap-2 px-6 py-3 rounded-lg transition-colors border view-btn bg-white text-gray-700 border-gray-300 hover:bg-gray-50" data-view="history">
                            <i data-lucide="archive" class="icon-lg"></i>
                            歷史記錄
                        </button>
                    </div>
                </div>
            </div>

            <!-- 歷史記錄年月選擇器 -->
            <div id="historySelector" class="bg-white rounded-lg shadow-sm border p-4 mb-6 hidden">
                <h3 class="text-lg font-medium text-gray-900 mb-4">選擇查看期間</h3>
                <div id="historyYearList" class="space-y-2"></div>
            </div>

            <!-- 操作工具列 -->
            <div class="bg-white rounded-lg shadow-sm border p-4 mb-6">
                <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
                    <!-- 搜尋區域 -->
                    <div class="flex-1 max-w-md">
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 icon"></i>
                            <input id="searchInput" type="text" placeholder="搜尋登記資料、機型、序號或維修項目..." 
                                   class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>

                    <!-- 控制按鈕 -->
                    <div class="flex gap-3">
                        <select id="statusFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="all">所有狀態</option>
                            <option value="pending">未修</option>
                            <option value="completed">已完成</option>
                        </select>

                        <select id="technicianFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="all">所有技術員</option>
                            <option value="曾">曾</option>
                            <option value="李">李</option>
                        </select>

                        <button id="addRecordBtn" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i data-lucide="plus" class="icon"></i>
                            新增記錄
                        </button>

                        <div class="relative">
                            <button id="exportBtn" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors hidden">
                                <i data-lucide="download" class="icon"></i>
                                匯出報表
                            </button>
                            <div id="exportMenu" class="absolute right-0 top-full mt-2 w-48 bg-white rounded-lg shadow-lg border z-50 hidden">
                                <div class="p-2">
                                    <button id="exportCSV" class="w-full flex items-center gap-2 px-3 py-2 text-left hover:bg-gray-50 rounded text-sm">
                                        <i data-lucide="file-text" class="icon text-blue-500"></i>
                                        匯出 CSV 檔案
                                    </button>
                                    <button id="exportStats" class="w-full flex items-center gap-2 px-3 py-2 text-left hover:bg-gray-50 rounded text-sm">
                                        <i data-lucide="bar-chart-3" class="icon text-green-500"></i>
                                        匯出統計報表
                                    </button>
                                </div>
                            </div>
                        </div>

                        <button id="bulkActionsBtn" class="flex items-center gap-2 px-4 py-2 rounded-lg transition-colors border bg-white text-gray-700 border-gray-300 hover:bg-gray-50 hidden">
                            <i data-lucide="settings" class="icon"></i>
                            批量操作
                        </button>

                        <button id="syncBtn" class="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors" title="手動同步資料">
                            <i data-lucide="refresh-cw" class="icon"></i>
                            <span class="hidden sm:inline">同步資料</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 批量操作工具列 -->
            <div id="bulkActionsPanel" class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6 hidden">
                <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input id="selectAllCheckbox" type="checkbox" class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                            <span id="selectAllText" class="text-sm font-medium text-gray-700">全選 (0/0)</span>
                        </label>
                        <span id="selectedCount" class="text-sm text-orange-600 hidden">已選擇 0 筆記錄</span>
                    </div>
                    
                    <div id="bulkButtons" class="flex gap-2 hidden">
                        <button id="bulkCompleteBtn" class="flex items-center gap-2 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                            <i data-lucide="check-circle" class="icon"></i>
                            標記已完成
                        </button>
                        <button id="bulkPendingBtn" class="flex items-center gap-2 px-3 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors text-sm">
                            <i data-lucide="x" class="icon"></i>
                            標記未修
                        </button>
                        <button id="bulkDeleteBtn" class="flex items-center gap-2 px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">
                            <i data-lucide="trash-2" class="icon"></i>
                            批量刪除
                        </button>
                    </div>
                </div>
            </div>

            <!-- 統計卡片 -->
            <div id="statsCards" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow-sm border p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">未修</p>
                            <p id="pendingCount" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                        <i data-lucide="x" class="icon-xl text-gray-400"></i>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm border p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">已完成</p>
                            <p id="completedCount" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                        <i data-lucide="check-circle" class="icon-xl text-gray-400"></i>
                    </div>
                </div>
            </div>

            <!-- 記錄表格 -->
            <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b">
                            <tr id="tableHeader">
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">登記資料</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">品牌機型</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">序號</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">技術員</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTable" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                    <div id="noRecords" class="text-center py-12 hidden">
                        <p class="text-gray-500">沒有維修記錄</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增記錄表單 -->
    <div id="addRecordModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">新增維修記錄</h3>
                <form id="addRecordForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">日期</label>
                            <input id="recordDate" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">登記資料</label>
                            <input id="recordRegistration" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">品牌機型</label>
                            <input id="recordModel" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">序號</label>
                            <input id="recordSequence" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">維修項目</label>
                            <textarea id="recordRepairItem" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">補充</label>
                            <input id="recordSupplement" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">技術員</label>
                            <select id="recordTechnician" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                <option value="曾">曾</option>
                                <option value="李">李</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">狀態</label>
                            <select id="recordStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                <option value="pending">未修</option>
                                <option value="completed">已完成</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            新增記錄
                        </button>
                        <button type="button" id="cancelAddBtn" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            取消
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase 設定說明模態框 -->
    <div id="firebaseModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg max-w-2xl w-full">
            <div class="p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">🔧 Firebase 設定說明</h3>
                <div class="space-y-4 text-sm">
                    <p class="text-gray-600">要使用雲端同步功能，請按照以下步驟設定 Firebase：</p>
                    
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-medium text-blue-900 mb-2">步驟 1: 建立 Firebase 專案</h4>
                        <ol class="list-decimal list-inside space-y-1 text-blue-800">
                            <li>前往 <a href="https://console.firebase.google.com" target="_blank" class="underline">Firebase Console</a></li>
                            <li>點擊「建立專案」</li>
                            <li>輸入專案名稱，例如「repair-system」</li>
                            <li>完成專案建立</li>
                        </ol>
                    </div>
                    
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-medium text-green-900 mb-2">步驟 2: 設定 Firestore 資料庫</h4>
                        <ol class="list-decimal list-inside space-y-1 text-green-800">
                            <li>在 Firebase Console 左側選單點擊「Firestore Database」</li>
                            <li>點擊「建立資料庫」</li>
                            <li>選擇「測試模式」開始</li>
                            <li>選擇伺服器位置（建議選亞洲）</li>
                        </ol>
                    </div>
                    
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <h4 class="font-medium text-orange-900 mb-2">步驟 3: 取得設定金鑰</h4>
                        <ol class="list-decimal list-inside space-y-1 text-orange-800">
                            <li>點擊專案設定（齒輪圖示）</li>
                            <li>選擇「專案設定」</li>
                            <li>在「一般」頁籤中，點擊「新增應用程式」選擇網頁</li>
                            <li>複製 Firebase 設定代碼</li>
                            <li>將設定代碼貼到本檔案第 13-20 行</li>
                        </ol>
                    </div>
                    
                    <p class="text-red-600 font-medium">⚠️ 設定完成前，雲端同步功能無法使用，資料將暫存在本地瀏覽器中。</p>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button id="useOfflineBtn" type="button" class="flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                        暫時離線使用
                    </button>
                    <button id="closeFirebaseModal" type="button" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        我已完成設定
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== 全域變數 ====================
        let records = [];
        let filteredRecords = [];
        let currentView = 'current';
        let selectedPeriod = null;
        let expandedYears = new Set();
        let selectedRecords = new Set();
        let showBulkActions = false;
        let isOnlineMode = false;
        let unsubscribe = null;
        let lastUpdate = null;

        // ==================== 初始化 ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM 載入完成，開始初始化...');
            
            // 初始化 Lucide 圖示
            lucide.createIcons();
            
            // 設定今天的日期
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('recordDate');
            if (dateInput) {
                dateInput.value = today;
            }
            
            // 延遲檢查 Firebase 配置
            setTimeout(() => {
                checkFirebaseConfig();
            }, 500);
            
            // 綁定事件監聽器
            bindEventListeners();
            
            // 載入資料
            loadRecords();
            
            // 更新視圖
            updateCurrentView();
        });

        // ==================== Firebase 相關函數 ====================
        function checkFirebaseConfig() {
            console.log('檢查 Firebase 配置...');
            try {
                if (window.firebaseApp && window.db && window.firebaseApp.options.apiKey !== "你的API密鑰") {
                    console.log('Firebase 已正確配置');
                    document.getElementById('firebaseModal').classList.add('hidden');
                    updateCloudStatus('online', '雲端同步');
                    isOnlineMode = true;
                } else {
                    throw new Error('Firebase not configured');
                }
            } catch (error) {
                console.log('Firebase 未配置，顯示設定說明');
                document.getElementById('firebaseModal').classList.remove('hidden');
                updateCloudStatus('offline', '離線模式');
                isOnlineMode = false;
            }
        }

        // ==================== UI 更新函數 ====================
        function updateCloudStatus(status, text) {
            const statusEl = document.getElementById('cloudStatus');
            const iconEl = document.getElementById('cloudIcon');
            const textEl = document.getElementById('cloudText');
            const updateTimeEl = document.getElementById('lastUpdateTime');
            const updateTimeTextEl = document.getElementById('updateTimeText');
            
            statusEl.className = 'fixed top-4 right-4 z-50 px-3 py-2 rounded-lg text-sm font-medium shadow-lg';
            
            if (status === 'online') {
                statusEl.classList.add('bg-green-100', 'text-green-800');
                iconEl.innerHTML = '<i data-lucide="cloud-check" class="icon"></i>';
                
                if (lastUpdate) {
                    updateTimeEl.classList.remove('hidden');
                    updateTimeTextEl.textContent = `最後更新: ${formatUpdateTime(lastUpdate)}`;
                }
            } else if (status === 'syncing') {
                statusEl.classList.add('bg-blue-100', 'text-blue-800');
                iconEl.innerHTML = '<i data-lucide="cloud-upload" class="icon animate-pulse"></i>';
            } else {
                statusEl.classList.add('bg-gray-100', 'text-gray-800');
                iconEl.innerHTML = '<i data-lucide="cloud-off" class="icon"></i>';
                updateTimeEl.classList.add('hidden');
            }
            
            textEl.textContent = text;
            lucide.createIcons();
        }

        function formatUpdateTime(date) {
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) {
                return '剛剛';
            } else if (diff < 3600000) {
                const minutes = Math.floor(diff / 60000);
                return `${minutes} 分鐘前`;
            } else if (diff < 86400000) {
                const hours = Math.floor(diff / 3600000);
                return `${hours} 小時前`;
            } else {
                return date.toLocaleString('zh-TW', { 
                    month: 'numeric', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }
        }

        // 定期更新時間顯示
        setInterval(() => {
            if (lastUpdate && isOnlineMode) {
                const updateTimeTextEl = document.getElementById('updateTimeText');
                if (updateTimeTextEl) {
                    updateTimeTextEl.textContent = `最後更新: ${formatUpdateTime(lastUpdate)}`;
                }
            }
        }, 30000);

        // ==================== 事件監聽器綁定 ====================
        function bindEventListeners() {
            console.log('開始綁定事件監聽器...');
            
            // 視圖切換按鈕
            document.getElementById('currentViewBtn').addEventListener('click', function() {
                switchView('current');
            });
            
            document.getElementById('historyViewBtn').addEventListener('click', function() {
                switchView('history');
            });

            // 搜尋和篩選
            document.getElementById('searchInput').addEventListener('input', debounce(filterRecords, 300));
            document.getElementById('statusFilter').addEventListener('change', filterRecords);
            document.getElementById('technicianFilter').addEventListener('change', filterRecords);

            // 新增記錄
            document.getElementById('addRecordBtn').addEventListener('click', function() {
                console.log('點擊新增記錄按鈕');
                showAddRecordModal();
            });
            
            document.getElementById('cancelAddBtn').addEventListener('click', function() {
                hideAddRecordModal();
            });
            
            document.getElementById('addRecordForm').addEventListener('submit', handleAddRecord);

            // 同步和批量操作
            document.getElementById('syncBtn').addEventListener('click', function() {
                console.log('點擊同步按鈕');
                syncData();
            });
            
            document.getElementById('bulkActionsBtn').addEventListener('click', toggleBulkActions);

            // 匯出功能
            document.getElementById('exportBtn').addEventListener('click', function(e) {
                e.stopPropagation();
                toggleExportMenu();
            });
            
            document.getElementById('exportCSV').addEventListener('click', exportToCSV);
            document.getElementById('exportStats').addEventListener('click', exportStatistics);

            // 批量操作按鈕
            document.getElementById('selectAllCheckbox').addEventListener('change', toggleSelectAll);
            document.getElementById('bulkCompleteBtn').addEventListener('click', () => bulkUpdateStatus('completed'));
            document.getElementById('bulkPendingBtn').addEventListener('click', () => bulkUpdateStatus('pending'));
            document.getElementById('bulkDeleteBtn').addEventListener('click', bulkDeleteRecords);

            // Firebase 模態框
            document.getElementById('useOfflineBtn').addEventListener('click', function() {
                console.log('使用離線模式');
                document.getElementById('firebaseModal').classList.add('hidden');
                updateCloudStatus('offline', '離線模式');
                isOnlineMode = false;
                loadRecords();
            });
            
            document.getElementById('closeFirebaseModal').addEventListener('click', function() {
                console.log('關閉設定模態框');
                document.getElementById('firebaseModal').classList.add('hidden');
                setTimeout(() => {
                    checkFirebaseConfig();
                    if (isOnlineMode) {
                        loadRecords();
                    }
                }, 100);
            });

            // 點擊外部關閉模態框
            document.getElementById('addRecordModal').addEventListener('click', function(e) {
                if (e.target.id === 'addRecordModal') {
                    hideAddRecordModal();
                }
            });

            // 點擊外部關閉匯出選單
            document.addEventListener('click', function(e) {
                const exportMenu = document.getElementById('exportMenu');
                const exportBtn = document.getElementById('exportBtn');
                
                if (!exportBtn.contains(e.target) && !exportMenu.contains(e.target)) {
                    exportMenu.classList.add('hidden');
                }
            });

            console.log('事件監聽器綁定完成');
        }

        // ==================== 資料載入函數 ====================
        async function loadRecords() {
            console.log('載入記錄...');
            if (isOnlineMode) {
                setupRealtimeListener();
            } else {
                loadFromLocalStorage();
                filterRecords();
            }
        }

        function setupRealtimeListener() {
            if (unsubscribe) {
                unsubscribe();
            }

            try {
                updateCloudStatus('syncing', '連接中...');
                
                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'records'),
                    window.firestore.orderBy('date', 'desc')
                );
                
                unsubscribe = window.firestore.onSnapshot(q, 
                    (querySnapshot) => {
                        records = [];
                        querySnapshot.forEach((doc) => {
                            records.push({ id: doc.id, ...doc.data() });
                        });
                        
                        console.log('即時更新：載入了', records.length, '筆記錄');
                        lastUpdate = new Date();
                        updateCloudStatus('online', '雲端同步 (即時)');
                        
                        filterRecords();
                        showUpdateNotification();
                    },
                    (error) => {
                        console.error('即時監聽失敗:', error);
                        updateCloudStatus('offline', '連線中斷');
                        
                        setTimeout(() => {
                            if (isOnlineMode) {
                                setupRealtimeListener();
                            }
                        }, 5000);
                    }
                );
                
                console.log('即時監聽器已設定');
            } catch (error) {
                console.error('設定監聽器失敗:', error);
                updateCloudStatus('offline', '連線失敗');
                loadFromLocalStorage();
            }
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('repairRecords');
            if (saved) {
                records = JSON.parse(saved);
                console.log('從本地載入了', records.length, '筆記錄');
            } else {
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = (currentDate.getMonth() + 1).toString().padStart(2, '0');
                
                records = [
                    { 
                        id: '1', 
                        date: `${currentYear}-${currentMonth}-20`, 
                        registrationData: '測試客戶', 
                        model: 'MMA215', 
                        sequence: '11114', 
                        repairItem: '測試維修', 
                        supplement: '測試補充', 
                        technician: '曾', 
                        status: 'completed' 
                    },
                    { 
                        id: '2', 
                        date: `${currentYear}-${currentMonth}-15`, 
                        registrationData: '測試客戶2', 
                        model: 'TIG200', 
                        sequence: '22222', 
                        repairItem: '測試維修2', 
                        supplement: '測試補充2', 
                        technician: '李', 
                        status: 'pending' 
                    }
                ];
                saveToLocalStorage();
                console.log('使用測試資料');
            }
        }

        function saveToLocalStorage() {
            localStorage.setItem('repairRecords', JSON.stringify(records));
        }

        // ==================== Firebase 操作函數 ====================
        async function addToFirebase(record) {
            try {
                await window.firestore.addDoc(window.firestore.collection(window.db, 'records'), record);
                return true;
            } catch (error) {
                console.error('新增到 Firebase 失敗:', error);
                return false;
            }
        }

        async function updateInFirebase(id, data) {
            try {
                const docRef = window.firestore.doc(window.db, 'records', id);
                await window.firestore.updateDoc(docRef, data);
                return true;
            } catch (error) {
                console.error('更新到 Firebase 失敗:', error);
                return false;
            }
        }

        async function deleteFromFirebase(id) {
            try {
                await window.firestore.deleteDoc(window.firestore.doc(window.db, 'records', id));
                return true;
            } catch (error) {
                console.error('從 Firebase 刪除失敗:', error);
                return false;
            }
        }

        // ==================== 視圖相關函數 ====================
        function switchView(view) {
            console.log('切換視圖到:', view);
            currentView = view;
            updateCurrentView();
            filterRecords();
        }

        function updateCurrentView() {
            document.querySelectorAll('.view-btn').forEach(btn => {
                if (btn.dataset.view === currentView) {
                    btn.className = 'flex items-center gap-2 px-6 py-3 rounded-lg transition-colors border bg-blue-600 text-white border-blue-600';
                } else {
                    btn.className = 'flex items-center gap-2 px-6 py-3 rounded-lg transition-colors border bg-white text-gray-700 border-gray-300 hover:bg-gray-50';
                }
            });

            if (currentView === 'history') {
                document.getElementById('historySelector').classList.remove('hidden');
                document.getElementById('addRecordBtn').classList.add('hidden');
                document.getElementById('exportBtn').classList.remove('hidden');
                buildHistorySelector();
            } else {
                document.getElementById('historySelector').classList.add('hidden');
                document.getElementById('addRecordBtn').classList.remove('hidden');
                document.getElementById('exportBtn').classList.add('hidden');
                selectedPeriod = null;
            }
        }

        function buildHistorySelector() {
            const container = document.getElementById('historyYearList');
            container.innerHTML = '';

            const grouped = {};
            records.forEach(record => {
                const date = new Date(record.date);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                
                if (!grouped[year]) grouped[year] = {};
                if (!grouped[year][month]) grouped[year][month] = [];
                grouped[year][month].push(record);
            });

            Object.keys(grouped)
                .sort((a, b) => parseInt(b) - parseInt(a))
                .forEach(year => {
                    const yearDiv = document.createElement('div');
                    
                    const yearBtn = document.createElement('button');
                    yearBtn.className = 'flex items-center gap-2 w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg';
                    yearBtn.onclick = () => toggleYear(parseInt(year));
                    
                    const completedCount = Object.values(grouped[year]).flat().filter(r => r.status === 'completed').length;
                    const pendingCount = Object.values(grouped[year]).flat().filter(r => r.status === 'pending').length;
                    
                    yearBtn.innerHTML = `
                        <div class="flex items-center justify-between w-full">
                            <div class="flex items-center gap-2">
                                <i data-lucide="${expandedYears.has(parseInt(year)) ? 'chevron-down' : 'chevron-right'}" class="icon"></i>
                                <span class="font-medium">${year}年</span>
                            </div>
                            <div class="flex gap-2 text-xs">
                                <span class="px-2 py-1 bg-green-100 text-green-700 rounded">已完成: ${completedCount}</span>
                                <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded">未修: ${pendingCount}</span>
                            </div>
                        </div>
                    `;
                    
                    yearDiv.appendChild(yearBtn);
                    
                    if (expandedYears.has(parseInt(year))) {
                        const monthsDiv = document.createElement('div');
                        monthsDiv.className = 'ml-6 space-y-1';
                        
                        Object.keys(grouped[year])
                            .sort((a, b) => parseInt(b) - parseInt(a))
                            .forEach(month => {
                                const monthBtn = document.createElement('button');
                                const isSelected = selectedPeriod?.year === parseInt(year) && selectedPeriod?.month === parseInt(month);
                                monthBtn.className = `block w-full text-left px-3 py-2 rounded-lg transition-colors ${
                                    isSelected ? 'bg-blue-100 text-blue-800' : 'hover:bg-gray-50'
                                }`;
                                monthBtn.onclick = () => selectPeriod(parseInt(year), parseInt(month));
                                
                                const monthCompleted = grouped[year][month].filter(r => r.status === 'completed').length;
                                const monthPending = grouped[year][month].filter(r => r.status === 'pending').length;
                                
                                monthBtn.innerHTML = `
                                    <div class="flex items-center justify-between w-full">
                                        <span>${getMonthName(parseInt(month))} (${grouped[year][month].length}筆)</span>
                                        <div class="flex gap-2 text-xs">
                                            <span class="px-2 py-1 bg-green-100 text-green-700 rounded">已完成: ${monthCompleted}</span>
                                            <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded">未修: ${monthPending}</span>
                                        </div>
                                    </div>
                                `;
                                
                                monthsDiv.appendChild(monthBtn);
                            });
                        
                        yearDiv.appendChild(monthsDiv);
                    }
                    
                    container.appendChild(yearDiv);
                });
            
            lucide.createIcons();
        }

        function toggleYear(year) {
            if (expandedYears.has(year)) {
                expandedYears.delete(year);
            } else {
                expandedYears.add(year);
            }
            buildHistorySelector();
        }

        function selectPeriod(year, month) {
            selectedPeriod = { year, month };
            buildHistorySelector();
            filterRecords();
        }

        function getMonthName(month) {
            const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
            return monthNames[month - 1];
        }

        // ==================== 記錄操作函數 ====================
        function filterRecords() {
            let recordsToFilter = records;

            if (currentView === 'current') {
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth() + 1;
                
                recordsToFilter = records.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.getFullYear() === currentYear && 
                           recordDate.getMonth() + 1 === currentMonth;
                });
            } else if (currentView === 'history' && selectedPeriod) {
                recordsToFilter = records.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.getFullYear() === selectedPeriod.year && 
                           recordDate.getMonth() + 1 === selectedPeriod.month;
                });
            } else if (currentView === 'history' && !selectedPeriod) {
                recordsToFilter = [];
            }

            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const technicianFilter = document.getElementById('technicianFilter').value;

            filteredRecords = recordsToFilter.filter(record => {
                const matchesSearch = 
                    record.registrationData.toLowerCase().includes(searchTerm) ||
                    record.model.toLowerCase().includes(searchTerm) ||
                    record.sequence.includes(searchTerm) ||
                    record.repairItem.toLowerCase().includes(searchTerm);
                
                const matchesStatus = statusFilter === 'all' || record.status === statusFilter;
                const matchesTechnician = technicianFilter === 'all' || record.technician === technicianFilter;
                
                return matchesSearch && matchesStatus && matchesTechnician;
            });

            renderRecords();
            updateStats();
            updateBulkActionsVisibility();
        }

        function renderRecords() {
            const tbody = document.getElementById('recordsTable');
            const noRecords = document.getElementById('noRecords');
            const tableHeader = document.getElementById('tableHeader');

            if (filteredRecords.length === 0) {
                tbody.innerHTML = '';
                noRecords.classList.remove('hidden');
                return;
            }

            noRecords.classList.add('hidden');

            if (showBulkActions) {
                if (!tableHeader.querySelector('.bulk-checkbox')) {
                    const checkboxTh = document.createElement('th');
                    checkboxTh.className = 'bulk-checkbox px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12';
                    checkboxTh.innerHTML = '<input type="checkbox" id="headerCheckbox" class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">';
                    tableHeader.insertBefore(checkboxTh, tableHeader.firstChild);
                    
                    document.getElementById('headerCheckbox').addEventListener('change', toggleSelectAll);
                }
            } else {
                const checkboxTh = tableHeader.querySelector('.bulk-checkbox');
                if (checkboxTh) checkboxTh.remove();
            }

            tbody.innerHTML = filteredRecords.map(record => `
                <tr class="hover:bg-gray-50 transition-colors cursor-pointer" onclick="toggleRowExpansion('${record.id}')">
                    ${showBulkActions ? `
                        <td class="px-4 py-4 whitespace-nowrap" onclick="event.stopPropagation()">
                            <input type="checkbox" class="record-checkbox w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" 
                                   data-id="${record.id}" ${selectedRecords.has(record.id) ? 'checked' : ''}>
                        </td>
                    ` : ''}
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                        <div class="flex items-center gap-2">
                            <i data-lucide="chevron-right" class="icon text-gray-400 expand-icon" data-id="${record.id}"></i>
                            ${record.date}
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${record.registrationData}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${record.model}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${record.sequence}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                        <div class="flex items-center gap-2">
                            <i data-lucide="user" class="icon text-gray-400"></i>
                            ${record.technician}
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm" onclick="event.stopPropagation()">
                        <div class="flex items-center gap-2">
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${
                                record.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'
                            }">
                                <i data-lucide="${record.status === 'completed' ? 'check-circle' : 'x'}" class="w-3 h-3"></i>
                                ${record.status === 'completed' ? '已完成' : '未修'}
                            </span>
                            <button onclick="editRecord('${record.id}')" class="p-1 text-blue-600 hover:text-blue-800 transition-colors" title="編輯">
                                <i data-lucide="edit-2" class="icon"></i>
                            </button>
                            <button onclick="deleteRecord('${record.id}')" class="p-1 text-red-600 hover:text-red-800 transition-colors" title="刪除">
                                <i data-lucide="trash-2" class="icon"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                <tr id="details-${record.id}" class="bg-gray-50 hidden">
                    <td colspan="${showBulkActions ? '7' : '6'}" class="px-4 py-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">維修項目</label>
                                <div class="p-3 bg-white border border-gray-200 rounded-lg text-sm text-gray-900">
                                    ${record.repairItem || '無'}
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">補充</label>
                                <div class="p-3 bg-white border border-gray-200 rounded-lg text-sm text-gray-600">
                                    ${record.supplement || '無'}
                                </div>
                            </div>
                            ${record.previousRecordId ? `
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">歷史記錄</label>
                                    <button onclick="jumpToPreviousRecord('${record.previousRecordId}')" 
                                            class="w-full px-3 py-2 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-700 hover:bg-blue-100 transition-colors flex items-center justify-center gap-2">
                                        <i data-lucide="calendar" class="icon"></i>
                                        查看上次記錄
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');

            lucide.createIcons();

            document.querySelectorAll('.record-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const id = e.target.dataset.id;
                    if (e.target.checked) {
                        selectedRecords.add(id);
                    } else {
                        selectedRecords.delete(id);
                    }
                    updateBulkActionsStatus();
                });
            });
        }

        function updateStats() {
            const pendingCount = filteredRecords.filter(r => r.status === 'pending').length;
            const completedCount = filteredRecords.filter(r => r.status === 'completed').length;
            
            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('completedCount').textContent = completedCount;
        }

        // ==================== 新增/編輯/刪除記錄 ====================
        function showAddRecordModal() {
            document.getElementById('addRecordModal').classList.remove('hidden');
            document.getElementById('addRecordForm').reset();
            document.getElementById('recordDate').value = new Date().toISOString().split('T')[0];
        }

        function hideAddRecordModal() {
            document.getElementById('addRecordModal').classList.add('hidden');
        }

        async function handleAddRecord(e) {
            e.preventDefault();
            
            const formData = {
                date: document.getElementById('recordDate').value,
                registrationData: document.getElementById('recordRegistration').value,
                model: document.getElementById('recordModel').value,
                sequence: document.getElementById('recordSequence').value,
                repairItem: document.getElementById('recordRepairItem').value,
                supplement: document.getElementById('recordSupplement').value,
                technician: document.getElementById('recordTechnician').value,
                status: document.getElementById('recordStatus').value,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            console.log('新增記錄:', formData);

            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            
            const existingRecord = records.find(r => 
                r.model === formData.model && 
                r.sequence === formData.sequence && 
                formData.model.trim() !== '' && 
                formData.sequence.trim() !== '' &&
                new Date(r.date) >= oneYearAgo
            );
            
            if (existingRecord) {
                const lastDate = existingRecord.date;
                formData.supplement = formData.supplement ? 
                    `${formData.supplement} (上次: ${lastDate})` : 
                    `上次: ${lastDate}`;
                formData.previousRecordId = existingRecord.id;
            }

            let success = true;
            if (isOnlineMode) {
                updateCloudStatus('syncing', '上傳中...');
                success = await addToFirebase(formData);
                if (success) {
                    updateCloudStatus('online', '雲端同步 (即時)');
                } else {
                    updateCloudStatus('offline', '上傳失敗');
                }
            } else {
                const newId = 'record_' + Date.now();
                const newRecord = { id: newId, ...formData };
                records.unshift(newRecord);
                saveToLocalStorage();
                filterRecords();
            }

            if (success) {
                hideAddRecordModal();
                showSuccessNotification('記錄新增成功！');
            } else {
                alert('新增失敗，請檢查網路連線');
            }
        }

        async function updateRecordStatus(id, newStatus) {
            const recordIndex = records.findIndex(r => r.id === id);
            if (recordIndex === -1) return;

            if (isOnlineMode) {
                updateCloudStatus('syncing', '更新中...');
                const success = await updateInFirebase(id, { 
                    status: newStatus,
                    updatedAt: new Date().toISOString()
                });
                if (success) {
                    updateCloudStatus('online', '雲端同步 (即時)');
                    showSuccessNotification('狀態更新成功！');
                } else {
                    updateCloudStatus('offline', '更新失敗');
                    alert('更新失敗，請檢查網路連線');
                }
            } else {
                const oldRecord = records[recordIndex];
                records[recordIndex] = { ...oldRecord, status: newStatus };
                saveToLocalStorage();
                filterRecords();
                showSuccessNotification('狀態更新成功！');
            }
        }

        async function deleteRecord(id) {
            if (!confirm('確定要刪除此記錄嗎？')) return;

            if (isOnlineMode) {
                updateCloudStatus('syncing', '刪除中...');
                const success = await deleteFromFirebase(id);
                if (success) {
                    updateCloudStatus('online', '雲端同步 (即時)');
                    showSuccessNotification('記錄刪除成功！');
                } else {
                    updateCloudStatus('offline', '刪除失敗');
                    alert('刪除失敗，請檢查網路連線');
                }
            } else {
                const recordIndex = records.findIndex(r => r.id === id);
                if (recordIndex !== -1) {
                    records.splice(recordIndex, 1);
                    saveToLocalStorage();
                    selectedRecords.delete(id);
                    filterRecords();
                    showSuccessNotification('記錄刪除成功！');
                }
            }
        }

        // ==================== 批量操作 ====================
        function toggleBulkActions() {
            showBulkActions = !showBulkActions;
            updateBulkActionsVisibility();
            renderRecords();
        }

        function updateBulkActionsVisibility() {
            const bulkBtn = document.getElementById('bulkActionsBtn');
            const bulkPanel = document.getElementById('bulkActionsPanel');
            
            if (filteredRecords.length > 0) {
                bulkBtn.classList.remove('hidden');
            } else {
                bulkBtn.classList.add('hidden');
                showBulkActions = false;
            }

            if (showBulkActions) {
                bulkBtn.className = 'flex items-center gap-2 px-4 py-2 rounded-lg transition-colors border bg-orange-600 text-white border-orange-600';
                bulkPanel.classList.remove('hidden');
            } else {
                bulkBtn.className = 'flex items-center gap-2 px-4 py-2 rounded-lg transition-colors border bg-white text-gray-700 border-gray-300 hover:bg-gray-50';
                bulkPanel.classList.add('hidden');
            }

            updateBulkActionsStatus();
        }

        function updateBulkActionsStatus() {
            const selectAllText = document.getElementById('selectAllText');
            const selectedCount = document.getElementById('selectedCount');
            const bulkButtons = document.getElementById('bulkButtons');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const headerCheckbox = document.getElementById('headerCheckbox');

            selectAllText.textContent = `全選 (${selectedRecords.size}/${filteredRecords.length})`;

            if (selectedRecords.size > 0) {
                selectedCount.textContent = `已選擇 ${selectedRecords.size} 筆記錄`;
                selectedCount.classList.remove('hidden');
                bulkButtons.classList.remove('hidden');
            } else {
                selectedCount.classList.add('hidden');
                bulkButtons.classList.add('hidden');
            }

            const allSelected = selectedRecords.size === filteredRecords.length && filteredRecords.length > 0;
            if (selectAllCheckbox) selectAllCheckbox.checked = allSelected;
            if (headerCheckbox) headerCheckbox.checked = allSelected;
        }

        function toggleSelectAll() {
            if (selectedRecords.size === filteredRecords.length) {
                selectedRecords.clear();
            } else {
                selectedRecords = new Set(filteredRecords.map(r => r.id));
            }
            renderRecords();
            updateBulkActionsStatus();
        }

        async function bulkUpdateStatus(newStatus) {
            if (selectedRecords.size === 0) return;

            if (!confirm(`確定要將選中的 ${selectedRecords.size} 筆記錄標記為 ${newStatus === 'completed' ? '已完成' : '未修'}？`)) return;

            if (isOnlineMode) {
                updateCloudStatus('syncing', '批量更新中...');
                let allSuccess = true;
                
                for (const id of selectedRecords) {
                    const success = await updateInFirebase(id, { 
                        status: newStatus,
                        updatedAt: new Date().toISOString()
                    });
                    if (!success) allSuccess = false;
                }

                if (allSuccess) {
                    updateCloudStatus('online', '雲端同步 (即時)');
                    showSuccessNotification(`已更新 ${selectedRecords.size} 筆記錄！`);
                } else {
                    updateCloudStatus('offline', '部分更新失敗');
                    alert('部分更新失敗，請檢查網路連線');
                }
            } else {
                selectedRecords.forEach(id => {
                    const recordIndex = records.findIndex(r => r.id === id);
                    if (recordIndex !== -1) {
                        records[recordIndex].status = newStatus;
                    }
                });
                saveToLocalStorage();
                filterRecords();
                showSuccessNotification(`已更新 ${selectedRecords.size} 筆記錄！`);
            }

            selectedRecords.clear();
            showBulkActions = false;
            updateBulkActionsVisibility();
        }

        async function bulkDeleteRecords() {
            if (selectedRecords.size === 0) return;

            if (!confirm(`確定要刪除選中的 ${selectedRecords.size} 筆記錄嗎？`)) return;

            const idsToDelete = Array.from(selectedRecords);

            if (isOnlineMode) {
                updateCloudStatus('syncing', '批量刪除中...');
                let allSuccess = true;
                
                for (const id of idsToDelete) {
                    const success = await deleteFromFirebase(id);
                    if (!success) allSuccess = false;
                }

                if (allSuccess) {
                    updateCloudStatus('online', '雲端同步 (即時)');
                    showSuccessNotification(`已刪除 ${idsToDelete.length} 筆記錄！`);
                } else {
                    updateCloudStatus('offline', '部分刪除失敗');
                    alert('部分刪除失敗，請檢查網路連線');
                }
            } else {
                idsToDelete.forEach(id => {
                    const recordIndex = records.findIndex(r => r.id === id);
                    if (recordIndex !== -1) {
                        records.splice(recordIndex, 1);
                    }
                });
                saveToLocalStorage();
                filterRecords();
                showSuccessNotification(`已刪除 ${idsToDelete.length} 筆記錄！`);
            }

            selectedRecords.clear();
            showBulkActions = false;
            updateBulkActionsVisibility();
        }

        // ==================== 匯出功能 ====================
        function toggleExportMenu() {
            const menu = document.getElementById('exportMenu');
            menu.classList.toggle('hidden');
        }

        function exportToCSV() {
            const headers = ['日期', '登記資料', '品牌機型', '序號', '維修項目', '補充', '技術員', '狀態'];
            const csvData = [
                headers.join(','),
                ...filteredRecords.map(record => [
                    record.date,
                    `"${record.registrationData}"`,
                    `"${record.model}"`,
                    record.sequence,
                    `"${record.repairItem}"`,
                    `"${record.supplement}"`,
                    record.technician,
                    record.status === 'completed' ? '已完成' : '未修'
                ].join(','))
            ].join('\n');

            downloadFile(csvData, `維修記錄_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
            document.getElementById('exportMenu').classList.add('hidden');
        }

        function exportStatistics() {
            const totalRecords = filteredRecords.length;
            const completedRecords = filteredRecords.filter(r => r.status === 'completed').length;
            const pendingRecords = filteredRecords.filter(r => r.status === 'pending').length;
            const completionRate = totalRecords > 0 ? ((completedRecords / totalRecords) * 100).toFixed(1) : 0;
            
            const technicianStats = {};
            filteredRecords.forEach(record => {
                if (!technicianStats[record.technician]) {
                    technicianStats[record.technician] = { total: 0, completed: 0, pending: 0 };
                }
                technicianStats[record.technician].total++;
                if (record.status === 'completed') {
                    technicianStats[record.technician].completed++;
                } else {
                    technicianStats[record.technician].pending++;
                }
            });

            const modelStats = {};
            filteredRecords.forEach(record => {
                if (!modelStats[record.model]) {
                    modelStats[record.model] = 0;
                }
                modelStats[record.model]++;
            });

            const reportContent = `維修記錄統計報表
生成時間: ${new Date().toLocaleString('zh-TW')}
查看期間: ${currentView === 'current' ? '本月記錄' : selectedPeriod ? `${selectedPeriod.year}年${selectedPeriod.month}月` : '歷史記錄'}

=== 總體統計 ===
總記錄數: ${totalRecords}
已完成: ${completedRecords}
未修: ${pendingRecords}
完成率: ${completionRate}%

=== 技術員統計 ===
${Object.entries(technicianStats).map(([tech, stats]) => 
  `${tech}: 總數${stats.total} (已完成${stats.completed}, 未修${stats.pending})`
).join('\n')}

=== 品牌機型統計 ===
${Object.entries(modelStats)
  .sort((a, b) => b[1] - a[1])
  .map(([model, count]) => `${model}: ${count}次`)
  .join('\n')}`;

            downloadFile(reportContent, `維修統計報表_${new Date().toISOString().split('T')[0]}.txt`, 'text/plain');
            document.getElementById('exportMenu').classList.add('hidden');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob(['\uFEFF' + content], { type: mimeType + ';charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // ==================== 輔助函數 ====================
        function syncData() {
            console.log('手動同步資料');
            if (isOnlineMode) {
                updateCloudStatus('syncing', '同步中...');
                
                if (unsubscribe) {
                    showSuccessNotification('資料已是最新狀態！');
                    updateCloudStatus('online', '雲端同步 (即時)');
                } else {
                    setupRealtimeListener();
                }
            } else {
                alert('請先設定 Firebase 才能使用雲端同步功能');
            }
        }

        function showUpdateNotification() {
            const notification = document.createElement('div');
            notification.className = 'notification fixed bottom-4 right-4 bg-green-100 text-green-800 px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 z-50';
            notification.innerHTML = `
                <i data-lucide="refresh-cw" class="icon animate-spin"></i>
                <span>資料已更新</span>
            `;
            document.body.appendChild(notification);
            lucide.createIcons();
            
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        function showSuccessNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification fixed top-20 right-4 bg-blue-100 text-blue-800 px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 z-50';
            notification.innerHTML = `
                <i data-lucide="check-circle" class="icon"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            lucide.createIcons();
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function toggleRowExpansion(id) {
            const detailsRow = document.getElementById(`details-${id}`);
            const expandIcon = document.querySelector(`[data-id="${id}"].expand-icon`);
            
            if (detailsRow.classList.contains('hidden')) {
                document.querySelectorAll('[id^="details-"]').forEach(row => {
                    row.classList.add('hidden');
                });
                document.querySelectorAll('.expand-icon').forEach(icon => {
                    icon.setAttribute('data-lucide', 'chevron-right');
                });
                
                detailsRow.classList.remove('hidden');
                expandIcon.setAttribute('data-lucide', 'chevron-down');
            } else {
                detailsRow.classList.add('hidden');
                expandIcon.setAttribute('data-lucide', 'chevron-right');
            }
            
            lucide.createIcons();
        }

        function editRecord(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;

            const newStatus = record.status === 'pending' ? 'completed' : 'pending';
            
            if (confirm(`將記錄狀態改為 ${newStatus === 'completed' ? '已完成' : '未修'}？`)) {
                updateRecordStatus(id, newStatus);
            }
        }

        function jumpToPreviousRecord(recordId) {
            const targetRecord = records.find(r => r.id === recordId);
            if (!targetRecord) return;

            const recordDate = new Date(targetRecord.date);
            const year = recordDate.getFullYear();
            const month = recordDate.getMonth() + 1;
            
            const currentDate = new Date();
            if (year === currentDate.getFullYear() && month === currentDate.getMonth() + 1) {
                switchView('current');
            } else {
                switchView('history');
                expandedYears.add(year);
                selectedPeriod = { year, month };
                buildHistorySelector();
                filterRecords();
            }
            
            setTimeout(() => {
                toggleRowExpansion(recordId);
                const element = document.getElementById(`details-${recordId}`);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 500);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ==================== 全域函數（供 onclick 使用）====================
        window.toggleRowExpansion = toggleRowExpansion;
        window.editRecord = editRecord;
        window.deleteRecord = deleteRecord;
        window.jumpToPreviousRecord = jumpToPreviousRecord;

        // ==================== 清理和網路監測 ====================
        window.addEventListener('beforeunload', () => {
            if (unsubscribe) {
                unsubscribe();
            }
        });

        window.addEventListener('online', () => {
            console.log('網路已連接');
            if (isOnlineMode && !unsubscribe) {
                setupRealtimeListener();
            }
        });

        window.addEventListener('offline', () => {
            console.log('網路已斷開');
            updateCloudStatus('offline', '離線模式');
        });
    </script>
</body>
</html>
