<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>維修記錄管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, getDocs, query, orderBy, onSnapshot, enableNetwork, disableNetwork } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase 配置 - 請替換為你的 Firebase 項目配置
        const firebaseConfig = {
            apiKey: "AIzaSyCbaX3ou68Xu4wOQe01X_czS_QvtUtmVaE",
            authDomain: "shfix-ae293.firebaseapp.com",
            projectId: "shfix-ae293",
            storageBucket: "shfix-ae293.firebasestorage.app",
            messagingSenderId: "786004133871",
            appId: "1:786004133871:web:fc777aabac9d9e8fe0d81a"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // 將 Firebase 實例掛載到 window 對象
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseModules = {
            signInAnonymously,
            onAuthStateChanged,
            signOut,
            collection,
            addDoc,
            updateDoc,
            deleteDoc,
            doc,
            getDocs,
            query,
            orderBy,
            onSnapshot,
            enableNetwork,
            disableNetwork
        };
    </script>
    
    <style>
        .icon { width: 16px; height: 16px; display: inline-block; }
        .icon-lg { width: 20px; height: 20px; display: inline-block; }
        .icon-xl { width: 32px; height: 32px; display: inline-block; }
        button:focus:not(:focus-visible) { outline: none; }
        button:focus-visible { outline: 2px solid #3B82F6; outline-offset: 2px; }
        .notification { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .sync-indicator {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 雲端狀態指示器 -->
    <div id="cloudStatus" class="fixed top-4 right-4 z-50 px-3 py-2 rounded-lg text-sm font-medium shadow-lg bg-gray-100 text-gray-800">
        <div class="flex items-center gap-2">
            <span id="cloudIcon">☁️</span>
            <span id="cloudText">連線中...</span>
        </div>
    </div>

    <!-- 登入狀態指示器 -->
    <div id="authStatus" class="fixed top-4 left-4 z-50 px-3 py-2 rounded-lg text-sm font-medium shadow-lg bg-blue-100 text-blue-800 hidden">
        <div class="flex items-center gap-2">
            <span>👤</span>
            <span id="authText">未登入</span>
            <button id="signOutBtn" class="ml-2 text-xs underline hover:no-underline hidden">登出</button>
        </div>
    </div>

    <div class="min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            <!-- 標題區域 -->
            <div class="mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 mb-2 flex items-center gap-3">
                            維修記錄管理系統
                            <span id="syncIndicator" class="hidden sync-indicator">🔄</span>
                        </h1>
                        <p class="text-gray-600">設備維修記錄追蹤與管理 - 雲端同步版本</p>
                    </div>
                    <div class="flex gap-3">
                        <button id="syncBtn" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            🔄 手動同步
                        </button>
                        <button id="settingsBtn" class="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                            ⚙️ 系統設定
                        </button>
                    </div>
                </div>
            </div>

            <!-- 視圖切換按鈕 -->
            <div class="bg-white rounded-lg shadow-sm border p-4 mb-6">
                <div class="flex justify-center">
                    <div class="flex gap-3">
                        <button id="currentViewBtn" class="flex items-center gap-2 px-6 py-3 rounded-lg transition-colors border view-btn bg-blue-600 text-white border-blue-600" data-view="current">
                            🏠 本月記錄
                        </button>
                        <button id="historyViewBtn" class="flex items-center gap-2 px-6 py-3 rounded-lg transition-colors border view-btn bg-white text-gray-700 border-gray-300 hover:bg-gray-50" data-view="history">
                            📁 歷史記錄
                        </button>
                    </div>
                </div>
            </div>

            <!-- 歷史記錄年月選擇器 -->
            <div id="historySelector" class="bg-white rounded-lg shadow-sm border p-4 mb-6 hidden">
                <h3 class="text-lg font-medium text-gray-900 mb-4">選擇查看期間</h3>
                <div id="historyYearList" class="space-y-2"></div>
            </div>

            <!-- 操作工具列 -->
            <div class="bg-white rounded-lg shadow-sm border p-4 mb-6">
                <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
                    <!-- 搜尋區域 -->
                    <div class="flex-1 max-w-md">
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">🔍</span>
                            <input id="searchInput" type="text" placeholder="搜尋登記資料、機型、序號或維修項目..." 
                                   class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>

                    <!-- 控制按鈕 -->
                    <div class="flex gap-3 flex-wrap">
                        <select id="statusFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="all">所有狀態</option>
                            <option value="pending">未修</option>
                            <option value="completed">已完成</option>
                        </select>

                        <select id="technicianFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="all">所有技術員</option>
                        </select>

                        <button id="addRecordBtn" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            ➕ 新增記錄
                        </button>

                        <button id="exportBtn" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors hidden">
                            📥 匯出報表
                        </button>

                        <button id="bulkActionsBtn" class="flex items-center gap-2 px-4 py-2 rounded-lg transition-colors border bg-white text-gray-700 border-gray-300 hover:bg-gray-50 hidden">
                            ⚙️ 批量操作
                        </button>
                    </div>
                </div>
            </div>

            <!-- 批量操作工具列 -->
            <div id="bulkActionsPanel" class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6 hidden">
                <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input id="selectAllCheckbox" type="checkbox" class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                            <span id="selectAllText" class="text-sm font-medium text-gray-700">全選 (0/0)</span>
                        </label>
                        <span id="selectedCount" class="text-sm text-orange-600 hidden">已選擇 0 筆記錄</span>
                    </div>
                    
                    <div id="bulkButtons" class="flex gap-2 hidden">
                        <button id="bulkCompleteBtn" class="flex items-center gap-2 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                            ✓ 標記已完成
                        </button>
                        <button id="bulkPendingBtn" class="flex items-center gap-2 px-3 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors text-sm">
                            ✗ 標記未修
                        </button>
                        <button id="bulkDeleteBtn" class="flex items-center gap-2 px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">
                            🗑️ 批量刪除
                        </button>
                    </div>
                </div>
            </div>

            <!-- 統計卡片 -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow-sm border p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">未修</p>
                            <p id="pendingCount" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                        <span class="text-3xl">✗</span>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm border p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">已完成</p>
                            <p id="completedCount" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                        <span class="text-3xl">✓</span>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm border p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">雲端記錄</p>
                            <p id="cloudRecordCount" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                        <span class="text-3xl">☁️</span>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm border p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">同步狀態</p>
                            <p id="syncStatus" class="text-sm font-bold text-green-600">已同步</p>
                        </div>
                        <span id="syncStatusIcon" class="text-3xl">✅</span>
                    </div>
                </div>
            </div>

            <!-- 記錄表格 -->
            <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b">
                            <tr id="tableHeader">
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">登記資料</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">品牌機型</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">序號</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">技術員</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTable" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                    <div id="noRecords" class="text-center py-12 hidden">
                        <p class="text-gray-500">沒有維修記錄</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 設定頁面模態框 -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-900">系統設定</h3>
                    <button id="closeSettingsBtn" class="text-gray-400 hover:text-gray-600 text-2xl">
                        ×
                    </button>
                </div>

                <!-- Firebase 連線狀態 -->
                <div class="mb-8">
                    <h4 class="text-lg font-medium text-gray-900 mb-4 flex items-center gap-2">
                        ☁️ Firebase 雲端同步
                    </h4>
                    
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div>
                                <span class="font-medium">連線狀態</span>
                                <p class="text-sm text-gray-600" id="firebaseStatus">檢查中...</p>
                            </div>
                            <div class="flex gap-2">
                                <button id="reconnectBtn" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition-colors">
                                    重新連線
                                </button>
                                <button id="goOfflineBtn" class="px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700 transition-colors">
                                    離線模式
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div>
                                <span class="font-medium">自動同步</span>
                                <p class="text-sm text-gray-600">資料變更時自動上傳到雲端</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input id="autoSyncToggle" type="checkbox" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 技術員管理 -->
                <div class="mb-8">
                    <h4 class="text-lg font-medium text-gray-900 mb-4 flex items-center gap-2">
                        👥 技術員管理
                    </h4>
                    
                    <!-- 新增技術員 -->
                    <div class="mb-4">
                        <div class="flex gap-2">
                            <input id="newTechnicianInput" type="text" 
                                   placeholder="輸入新技術員名稱" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <button id="addTechnicianBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                ➕
                            </button>
                        </div>
                    </div>

                    <!-- 技術員列表 -->
                    <div id="techniciansList" class="space-y-2 max-h-60 overflow-y-auto">
                    </div>
                </div>

                <!-- 資料管理 -->
                <div class="mb-8">
                    <h4 class="text-lg font-medium text-gray-900 mb-4 flex items-center gap-2">
                        💾 資料管理
                    </h4>
                    
                    <div class="space-y-3">
                        <button id="forceSync" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            🔄 強制同步所有資料
                        </button>
                        
                        <button id="clearLocalDataBtn" class="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                            🗑️ 清除本地資料
                        </button>
                        
                        <p class="text-sm text-gray-600">
                            注意：清除本地資料後，將從雲端重新載入。如需完全刪除資料，請聯繫管理員。
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增記錄表單 -->
    <div id="addRecordModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">新增維修記錄</h3>
                <form id="addRecordForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">日期</label>
                            <input id="recordDate" type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">登記資料</label>
                            <input id="recordRegistration" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">品牌機型</label>
                            <input id="recordModel" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">序號</label>
                            <input id="recordSequence" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">維修項目</label>
                            <textarea id="recordRepairItem" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">補充</label>
                            <input id="recordSupplement" type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">技術員</label>
                            <select id="recordTechnician" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">狀態</label>
                            <select id="recordStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                <option value="pending">未修</option>
                                <option value="completed">已完成</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            新增記錄
                        </button>
                        <button type="button" id="cancelAddBtn" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            取消
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        // ==================== Firebase 相關變數 ====================
        let isOnline = navigator.onLine;
        let isFirebaseConnected = false;
        let autoSyncEnabled = true;
        let currentUser = null;
        let recordsListener = null;
        let techniciansListener = null;
        let pendingOperations = [];

        // ==================== 全域變數 ====================
        let records = [];
        let filteredRecords = [];
        let currentView = 'current';
        let selectedPeriod = null;
        let expandedYears = new Set();
        let selectedRecords = new Set();
        let showBulkActions = false;
        let technicians = ['曾', '李'];

        // ==================== 初始化 ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('系統初始化中...');
            
            // 設定今天的日期
            document.getElementById('recordDate').value = new Date().toISOString().split('T')[0];
            
            // 綁定事件監聽器
            bindEventListeners();
            
            // 監聽網路狀態
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
            
            // 初始化 Firebase
            setTimeout(initializeFirebase, 1000);
            
            // 載入本地資料（Firebase 未連線前的備用）
            loadLocalData();
            
            // 更新視圖
            updateCurrentView();
        });

        // ==================== Firebase 初始化 ====================
        async function initializeFirebase() {
            try {
                console.log('初始化 Firebase...');
                updateCloudStatus('connecting', '連線中...');
                
                // 身份驗證
                const { onAuthStateChanged, signInAnonymously } = window.firebaseModules;
                const auth = window.firebaseAuth;
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log('用戶已登入:', user.uid);
                        currentUser = user;
                        updateAuthStatus(true, user.uid);
                        await initializeFirestoreListeners();
                        updateCloudStatus('connected', '已連線');
                        isFirebaseConnected = true;
                        
                        // 執行待處理的操作
                        await processPendingOperations();
                    } else {
                        console.log('用戶未登入，嘗試匿名登入...');
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error('匿名登入失敗:', error);
                            handleFirebaseError(error);
                        }
                    }
                });
                
            } catch (error) {
                console.error('Firebase 初始化失敗:', error);
                handleFirebaseError(error);
            }
        }

        // ==================== Firestore 監聽器設置 ====================
        async function initializeFirestoreListeners() {
            try {
                const { collection, onSnapshot, query, orderBy } = window.firebaseModules;
                const db = window.firebaseDb;
                
                // 監聽維修記錄變化
                const recordsQuery = query(collection(db, 'repairRecords'), orderBy('createdAt', 'desc'));
                recordsListener = onSnapshot(recordsQuery, (snapshot) => {
                    console.log('收到 Firestore 記錄更新');
                    const cloudRecords = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        cloudRecords.push({
                            id: doc.id,
                            ...data,
                            firebaseId: doc.id
                        });
                    });
                    
                    // 合併雲端資料與本地資料
                    mergeCloudRecords(cloudRecords);
                    filterRecords();
                    updateCloudRecordCount(cloudRecords.length);
                }, (error) => {
                    console.error('記錄監聽錯誤:', error);
                    handleFirebaseError(error);
                });

                // 監聽技術員列表變化
                const techniciansQuery = query(collection(db, 'technicians'));
                techniciansListener = onSnapshot(techniciansQuery, (snapshot) => {
                    console.log('收到 Firestore 技術員更新');
                    const cloudTechnicians = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        cloudTechnicians.push(data.name);
                    });
                    
                    if (cloudTechnicians.length > 0) {
                        technicians = [...new Set([...technicians, ...cloudTechnicians])].sort();
                        saveTechniciansToLocal();
                        updateTechnicianOptions();
                    }
                }, (error) => {
                    console.error('技術員監聽錯誤:', error);
                    handleFirebaseError(error);
                });

            } catch (error) {
                console.error('設置 Firestore 監聽器失敗:', error);
                handleFirebaseError(error);
            }
        }

        // ==================== 雲端資料合併 ====================
        function mergeCloudRecords(cloudRecords) {
            const localIds = new Set(records.map(r => r.id));
            const cloudIds = new Set(cloudRecords.map(r => r.id));
            
            // 添加雲端獨有的記錄
            cloudRecords.forEach(cloudRecord => {
                if (!localIds.has(cloudRecord.id)) {
                    records.push(cloudRecord);
                }
            });
            
            // 更新已存在的記錄
            records = records.map(localRecord => {
                const cloudRecord = cloudRecords.find(cr => cr.id === localRecord.id);
                if (cloudRecord && cloudRecord.updatedAt && localRecord.updatedAt) {
                    // 比較更新時間，使用最新的版本
                    return new Date(cloudRecord.updatedAt) > new Date(localRecord.updatedAt) 
                        ? cloudRecord : localRecord;
                }
                return cloudRecord || localRecord;
            });
            
            saveToLocalStorage();
        }

        // ==================== Firebase 資料操作 ====================
        async function addRecordToFirebase(record) {
            if (!isFirebaseConnected || !currentUser) {
                addToPendingOperations('add', record);
                return null;
            }

            try {
                showSyncIndicator();
                const { collection, addDoc } = window.firebaseModules;
                const db = window.firebaseDb;
                
                const recordData = {
                    ...record,
                    userId: currentUser.uid,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                const docRef = await addDoc(collection(db, 'repairRecords'), recordData);
                console.log('記錄已上傳到 Firebase:', docRef.id);
                
                hideSyncIndicator();
                updateSyncStatus('已同步', true);
                return docRef.id;
            } catch (error) {
                console.error('上傳記錄失敗:', error);
                addToPendingOperations('add', record);
                handleFirebaseError(error);
                hideSyncIndicator();
                return null;
            }
        }

        async function updateRecordInFirebase(record) {
            if (!isFirebaseConnected || !currentUser || !record.firebaseId) {
                addToPendingOperations('update', record);
                return;
            }

            try {
                showSyncIndicator();
                const { doc, updateDoc } = window.firebaseModules;
                const db = window.firebaseDb;
                
                const recordData = {
                    ...record,
                    updatedAt: new Date().toISOString()
                };
                delete recordData.firebaseId;
                
                await updateDoc(doc(db, 'repairRecords', record.firebaseId), recordData);
                console.log('記錄已在 Firebase 中更新:', record.firebaseId);
                
                hideSyncIndicator();
                updateSyncStatus('已同步', true);
            } catch (error) {
                console.error('更新記錄失敗:', error);
                addToPendingOperations('update', record);
                handleFirebaseError(error);
                hideSyncIndicator();
            }
        }

        async function deleteRecordFromFirebase(firebaseId) {
            if (!isFirebaseConnected || !currentUser || !firebaseId) {
                addToPendingOperations('delete', { firebaseId });
                return;
            }

            try {
                showSyncIndicator();
                const { doc, deleteDoc } = window.firebaseModules;
                const db = window.firebaseDb;
                
                await deleteDoc(doc(db, 'repairRecords', firebaseId));
                console.log('記錄已從 Firebase 中刪除:', firebaseId);
                
                hideSyncIndicator();
                updateSyncStatus('已同步', true);
            } catch (error) {
                console.error('刪除記錄失敗:', error);
                addToPendingOperations('delete', { firebaseId });
                handleFirebaseError(error);
                hideSyncIndicator();
            }
        }

        async function syncTechniciansToFirebase() {
            if (!isFirebaseConnected || !currentUser) {
                return;
            }

            try {
                const { collection, getDocs, addDoc } = window.firebaseModules;
                const db = window.firebaseDb;
                
                // 獲取現有技術員
                const snapshot = await getDocs(collection(db, 'technicians'));
                const existingTechnicians = new Set();
                snapshot.forEach(doc => {
                    existingTechnicians.add(doc.data().name);
                });

                // 添加新技術員
                for (const techName of technicians) {
                    if (!existingTechnicians.has(techName)) {
                        await addDoc(collection(db, 'technicians'), {
                            name: techName,
                            userId: currentUser.uid,
                            createdAt: new Date().toISOString()
                        });
                        console.log('技術員已上傳:', techName);
                    }
                }
            } catch (error) {
                console.error('同步技術員失敗:', error);
                handleFirebaseError(error);
            }
        }

        // ==================== 待處理操作管理 ====================
        function addToPendingOperations(operation, data) {
            pendingOperations.push({
                operation,
                data,
                timestamp: new Date().toISOString()
            });
            updateSyncStatus('待同步', false);
            savePendingOperations();
        }

        async function processPendingOperations() {
            if (!isFirebaseConnected || pendingOperations.length === 0) {
                return;
            }

            console.log(`處理 ${pendingOperations.length} 個待處理操作`);
            showSyncIndicator();

            for (const op of pendingOperations) {
                try {
                    switch (op.operation) {
                        case 'add':
                            await addRecordToFirebase(op.data);
                            break;
                        case 'update':
                            await updateRecordInFirebase(op.data);
                            break;
                        case 'delete':
                            await deleteRecordFromFirebase(op.data.firebaseId);
                            break;
                    }
                } catch (error) {
                    console.error('處理待處理操作失敗:', error);
                }
            }

            pendingOperations = [];
            savePendingOperations();
            hideSyncIndicator();
            updateSyncStatus('已同步', true);
            showSuccessNotification('離線操作已同步到雲端！');
        }

        function savePendingOperations() {
            localStorage.setItem('pendingOperations', JSON.stringify(pendingOperations));
        }

        function loadPendingOperations() {
            const saved = localStorage.getItem('pendingOperations');
            if (saved) {
                pendingOperations = JSON.parse(saved);
            }
        }

        // ==================== 狀態更新函數 ====================
        function updateCloudStatus(status, text) {
            const cloudIcon = document.getElementById('cloudIcon');
            const cloudText = document.getElementById('cloudText');
            
            switch (status) {
                case 'connecting':
                    cloudIcon.textContent = '🔄';
                    cloudIcon.classList.add('sync-indicator');
                    document.getElementById('cloudStatus').className = 'fixed top-4 right-4 z-50 px-3 py-2 rounded-lg text-sm font-medium shadow-lg bg-yellow-100 text-yellow-800';
                    break;
                case 'connected':
                    cloudIcon.textContent = '☁️';
                    cloudIcon.classList.remove('sync-indicator');
                    document.getElementById('cloudStatus').className = 'fixed top-4 right-4 z-50 px-3 py-2 rounded-lg text-sm font-medium shadow-lg bg-green-100 text-green-800';
                    break;
                case 'offline':
                    cloudIcon.textContent = '📱';
                    cloudIcon.classList.remove('sync-indicator');
                    document.getElementById('cloudStatus').className = 'fixed top-4 right-4 z-50 px-3 py-2 rounded-lg text-sm font-medium shadow-lg bg-gray-100 text-gray-800';
                    break;
                case 'error':
                    cloudIcon.textContent = '⚠️';
                    cloudIcon.classList.remove('sync-indicator');
                    document.getElementById('cloudStatus').className = 'fixed top-4 right-4 z-50 px-3 py-2 rounded-lg text-sm font-medium shadow-lg bg-red-100 text-red-800';
                    break;
            }
            
            cloudText.textContent = text;
        }

        function updateAuthStatus(isLoggedIn, userId) {
            const authStatus = document.getElementById('authStatus');
            const authText = document.getElementById('authText');
            const signOutBtn = document.getElementById('signOutBtn');
            
            if (isLoggedIn) {
                authStatus.classList.remove('hidden');
                authText.textContent = `已登入 (${userId.substring(0, 8)}...)`;
                signOutBtn.classList.remove('hidden');
            } else {
                authStatus.classList.add('hidden');
                signOutBtn.classList.add('hidden');
            }
        }

        function updateSyncStatus(status, isGood) {
            document.getElementById('syncStatus').textContent = status;
            document.getElementById('syncStatusIcon').textContent = isGood ? '✅' : '⏳';
            document.getElementById('syncStatus').className = `text-sm font-bold ${isGood ? 'text-green-600' : 'text-orange-600'}`;
        }

        function updateCloudRecordCount(count) {
            document.getElementById('cloudRecordCount').textContent = count;
        }

        function showSyncIndicator() {
            document.getElementById('syncIndicator').classList.remove('hidden');
        }

        function hideSyncIndicator() {
            document.getElementById('syncIndicator').classList.add('hidden');
        }

        // ==================== 網路狀態處理 ====================
        function handleOnline() {
            console.log('網路已連線');
            isOnline = true;
            if (isFirebaseConnected) {
                updateCloudStatus('connected', '已連線');
                processPendingOperations();
            } else {
                initializeFirebase();
            }
        }

        function handleOffline() {
            console.log('網路已斷線');
            isOnline = false;
            updateCloudStatus('offline', '離線模式');
        }

        function handleFirebaseError(error) {
            console.error('Firebase 錯誤:', error);
            isFirebaseConnected = false;
            updateCloudStatus('error', '連線錯誤');
            
            // 根據錯誤類型顯示不同訊息
            if (error.code === 'permission-denied') {
                showErrorNotification('權限不足，請聯繫管理員');
            } else if (error.code === 'unavailable') {
                showErrorNotification('Firebase 服務暫時無法使用');
            } else {
                showErrorNotification('雲端同步發生錯誤，將使用離線模式');
            }
        }

        // ==================== 事件監聽器綁定 ====================
        function bindEventListeners() {
            // 設定按鈕
            document.getElementById('settingsBtn').addEventListener('click', showSettingsModal);
            document.getElementById('closeSettingsBtn').addEventListener('click', hideSettingsModal);
            
            // Firebase 相關按鈕
            document.getElementById('syncBtn').addEventListener('click', manualSync);
            document.getElementById('reconnectBtn').addEventListener('click', reconnectFirebase);
            document.getElementById('goOfflineBtn').addEventListener('click', goOffline);
            document.getElementById('forceSync').addEventListener('click', forceSync);
            document.getElementById('signOutBtn').addEventListener('click', signOutUser);
            
            // 自動同步開關
            document.getElementById('autoSyncToggle').addEventListener('change', function(e) {
                autoSyncEnabled = e.target.checked;
                localStorage.setItem('autoSyncEnabled', autoSyncEnabled);
                showSuccessNotification(autoSyncEnabled ? '自動同步已開啟' : '自動同步已關閉');
            });
            
            // 技術員管理
            document.getElementById('addTechnicianBtn').addEventListener('click', function() {
                const input = document.getElementById('newTechnicianInput');
                addTechnician(input.value);
                input.value = '';
            });
            
            document.getElementById('newTechnicianInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addTechnician(this.value);
                    this.value = '';
                }
            });
            
            // 清除本地資料
            document.getElementById('clearLocalDataBtn').addEventListener('click', function() {
                if (confirm('確定要清除所有本地資料嗎？系統將重新從雲端載入資料。')) {
                    clearLocalData();
                }
            });
            
            // 視圖切換按鈕
            document.getElementById('currentViewBtn').addEventListener('click', function() {
                switchView('current');
            });
            
            document.getElementById('historyViewBtn').addEventListener('click', function() {
                switchView('history');
            });

            // 搜尋和篩選
            document.getElementById('searchInput').addEventListener('input', debounce(filterRecords, 300));
            document.getElementById('statusFilter').addEventListener('change', filterRecords);
            document.getElementById('technicianFilter').addEventListener('change', filterRecords);

            // 新增記錄
            document.getElementById('addRecordBtn').addEventListener('click', showAddRecordModal);
            document.getElementById('cancelAddBtn').addEventListener('click', hideAddRecordModal);
            document.getElementById('addRecordForm').addEventListener('submit', handleAddRecord);

            // 批量操作
            document.getElementById('bulkActionsBtn').addEventListener('click', toggleBulkActions);
            document.getElementById('selectAllCheckbox').addEventListener('change', toggleSelectAll);
            document.getElementById('bulkCompleteBtn').addEventListener('click', () => bulkUpdateStatus('completed'));
            document.getElementById('bulkPendingBtn').addEventListener('click', () => bulkUpdateStatus('pending'));
            document.getElementById('bulkDeleteBtn').addEventListener('click', bulkDeleteRecords);

            // 匯出功能
            document.getElementById('exportBtn').addEventListener('click', exportToCSV);

            // 點擊外部關閉模態框
            document.getElementById('addRecordModal').addEventListener('click', function(e) {
                if (e.target.id === 'addRecordModal') {
                    hideAddRecordModal();
                }
            });
            
            document.getElementById('settingsModal').addEventListener('click', function(e) {
                if (e.target.id === 'settingsModal') {
                    hideSettingsModal();
                }
            });
        }

        // ==================== Firebase 操作函數 ====================
        async function manualSync() {
            if (!isFirebaseConnected) {
                await reconnectFirebase();
                return;
            }
            
            showSyncIndicator();
            await processPendingOperations();
            await syncTechniciansToFirebase();
            hideSyncIndicator();
            showSuccessNotification('手動同步完成！');
        }

        async function reconnectFirebase() {
            try {
                updateCloudStatus('connecting', '重新連線中...');
                const { enableNetwork } = window.firebaseModules;
                const db = window.firebaseDb;
                
                await enableNetwork(db);
                await initializeFirebase();
            } catch (error) {
                console.error('重新連線失敗:', error);
                handleFirebaseError(error);
            }
        }

        async function goOffline() {
            try {
                const { disableNetwork } = window.firebaseModules;
                const db = window.firebaseDb;
                
                await disableNetwork(db);
                isFirebaseConnected = false;
                updateCloudStatus('offline', '已切換到離線模式');
                showSuccessNotification('已切換到離線模式');
            } catch (error) {
                console.error('切換離線模式失敗:', error);
            }
        }

        async function forceSync() {
            if (!confirm('強制同步將覆蓋所有本地資料，確定要繼續嗎？')) {
                return;
            }
            
            try {
                showSyncIndicator();
                
                // 清除本地資料
                records = [];
                technicians = ['曾', '李'];
                
                // 重新從 Firebase 載入
                await loadDataFromFirebase();
                
                hideSyncIndicator();
                showSuccessNotification('強制同步完成！');
            } catch (error) {
                console.error('強制同步失敗:', error);
                hideSyncIndicator();
                showErrorNotification('強制同步失敗');
            }
        }

        async function loadDataFromFirebase() {
            if (!isFirebaseConnected) return;
            
            try {
                const { collection, getDocs, query, orderBy } = window.firebaseModules;
                const db = window.firebaseDb;
                
                // 載入記錄
                const recordsSnapshot = await getDocs(query(collection(db, 'repairRecords'), orderBy('createdAt', 'desc')));
                const cloudRecords = [];
                recordsSnapshot.forEach(doc => {
                    cloudRecords.push({
                        id: doc.id,
                        ...doc.data(),
                        firebaseId: doc.id
                    });
                });
                
                // 載入技術員
                const techniciansSnapshot = await getDocs(collection(db, 'technicians'));
                const cloudTechnicians = [];
                techniciansSnapshot.forEach(doc => {
                    cloudTechnicians.push(doc.data().name);
                });
                
                records = cloudRecords;
                if (cloudTechnicians.length > 0) {
                    technicians = [...new Set([...technicians, ...cloudTechnicians])].sort();
                }
                
                saveToLocalStorage();
                saveTechniciansToLocal();
                updateTechnicianOptions();
                filterRecords();
                
            } catch (error) {
                console.error('從 Firebase 載入資料失敗:', error);
                throw error;
            }
        }

        async function signOutUser() {
            if (!confirm('確定要登出嗎？')) return;
            
            try {
                const { signOut } = window.firebaseModules;
                const auth = window.firebaseAuth;
                
                await signOut(auth);
                currentUser = null;
                isFirebaseConnected = false;
                updateAuthStatus(false);
                updateCloudStatus('offline', '已登出');
                showSuccessNotification('已登出');
            } catch (error) {
                console.error('登出失敗:', error);
                showErrorNotification('登出失敗');
            }
        }

        function clearLocalData() {
            localStorage.clear();
            records = [];
            technicians = ['曾', '李'];
            pendingOperations = [];
            selectedRecords.clear();
            
            if (isFirebaseConnected) {
                loadDataFromFirebase();
            } else {
                filterRecords();
                updateTechnicianOptions();
            }
            
            showSuccessNotification('本地資料已清除');
        }

        // ==================== 資料載入函數 ====================
        function loadLocalData() {
            loadRecords();
            loadTechnicians();
            loadPendingOperations();
            
            // 載入自動同步設定
            const saved = localStorage.getItem('autoSyncEnabled');
            if (saved !== null) {
                autoSyncEnabled = JSON.parse(saved);
                document.getElementById('autoSyncToggle').checked = autoSyncEnabled;
            }
        }

        function loadRecords() {
            const saved = localStorage.getItem('repairRecords');
            if (saved) {
                records = JSON.parse(saved);
            } else {
                // 初始測試資料
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = (currentDate.getMonth() + 1).toString().padStart(2, '0');
                
                records = [
                    { 
                        id: '1', 
                        date: `${currentYear}-${currentMonth}-20`, 
                        registrationData: '測試客戶', 
                        model: 'MMA215', 
                        sequence: '11114', 
                        repairItem: '測試維修', 
                        supplement: '測試補充', 
                        technician: '曾', 
                        status: 'completed',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        id: '2', 
                        date: `${currentYear}-${currentMonth}-15`, 
                        registrationData: '測試客戶2', 
                        model: 'TIG200', 
                        sequence: '22222', 
                        repairItem: '測試維修2', 
                        supplement: '測試補充2', 
                        technician: '李', 
                        status: 'pending',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
                saveToLocalStorage();
            }
            filterRecords();
        }

        function saveToLocalStorage() {
            localStorage.setItem('repairRecords', JSON.stringify(records));
        }

        // ==================== 技術員管理函數 ====================
        function loadTechnicians() {
            const saved = localStorage.getItem('techniciansList');
            if (saved) {
                technicians = JSON.parse(saved);
            }
            updateTechnicianOptions();
        }

        function saveTechniciansToLocal() {
            localStorage.setItem('techniciansList', JSON.stringify(technicians));
        }

        function updateTechnicianOptions() {
            // 更新新增記錄表單的技術員選項
            const recordSelect = document.getElementById('recordTechnician');
            if (recordSelect) {
                const currentValue = recordSelect.value;
                recordSelect.innerHTML = technicians.map(tech => 
                    `<option value="${tech}">${tech}</option>`
                ).join('');
                
                if (technicians.includes(currentValue)) {
                    recordSelect.value = currentValue;
                }
            }

            // 更新篩選器的技術員選項
            const filterSelect = document.getElementById('technicianFilter');
            if (filterSelect) {
                const currentValue = filterSelect.value;
                filterSelect.innerHTML = '<option value="all">所有技術員</option>' + 
                    technicians.map(tech => 
                        `<option value="${tech}">${tech}</option>`
                    ).join('');
                
                if (technicians.includes(currentValue)) {
                    filterSelect.value = currentValue;
                } else {
                    filterSelect.value = 'all';
                }
            }

            // 更新設定頁面的技術員列表
            updateTechniciansListInSettings();
        }

        function updateTechniciansListInSettings() {
            const listContainer = document.getElementById('techniciansList');
            if (!listContainer) return;

            listContainer.innerHTML = technicians.map((tech, index) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                    <div class="flex items-center gap-3">
                        <span>👤</span>
                        <span class="font-medium">${tech}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="deleteTechnician(${index})" 
                                class="p-1 text-red-600 hover:text-red-800 transition-colors" 
                                title="刪除"
                                ${technicians.length <= 1 ? 'disabled' : ''}>
                            🗑️
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function addTechnician(name) {
            if (!name || name.trim() === '') {
                alert('請輸入技術員名稱');
                return;
            }

            name = name.trim();
            if (technicians.includes(name)) {
                alert('此技術員已存在');
                return;
            }

            technicians.push(name);
            technicians.sort();
            saveTechniciansToLocal();
            updateTechnicianOptions();
            
            // 同步到 Firebase
            if (autoSyncEnabled && isFirebaseConnected) {
                await syncTechniciansToFirebase();
            }
            
            showSuccessNotification('技術員新增成功！');
        }

        window.deleteTechnician = function(index) {
            if (technicians.length <= 1) {
                alert('至少需要保留一位技術員');
                return;
            }

            const techName = technicians[index];
            if (!confirm(`確定要刪除技術員「${techName}」嗎？`)) return;

            technicians.splice(index, 1);
            saveTechniciansToLocal();
            updateTechnicianOptions();
            showSuccessNotification('技術員刪除成功！');
        }

        // ==================== 視圖相關函數 ====================
        function switchView(view) {
            currentView = view;
            updateCurrentView();
            filterRecords();
        }

        function updateCurrentView() {
            document.querySelectorAll('.view-btn').forEach(btn => {
                if (btn.dataset.view === currentView) {
                    btn.className = 'flex items-center gap-2 px-6 py-3 rounded-lg transition-colors border bg-blue-600 text-white border-blue-600';
                } else {
                    btn.className = 'flex items-center gap-2 px-6 py-3 rounded-lg transition-colors border bg-white text-gray-700 border-gray-300 hover:bg-gray-50';
                }
            });

            if (currentView === 'history') {
                document.getElementById('historySelector').classList.remove('hidden');
                document.getElementById('addRecordBtn').classList.add('hidden');
                document.getElementById('exportBtn').classList.remove('hidden');
                buildHistorySelector();
            } else {
                document.getElementById('historySelector').classList.add('hidden');
                document.getElementById('addRecordBtn').classList.remove('hidden');
                document.getElementById('exportBtn').classList.add('hidden');
                selectedPeriod = null;
            }
        }

        function buildHistorySelector() {
            const container = document.getElementById('historyYearList');
            container.innerHTML = '';

            // 按年份分組
            const grouped = {};
            records.forEach(record => {
                const date = new Date(record.date);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                
                if (!grouped[year]) grouped[year] = {};
                if (!grouped[year][month]) grouped[year][month] = [];
                grouped[year][month].push(record);
            });

            // 建立年份列表
            Object.keys(grouped)
                .sort((a, b) => parseInt(b) - parseInt(a))
                .forEach(year => {
                    const yearDiv = document.createElement('div');
                    
                    // 年份按鈕
                    const yearBtn = document.createElement('button');
                    yearBtn.className = 'flex items-center gap-2 w-full text-left px-3 py-2 hover:bg-gray-50 rounded-lg';
                    yearBtn.onclick = () => toggleYear(parseInt(year));
                    
                    const completedCount = Object.values(grouped[year]).flat().filter(r => r.status === 'completed').length;
                    const pendingCount = Object.values(grouped[year]).flat().filter(r => r.status === 'pending').length;
                    
                    yearBtn.innerHTML = `
                        <div class="flex items-center justify-between w-full">
                            <div class="flex items-center gap-2">
                                <span>${expandedYears.has(parseInt(year)) ? '▼' : '▶'}</span>
                                <span class="font-medium">${year}年</span>
                            </div>
                            <div class="flex gap-2 text-xs">
                                <span class="px-2 py-1 bg-green-100 text-green-700 rounded">已完成: ${completedCount}</span>
                                <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded">未修: ${pendingCount}</span>
                            </div>
                        </div>
                    `;
                    
                    yearDiv.appendChild(yearBtn);
                    
                    // 月份列表
                    if (expandedYears.has(parseInt(year))) {
                        const monthsDiv = document.createElement('div');
                        monthsDiv.className = 'ml-6 space-y-1';
                        
                        Object.keys(grouped[year])
                            .sort((a, b) => parseInt(b) - parseInt(a))
                            .forEach(month => {
                                const monthBtn = document.createElement('button');
                                const isSelected = selectedPeriod?.year === parseInt(year) && selectedPeriod?.month === parseInt(month);
                                monthBtn.className = `block w-full text-left px-3 py-2 rounded-lg transition-colors ${
                                    isSelected ? 'bg-blue-100 text-blue-800' : 'hover:bg-gray-50'
                                }`;
                                monthBtn.onclick = () => selectPeriod(parseInt(year), parseInt(month));
                                
                                const monthCompleted = grouped[year][month].filter(r => r.status === 'completed').length;
                                const monthPending = grouped[year][month].filter(r => r.status === 'pending').length;
                                
                                monthBtn.innerHTML = `
                                    <div class="flex items-center justify-between w-full">
                                        <span>${parseInt(month)}月 (${grouped[year][month].length}筆)</span>
                                        <div class="flex gap-2 text-xs">
                                            <span class="px-2 py-1 bg-green-100 text-green-700 rounded">已完成: ${monthCompleted}</span>
                                            <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded">未修: ${monthPending}</span>
                                        </div>
                                    </div>
                                `;
                                
                                monthsDiv.appendChild(monthBtn);
                            });
                        
                        yearDiv.appendChild(monthsDiv);
                    }
                    
                    container.appendChild(yearDiv);
                });
        }

        function toggleYear(year) {
            if (expandedYears.has(year)) {
                expandedYears.delete(year);
            } else {
                expandedYears.add(year);
            }
            buildHistorySelector();
        }

        function selectPeriod(year, month) {
            selectedPeriod = { year, month };
            buildHistorySelector();
            filterRecords();
        }

        // ==================== 記錄操作函數 ====================
        function filterRecords() {
            let recordsToFilter = records;

            if (currentView === 'current') {
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth() + 1;
                
                recordsToFilter = records.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.getFullYear() === currentYear && 
                           recordDate.getMonth() + 1 === currentMonth;
                });
            } else if (currentView === 'history' && selectedPeriod) {
                recordsToFilter = records.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.getFullYear() === selectedPeriod.year && 
                           recordDate.getMonth() + 1 === selectedPeriod.month;
                });
            } else if (currentView === 'history' && !selectedPeriod) {
                recordsToFilter = [];
            }

            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const technicianFilter = document.getElementById('technicianFilter').value;

            filteredRecords = recordsToFilter.filter(record => {
                const matchesSearch = 
                    record.registrationData.toLowerCase().includes(searchTerm) ||
                    record.model.toLowerCase().includes(searchTerm) ||
                    record.sequence.includes(searchTerm) ||
                    record.repairItem.toLowerCase().includes(searchTerm);
                
                const matchesStatus = statusFilter === 'all' || record.status === statusFilter;
                const matchesTechnician = technicianFilter === 'all' || record.technician === technicianFilter;
                
                return matchesSearch && matchesStatus && matchesTechnician;
            });

            renderRecords();
            updateStats();
            updateBulkActionsVisibility();
        }

        function renderRecords() {
            const tbody = document.getElementById('recordsTable');
            const noRecords = document.getElementById('noRecords');
            const tableHeader = document.getElementById('tableHeader');

            if (filteredRecords.length === 0) {
                tbody.innerHTML = '';
                noRecords.classList.remove('hidden');
                return;
            }

            noRecords.classList.add('hidden');

            // 更新表格標題
            if (showBulkActions) {
                if (!tableHeader.querySelector('.bulk-checkbox')) {
                    const checkboxTh = document.createElement('th');
                    checkboxTh.className = 'bulk-checkbox px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12';
                    checkboxTh.innerHTML = '<input type="checkbox" id="headerCheckbox" class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">';
                    tableHeader.insertBefore(checkboxTh, tableHeader.firstChild);
                    
                    document.getElementById('headerCheckbox').addEventListener('change', toggleSelectAll);
                }
            } else {
                const checkboxTh = tableHeader.querySelector('.bulk-checkbox');
                if (checkboxTh) checkboxTh.remove();
            }

            // 渲染行
            tbody.innerHTML = filteredRecords.map(record => `
                <tr class="hover:bg-gray-50 transition-colors cursor-pointer" onclick="toggleRowExpansion('${record.id}')">
                    ${showBulkActions ? `
                        <td class="px-4 py-4 whitespace-nowrap" onclick="event.stopPropagation()">
                            <input type="checkbox" class="record-checkbox w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500" 
                                   data-id="${record.id}" ${selectedRecords.has(record.id) ? 'checked' : ''}>
                        </td>
                    ` : ''}
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                        <div class="flex items-center gap-2">
                            <span class="expand-icon" data-id="${record.id}">▶</span>
                            ${record.date}
                            ${record.firebaseId ? '<span class="text-green-600" title="已同步到雲端">☁️</span>' : '<span class="text-orange-600" title="僅存在本地">📱</span>'}
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${record.registrationData}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${record.model}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${record.sequence}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                        <div class="flex items-center gap-2">
                            <span>👤</span>
                            ${record.technician}
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm" onclick="event.stopPropagation()">
                        <div class="flex items-center gap-2">
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${
                                record.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'
                            }">
                                ${record.status === 'completed' ? '✓ 已完成' : '✗ 未修'}
                            </span>
                            <button onclick="editRecord('${record.id}')" class="p-1 text-blue-600 hover:text-blue-800 transition-colors" title="編輯">
                                ✏️
                            </button>
                            <button onclick="deleteRecord('${record.id}')" class="p-1 text-red-600 hover:text-red-800 transition-colors" title="刪除">
                                🗑️
                            </button>
                        </div>
                    </td>
                </tr>
                <tr id="details-${record.id}" class="bg-gray-50 hidden">
                    <td colspan="${showBulkActions ? '7' : '6'}" class="px-4 py-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">維修項目</label>
                                <div class="p-3 bg-white border border-gray-200 rounded-lg text-sm text-gray-900">
                                    ${record.repairItem || '無'}
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">補充</label>
                                <div class="p-3 bg-white border border-gray-200 rounded-lg text-sm text-gray-600">
                                    ${record.supplement || '無'}
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">同步狀態</label>
                                <div class="p-3 bg-white border border-gray-200 rounded-lg text-sm">
                                    ${record.firebaseId ? 
                                        '<span class="text-green-600 flex items-center gap-1">☁️ 已同步到雲端</span>' : 
                                        '<span class="text-orange-600 flex items-center gap-1">📱 僅存在本地</span>'
                                    }
                                    ${record.createdAt ? `<div class="text-xs text-gray-500 mt-1">建立: ${new Date(record.createdAt).toLocaleString()}</div>` : ''}
                                    ${record.updatedAt ? `<div class="text-xs text-gray-500">更新: ${new Date(record.updatedAt).toLocaleString()}</div>` : ''}
                                </div>
                            </div>
                            ${record.previousRecordId ? `
                                <div class="md:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">歷史記錄</label>
                                    <button onclick="jumpToPreviousRecord('${record.previousRecordId}')" 
                                            class="w-full px-3 py-2 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-700 hover:bg-blue-100 transition-colors flex items-center justify-center gap-2">
                                        📅 查看上次記錄
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');

            // 綁定複選框事件
            document.querySelectorAll('.record-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const id = e.target.dataset.id;
                    if (e.target.checked) {
                        selectedRecords.add(id);
                    } else {
                        selectedRecords.delete(id);
                    }
                    updateBulkActionsStatus();
                });
            });
        }

        function updateStats() {
            const pendingCount = filteredRecords.filter(r => r.status === 'pending').length;
            const completedCount = filteredRecords.filter(r => r.status === 'completed').length;
            
            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('completedCount').textContent = completedCount;
        }

        // ==================== 新增/編輯/刪除記錄 ====================
        function showAddRecordModal() {
            document.getElementById('addRecordModal').classList.remove('hidden');
            document.getElementById('addRecordForm').reset();
            document.getElementById('recordDate').value = new Date().toISOString().split('T')[0];
            updateTechnicianOptions();
        }

        function hideAddRecordModal() {
            document.getElementById('addRecordModal').classList.add('hidden');
        }

        function showSettingsModal() {
            document.getElementById('settingsModal').classList.remove('hidden');
            updateTechniciansListInSettings();
            updateFirebaseStatusInSettings();
        }

        function hideSettingsModal() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function updateFirebaseStatusInSettings() {
            const statusElement = document.getElementById('firebaseStatus');
            if (isFirebaseConnected && currentUser) {
                statusElement.textContent = `已連線 (用戶: ${currentUser.uid.substring(0, 8)}...)`;
                statusElement.className = 'text-sm text-green-600';
            } else if (isOnline) {
                statusElement.textContent = '連線中...';
                statusElement.className = 'text-sm text-yellow-600';
            } else {
                statusElement.textContent = '離線模式';
                statusElement.className = 'text-sm text-gray-600';
            }
        }

        async function handleAddRecord(e) {
            e.preventDefault();
            
            const formData = {
                id: Date.now().toString(),
                date: document.getElementById('recordDate').value,
                registrationData: document.getElementById('recordRegistration').value,
                model: document.getElementById('recordModel').value,
                sequence: document.getElementById('recordSequence').value,
                repairItem: document.getElementById('recordRepairItem').value,
                supplement: document.getElementById('recordSupplement').value,
                technician: document.getElementById('recordTechnician').value,
                status: document.getElementById('recordStatus').value,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            // 檢查一年內是否有相同品牌機型和序號的記錄
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            
            const existingRecord = records.find(r => 
                r.model === formData.model && 
                r.sequence === formData.sequence && 
                formData.model.trim() !== '' && 
                formData.sequence.trim() !== '' &&
                new Date(r.date) >= oneYearAgo
            );
            
            if (existingRecord) {
                const lastDate = existingRecord.date;
                formData.supplement = formData.supplement ? 
                    `${formData.supplement} (上次: ${lastDate})` : 
                    `上次: ${lastDate}`;
                formData.previousRecordId = existingRecord.id;
            }

            // 添加到本地
            records.unshift(formData);
            saveToLocalStorage();
            
            // 同步到 Firebase
            if (autoSyncEnabled && isFirebaseConnected) {
                const firebaseId = await addRecordToFirebase(formData);
                if (firebaseId) {
                    // 更新本地記錄的 Firebase ID
                    const localRecord = records.find(r => r.id === formData.id);
                    if (localRecord) {
                        localRecord.firebaseId = firebaseId;
                        saveToLocalStorage();
                    }
                }
            }
            
            filterRecords();
            hideAddRecordModal();
            showSuccessNotification('記錄新增成功！');
        }

        window.editRecord = async function(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;

            const newStatus = record.status === 'pending' ? 'completed' : 'pending';
            
            if (confirm(`將記錄狀態改為 ${newStatus === 'completed' ? '已完成' : '未修'}？`)) {
                record.status = newStatus;
                record.updatedAt = new Date().toISOString();
                saveToLocalStorage();
                
                // 同步到 Firebase
                if (autoSyncEnabled && isFirebaseConnected) {
                    await updateRecordInFirebase(record);
                }
                
                filterRecords();
                showSuccessNotification('狀態更新成功！');
            }
        }

        window.deleteRecord = async function(id) {
            if (!confirm('確定要刪除此記錄嗎？')) return;

            const record = records.find(r => r.id === id);
            records = records.filter(r => r.id !== id);
            saveToLocalStorage();
            selectedRecords.delete(id);
            
            // 從 Firebase 刪除
            if (autoSyncEnabled && isFirebaseConnected && record?.firebaseId) {
                await deleteRecordFromFirebase(record.firebaseId);
            }
            
            filterRecords();
            showSuccessNotification('記錄刪除成功！');
        }

        // ==================== 批量操作 ====================
        function toggleBulkActions() {
            showBulkActions = !showBulkActions;
            updateBulkActionsVisibility();
            renderRecords();
        }

        function updateBulkActionsVisibility() {
            const bulkBtn = document.getElementById('bulkActionsBtn');
            const bulkPanel = document.getElementById('bulkActionsPanel');
            
            if (filteredRecords.length > 0) {
                bulkBtn.classList.remove('hidden');
            } else {
                bulkBtn.classList.add('hidden');
                showBulkActions = false;
            }

            if (showBulkActions) {
                bulkBtn.className = 'flex items-center gap-2 px-4 py-2 rounded-lg transition-colors border bg-orange-600 text-white border-orange-600';
                bulkPanel.classList.remove('hidden');
            } else {
                bulkBtn.className = 'flex items-center gap-2 px-4 py-2 rounded-lg transition-colors border bg-white text-gray-700 border-gray-300 hover:bg-gray-50';
                bulkPanel.classList.add('hidden');
            }

            updateBulkActionsStatus();
        }

        function updateBulkActionsStatus() {
            const selectAllText = document.getElementById('selectAllText');
            const selectedCount = document.getElementById('selectedCount');
            const bulkButtons = document.getElementById('bulkButtons');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const headerCheckbox = document.getElementById('headerCheckbox');

            selectAllText.textContent = `全選 (${selectedRecords.size}/${filteredRecords.length})`;

            if (selectedRecords.size > 0) {
                selectedCount.textContent = `已選擇 ${selectedRecords.size} 筆記錄`;
                selectedCount.classList.remove('hidden');
                bulkButtons.classList.remove('hidden');
            } else {
                selectedCount.classList.add('hidden');
                bulkButtons.classList.add('hidden');
            }

            const allSelected = selectedRecords.size === filteredRecords.length && filteredRecords.length > 0;
            if (selectAllCheckbox) selectAllCheckbox.checked = allSelected;
            if (headerCheckbox) headerCheckbox.checked = allSelected;
        }

        function toggleSelectAll() {
            if (selectedRecords.size === filteredRecords.length) {
                selectedRecords.clear();
            } else {
                selectedRecords = new Set(filteredRecords.map(r => r.id));
            }
            renderRecords();
            updateBulkActionsStatus();
        }

        async function bulkUpdateStatus(newStatus) {
            if (selectedRecords.size === 0) return;

            if (!confirm(`確定要將選中的 ${selectedRecords.size} 筆記錄標記為 ${newStatus === 'completed' ? '已完成' : '未修'}？`)) return;

            const updatedRecords = [];
            selectedRecords.forEach(id => {
                const record = records.find(r => r.id === id);
                if (record) {
                    record.status = newStatus;
                    record.updatedAt = new Date().toISOString();
                    updatedRecords.push(record);
                }
            });

            saveToLocalStorage();
            
            // 批量同步到 Firebase
            if (autoSyncEnabled && isFirebaseConnected) {
                showSyncIndicator();
                for (const record of updatedRecords) {
                    await updateRecordInFirebase(record);
                }
                hideSyncIndicator();
            }
            
            filterRecords();
            showSuccessNotification(`已更新 ${selectedRecords.size} 筆記錄！`);

            selectedRecords.clear();
            showBulkActions = false;
            updateBulkActionsVisibility();
        }

        async function bulkDeleteRecords() {
            if (selectedRecords.size === 0) return;

            if (!confirm(`確定要刪除選中的 ${selectedRecords.size} 筆記錄嗎？`)) return;

            const recordsToDelete = records.filter(r => selectedRecords.has(r.id));
            records = records.filter(r => !selectedRecords.has(r.id));
            saveToLocalStorage();
            
            // 批量從 Firebase 刪除
            if (autoSyncEnabled && isFirebaseConnected) {
                showSyncIndicator();
                for (const record of recordsToDelete) {
                    if (record.firebaseId) {
                        await deleteRecordFromFirebase(record.firebaseId);
                    }
                }
                hideSyncIndicator();
            }
            
            filterRecords();
            showSuccessNotification(`已刪除 ${selectedRecords.size} 筆記錄！`);

            selectedRecords.clear();
            showBulkActions = false;
            updateBulkActionsVisibility();
        }

        // ==================== 匯出功能 ====================
        function exportToCSV() {
            const headers = ['日期', '登記資料', '品牌機型', '序號', '維修項目', '補充', '技術員', '狀態', '同步狀態'];
            const csvData = [
                headers.join(','),
                ...filteredRecords.map(record => [
                    record.date,
                    `"${record.registrationData}"`,
                    `"${record.model}"`,
                    record.sequence,
                    `"${record.repairItem}"`,
                    `"${record.supplement}"`,
                    record.technician,
                    record.status === 'completed' ? '已完成' : '未修',
                    record.firebaseId ? '已同步' : '本地'
                ].join(','))
            ].join('\n');

            downloadFile(csvData, `維修記錄_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob(['\uFEFF' + content], { type: mimeType + ';charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // ==================== 輔助函數 ====================
        function showSuccessNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification fixed top-20 right-4 bg-green-100 text-green-800 px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 z-50';
            notification.innerHTML = `
                <span>✓</span>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showErrorNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification fixed top-20 right-4 bg-red-100 text-red-800 px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 z-50';
            notification.innerHTML = `
                <span>⚠️</span>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        window.toggleRowExpansion = function(id) {
            const detailsRow = document.getElementById(`details-${id}`);
            const expandIcon = document.querySelector(`[data-id="${id}"].expand-icon`);
            
            if (detailsRow.classList.contains('hidden')) {
                document.querySelectorAll('[id^="details-"]').forEach(row => {
                    row.classList.add('hidden');
                });
                document.querySelectorAll('.expand-icon').forEach(icon => {
                    icon.textContent = '▶';
                });
                
                detailsRow.classList.remove('hidden');
                expandIcon.textContent = '▼';
            } else {
                detailsRow.classList.add('hidden');
                expandIcon.textContent = '▶';
            }
        }

        window.jumpToPreviousRecord = function(recordId) {
            const targetRecord = records.find(r => r.id === recordId);
            if (!targetRecord) return;

            const recordDate = new Date(targetRecord.date);
            const year = recordDate.getFullYear();
            const month = recordDate.getMonth() + 1;
            
            const currentDate = new Date();
            if (year === currentDate.getFullYear() && month === currentDate.getMonth() + 1) {
                switchView('current');
            } else {
                switchView('history');
                expandedYears.add(year);
                selectedPeriod = { year, month };
                buildHistorySelector();
                filterRecords();
            }
            
            setTimeout(() => {
                toggleRowExpansion(recordId);
                const element = document.getElementById(`details-${recordId}`);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 500);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ==================== 全域函數暴露 ====================
        window.addTechnician = addTechnician;
        window.editRecord = editRecord;
        window.deleteRecord = deleteRecord;
        window.toggleRowExpansion = toggleRowExpansion;
        window.jumpToPreviousRecord = jumpToPreviousRecord;
    </script>
</body>
</html>
